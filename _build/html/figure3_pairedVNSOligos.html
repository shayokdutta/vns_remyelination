

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Figure 3 Success-Paired VNS Enhances Oligodendrogenesis &#8212; VNS Myelin Manuscript Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'figure3_pairedVNSOligos';</script>
    <link rel="canonical" href="/vns_remyelination/figure3_pairedVNSOligos.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Figure 6 Neuropixels" href="figure6_Neuropixels.html" />
    <link rel="prev" title="Figure 1 VNS Enhances Oligodendrogenesis" href="figure1_VNSOligos.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">VNS Myelin Manuscript Book</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Figures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="figure1_VNSOligos.html">Figure 1: VNS Enhances Oligodendrogenesis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Figure 3: Success-Paired VNS Enhances Oligodendrogenesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="figure6_Neuropixels.html">Figure 6: Neuropixels</a></li>
<li class="toctree-l1"><a class="reference internal" href="figure7_longtermMyelin.html">Figure 7: Myelin-Dependent Long-Term Recovery</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/figure3_pairedVNSOligos.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Figure 3 Success-Paired VNS Enhances Oligodendrogenesis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-a-b-the-paired-stimulation-paradigm">Panels A &amp; B: The Paired Stimulation Paradigm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c">Panel C</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c-visualizing-individual-trajectories">Panel C: Visualizing Individual Trajectories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-d">Panel D</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e">Panel E</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f">Panel F</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-g">Panel G</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-h">Panel H</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="figure-3-success-paired-vns-enhances-oligodendrogenesis">
<h1>Figure 3 Success-Paired VNS Enhances Oligodendrogenesis<a class="headerlink" href="#figure-3-success-paired-vns-enhances-oligodendrogenesis" title="Permalink to this heading">#</a></h1>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">nelpy</span> <span class="k">as</span> <span class="nn">nel</span>
<span class="kn">import</span> <span class="nn">nelpy.plotting</span> <span class="k">as</span> <span class="nn">npl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">integrate</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="c1"># Manuscript Mode Setup (White Background / Black Text)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
          <span class="n">rc</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
               <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> 
               <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
               <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
               <span class="s1">&#39;xtick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;ytick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;xtick.major.size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ytick.major.size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
               <span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
               
               <span class="c1"># --- MANUSCRIPT MODE OVERRIDES ---</span>
               <span class="s1">&#39;figure.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># Transparent background</span>
               <span class="s1">&#39;axes.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>    <span class="c1"># Transparent axes</span>
               <span class="s1">&#39;savefig.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="c1"># Transparent on save</span>
               
               <span class="s1">&#39;text.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>       <span class="c1"># Black Text</span>
               <span class="s1">&#39;axes.labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>  <span class="c1"># Black Axis Labels</span>
               <span class="s1">&#39;xtick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>      <span class="c1"># Black Ticks</span>
               <span class="s1">&#39;ytick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>      <span class="c1"># Black Ticks</span>
               <span class="s1">&#39;axes.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>   <span class="c1"># Black Spines</span>
               
               <span class="s1">&#39;legend.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># Transparent Legend</span>
               <span class="s1">&#39;legend.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># No border on legend</span>
               <span class="s1">&#39;legend.labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span> <span class="c1"># Black Legend Text</span>
               <span class="p">}))</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Set the root logger&#39;s level to ERROR to suppress WARNING messages</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<span class="o">%</span><span class="k">matplotlib</span> inline 

<span class="n">df_fig3</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../2025-09-30Fig3.csv&quot;</span><span class="p">)</span>
<span class="n">df_fig3</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="panels-a-b-the-paired-stimulation-paradigm">
<h2>Panels A &amp; B: The Paired Stimulation Paradigm<a class="headerlink" href="#panels-a-b-the-paired-stimulation-paradigm" title="Permalink to this heading">#</a></h2>
<p><strong>Closed-loop neuromodulation.</strong> Unlike the open-loop stimulation used in Figure 1, this experiment tests the synergy between VNS and task-specific neural activity.</p>
<div class="alert alert-block alert-info">
    <b>Experimental Context: Closed-Loop Design</b><br>
    To test the hypothesis that VNS enhances plasticity when timed with specific motor outcomes:
    <ul>
        <li><b>The Paradigm (Fig. 3a):</b> We utilized a <b>closed-loop</b> protocol where VNS was triggered <i>only</i> upon successful skilled reaches. This ensures stimulation is temporally locked to the activation of successful motor circuits.</li>
        <li><b>The Controls (Fig. 3b):</b> "Motor Learning" mice performed the identical skilled reaching task but received no stimulation, serving as a rigorous active control to isolate the effect of VNS from the benefits of training alone.</li>
        <li><b>Timing:</b> The intervention occurred during the 7-day training block (Red Shading) immediately following the 3-day washout period.</li>
    </ul>
</div><p><img alt="Figure 3 Panel A" src="_images/mouseReachSuccessVNS.svg" /></p>
<p><img alt="Figure 3 Panel B" src="_images/panelB1.svg" /></p>
</section>
<section id="panel-c">
<h2>Panel C<a class="headerlink" href="#panel-c" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 3 Panel C" src="_images/panelC1.svg" /></p>
</section>
<section id="panel-c-visualizing-individual-trajectories">
<h2>Panel C: Visualizing Individual Trajectories<a class="headerlink" href="#panel-c-visualizing-individual-trajectories" title="Permalink to this heading">#</a></h2>
<p><strong>Tracking loss and recovery.</strong> The longitudinal traces (<i>Fig. 3c</i>) visualize the complete time-course of oligodendrocyte dynamics for every animal in the cohort.</p>
<div class="alert alert-block alert-success">
    <b>Model Validation: Consistent Injury Induction</b><br>
    The individual traces confirm the reliability of the demyelination model prior to the behavioral intervention:
    <ul>
        <li><b>Uniform Loss:</b> All animals, regardless of subsequent group assignment (Paired VNS vs. Motor Learning), exhibit a steep decline in oligodendrocyte numbers during the cuprizone phase (Days -21 to 0).</li>
        <li><b>Intervention Window:</b> The red shaded region highlights the specific "Learning Epoch" where the experimental variables (VNS vs. No VNS) were applied, setting the stage for the divergence in recovery trajectories observed in the later phases.</li>
    </ul>
</div></section>
<section id="panel-d">
<h2>Panel D<a class="headerlink" href="#panel-d" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 3 Panel D" src="_images/panelD1.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="c1"># Formatting function</span>
<span class="k">def</span> <span class="nf">pretty_print_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="s1">&#39;table table-striped table-hover&#39;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)))</span>

<span class="c1"># --- PANEL D DATA (Baseline Injury) ---</span>
<span class="n">data_d</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Comparison&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Paired VNS vs. Motor Learning&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;% Oligodendrocyte Loss (4 weeks post-cuprizone)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Student&#39;s t-test&quot;</span><span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.4572 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;No significant difference in injury severity&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_d</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_d</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_d</span><span class="p">,</span> <span class="s2">&quot;--- Panel D Statistics: Equivalent Baseline Injury ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel D Statistics: Equivalent Baseline Injury ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Comparison</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Paired VNS vs. Motor Learning</td>
      <td>% Oligodendrocyte Loss (4 weeks post-cuprizone)</td>
      <td>Student's t-test</td>
      <td>0.4572 (n.s.)</td>
      <td>No significant difference in injury severity</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Model Validation: Equal Starting Deficits</b><br>
    Before assessing the impact of the intervention, we confirmed that the injury burden was balanced across the cohort:
    <ul>
        <li><b>No Bias:</b> There was no significant difference in the extent of oligodendrocyte loss between the Paired VNS and Motor Learning groups (<i>p = 0.4572</i>).</li>
        <li><b>Implication:</b> This ensures that the enhanced recovery observed in subsequent panels is attributable to the specific synergy of VNS + Motor Learning, rather than an artifact of milder initial injury in the treated group.</li>
    </ul>
</div></section>
<section id="panel-e">
<h2>Panel E<a class="headerlink" href="#panel-e" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 3 Panel E" src="_images/panelE1.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- PANEL E DATA (ANCOVA Results) ---</span>
<span class="n">data_e</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Factor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Group Effect (Paired VNS vs Motor Learning)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cumulative Loss Effect&quot;</span><span class="p">,</span> <span class="s2">&quot;Interaction (Group × Loss)&quot;</span><span class="p">],</span>
    <span class="c1"># Replicate lists to match length</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Cumulative % New OLs (4 weeks)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ANCOVA (Unequal Slopes)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0191 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0216 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.4615 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Paired VNS significantly boosts regeneration&quot;</span><span class="p">,</span> <span class="s2">&quot;Regeneration scales with injury size&quot;</span><span class="p">,</span> <span class="s2">&quot;Parallel slopes (Uniform boost)&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_e</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_e</span><span class="p">,</span> <span class="s2">&quot;--- Panel E Statistics: Enhanced Regenerative Yield ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel E Statistics: Enhanced Regenerative Yield ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Factor</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Group Effect (Paired VNS vs Motor Learning)</td>
      <td>Cumulative % New OLs (4 weeks)</td>
      <td>ANCOVA (Unequal Slopes)</td>
      <td>0.0191 (*)</td>
      <td>Paired VNS significantly boosts regeneration</td>
    </tr>
    <tr>
      <td>Cumulative Loss Effect</td>
      <td>Cumulative % New OLs (4 weeks)</td>
      <td>ANCOVA (Unequal Slopes)</td>
      <td>0.0216 (*)</td>
      <td>Regeneration scales with injury size</td>
    </tr>
    <tr>
      <td>Interaction (Group × Loss)</td>
      <td>Cumulative % New OLs (4 weeks)</td>
      <td>ANCOVA (Unequal Slopes)</td>
      <td>0.4615 (n.s.)</td>
      <td>Parallel slopes (Uniform boost)</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: A Uniform Boost to Repair</b><br>
    The ANCOVA analysis reveals a distinct mechanism for Paired VNS compared to the open-loop stimulation seen in Figure 1:
    <ul>
        <li><b>Enhanced Yield (Group Effect):</b> Paired VNS significantly increased the total accumulation of new oligodendrocytes compared to Motor Learning alone (<i>p = 0.0191</i>).</li>
        <li><b>Homeostatic Scaling (Loss Effect):</b> As expected, the magnitude of repair scaled with the initial loss (<i>p = 0.0216</i>).</li>
        <li><b>Uniform Benefit (No Interaction):</b> Unlike Figure 1, the interaction was not significant (<i>p = 0.4615</i>). This suggests that Paired VNS provides a consistent, additive "boost" to regeneration across the entire spectrum of injury severity, shifting the recovery curve upward for all subjects.</li>
    </ul>
</div></section>
<section id="panel-f">
<h2>Panel F<a class="headerlink" href="#panel-f" title="Permalink to this heading">#</a></h2>
<div class="alert alert-block alert-info">
    <b>Methodological Note: Model Application</b><br>
    This analysis utilizes the <b>Hybrid Gompertz-GP model</b> validated in <b>Figure 1g</b>. By combining the biological constraints of an S-curve with the statistical flexibility of a Gaussian Process, this approach accurately captures the late-stage divergence (Days 20+) where the VNS trajectory continues to rise beyond the ceiling observed in the Motor Learning controls. Supplemental analysis of this was also done for the data in this figure and is provided below for reference but the actual result is at the bottom before the next panel.
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_animal_trajectories</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">behavior_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span>\
                             <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots individual animal trajectories from a dataframe.</span>
<span class="sd">    Automatically removes rows where &#39;Behavior&#39; (or other critical data) is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. Internal Data Cleaning</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Drop rows where critical info is missing</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">behavior_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Report cleanup results if necessary</span>
    <span class="n">dropped_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropped_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data Cleanup: Dropped </span><span class="si">{</span><span class="n">dropped_count</span><span class="si">}</span><span class="s2"> rows containing NaNs.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Dataframe is empty after cleaning. Check your column names or data.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 2. Calculate and Print N per Group</span>
    <span class="c1"># Group by behavior and count unique IDs</span>
    <span class="n">group_counts</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">behavior_col</span><span class="p">)[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample Sizes (N) for&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Clean up the group name for printing</span>
        <span class="n">clean_group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">clean_group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> animals&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
   
    <span class="c1"># Get unique animals from the CLEAN data only</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># 3. Setup Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># 4. Plot Loop</span>
    <span class="k">for</span> <span class="n">animal_id</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">animal_subset</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">animal_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">group_val</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">behavior_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">animal_subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">],</span> 
                 <span class="n">animal_subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> 
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
                 <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

    <span class="c1"># 5. Formatting</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days post-cuprizone&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">my_palette</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">}</span>
<span class="n">plot_animal_trajectories</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">my_palette</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data Cleanup: Dropped 7 rows containing NaNs.
------------------------------
Sample Sizes (N) for
  - learning: 10 animals
  - paired_stim.: 6 animals
------------------------------
</pre></div>
</div>
<img alt="_images/8b4ef8c8dd85dc6bee79e0019c7b4f7dcf42ab3e5cbe5278b3774800b03effce.png" src="_images/8b4ef8c8dd85dc6bee79e0019c7b4f7dcf42ab3e5cbe5278b3774800b03effce.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">calculate_aic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate AIC: n * log(RSS/n) + 2k&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rss</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rss</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. GOMPERTZ MODEL</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">gompertz</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gompertz growth model.</span>
<span class="sd">    a: Asymptote (theoretical maximum)</span>
<span class="sd">    b: Displacement (shifts curve along x-axis)</span>
<span class="sd">    c: Growth rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. FIT AND PLOT (Returns Individual Params)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">plot_gompertz_fits</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">behavior_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> <span class="n">plot_individual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                       <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a Gompertz curve to each animal individually and plots the SMOOTH modeled trajectory.</span>
<span class="sd">    Returns a DataFrame containing the fitted parameters for every animal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">behavior_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Dataframe is empty after cleaning.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> 
    
    <span class="n">fitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="c1"># --- SETUP PLOTTING ---</span>
    <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
        <span class="n">n_mice</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_mice</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="c1"># Handle single plot case</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard Aggregate Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">animal_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">animals</span><span class="p">):</span>
        <span class="n">animal_subset</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">animal_subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">: Not enough data points to fit.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="n">x_raw</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_raw</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_raw</span><span class="p">)</span>
        
        <span class="n">group_val</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">behavior_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y_raw</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gompertz</span><span class="p">,</span> <span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

            <span class="c1"># CALC R^2</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_raw</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
            <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_raw</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_raw</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_raw</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span> <span class="k">if</span> <span class="n">ss_tot</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="c1"># AIC (k=3 parameters for Gompertz)</span>
            <span class="n">aic_score</span> <span class="o">=</span> <span class="n">calculate_aic</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="n">ss_res</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
                <span class="n">ax_curr</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                
                <span class="c1"># Plot Raw Data</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="c1"># Plot Fit</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Add Text</span>
                <span class="n">stats_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$R^2$=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">AIC=</span><span class="si">{</span><span class="n">aic_score</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="n">stats_text</span><span class="p">,</span> 
                             <span class="n">transform</span><span class="o">=</span><span class="n">ax_curr</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> 
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
            
            <span class="n">fitted_params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal_id</span><span class="p">,</span>
                <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
                <span class="s1">&#39;Asymptote_a&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;Displacement_b&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;Rate_c&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit failed for animal </span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span> 
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days post-cuprizone&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Modeled OL replacement (%)&quot;</span><span class="p">)</span> 
        <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. STATS ON PARAMETERS (Inflection Point, Asymptote)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">analyze_gompertz_stats</span><span class="p">(</span><span class="n">df_results</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Inflection Point and performs T-tests on parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Inflection_Point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Displacement_b&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Rate_c&#39;</span><span class="p">]</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Statistics require exactly 2 groups. Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">if</span> <span class="n">target_greater_group</span> <span class="ow">and</span> <span class="n">target_greater_group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">group1_name</span> <span class="o">=</span> <span class="n">target_greater_group</span>
        <span class="n">group2_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">target_greater_group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group1_name</span><span class="p">,</span> <span class="n">group2_name</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">g1_data</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group1_name</span><span class="p">]</span>
    <span class="n">g2_data</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group2_name</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GOMPERTZ PARAMETER STATISTICS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hypothesis: Is </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">?&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Asymptote_a&#39;</span><span class="p">:</span> <span class="s1">&#39;Theoretical Max Replacement (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inflection_Point&#39;</span><span class="p">:</span> <span class="s1">&#39;Time of Peak Growth (Days)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Rate_c&#39;</span><span class="p">:</span> <span class="s1">&#39;Growth Rate Constant (c)&#39;</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vals1</span> <span class="o">=</span> <span class="n">g1_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        <span class="n">vals2</span> <span class="o">=</span> <span class="n">g2_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        
        <span class="n">t_2side</span><span class="p">,</span> <span class="n">p_2side</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
        <span class="n">t_1side</span><span class="p">,</span> <span class="n">p_1side</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_stars</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;n.s.&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vals2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">vals2</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Difference: </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vals2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Two-Sided: p=</span><span class="si">{</span><span class="n">p_2side</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">get_stars</span><span class="p">(</span><span class="n">p_2side</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  One-Sided: p=</span><span class="si">{</span><span class="n">p_1side</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">get_stars</span><span class="p">(</span><span class="n">p_1side</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 4. EVALUATE GOODNESS OF FIT (GROUP TEMPLATE RMSE)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">run_metric_permutation_test</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metric_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="n">g1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g2</span><span class="p">))</span>
    <span class="n">pooled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
    
    <span class="n">null_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">pooled</span><span class="p">[:</span><span class="n">n1</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">pooled</span><span class="p">[</span><span class="n">n1</span><span class="p">:]</span>
        <span class="n">null_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p2</span><span class="p">)))</span>
        
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_diffs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">obs_diff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate_gompertz_fit</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">df_params</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> 
                          <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates RMSE for 4 phases by comparing each animal&#39;s data against its GROUP TEMPLATE.</span>
<span class="sd">    Runs permutation tests to compare fit quality (RMSE) between groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. Fit Group Templates first</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting Group Templates (Pooled Data)...&quot;</span><span class="p">)</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">][</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
        
        <span class="n">x_all</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_all</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y_all</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gompertz</span><span class="p">,</span> <span class="n">x_all</span><span class="p">,</span> <span class="n">y_all</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not fit Group Template for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;Early&#39;</span><span class="p">,</span>   <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Middle&#39;</span><span class="p">,</span>  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;Late&#39;</span><span class="p">,</span>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">animal_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span>
        
        <span class="n">animal_data</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">df_raw</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">animal_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">continue</span>
            
        <span class="n">x_obs</span> <span class="o">=</span> <span class="n">animal_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_obs</span> <span class="o">=</span> <span class="n">animal_data</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># USE GROUP TEMPLATE PARAMETERS</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">templates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="n">row_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">id_col</span><span class="p">:</span> <span class="n">animal_id</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">condition</span><span class="p">(</span><span class="n">x_obs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_obs</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
            <span class="n">row_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;RMSE_</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmse</span>
            
        <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_metrics</span><span class="p">)</span>
        
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    
    <span class="c1"># --- REPORTING ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GOMPERTZ GROUP TEMPLATE EVALUATION&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparing deviation (RMSE) of individuals from the Group S-Curve&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
    
    <span class="n">metric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;RMSE&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Metric&#39;</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;Diff&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;P-Value&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_cols</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="n">run_metric_permutation_test</span><span class="p">(</span><span class="n">df_metrics</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">)</span>
            <span class="n">g1_mean</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">g2_mean</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">g1_mean</span> <span class="o">-</span> <span class="n">g2_mean</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s2">&quot;n.s.&quot;</span>
            <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">g1_mean</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">    | </span><span class="si">{</span><span class="n">g2_mean</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">    | </span><span class="si">{</span><span class="n">diff</span><span class="si">:</span><span class="s2">&gt;+6.2f</span><span class="si">}</span><span class="s2">   | </span><span class="si">{</span><span class="n">p_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INTERPRETATION: Significantly higher RMSE indicates the Group S-Curve fails to capture individual behavior.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_metrics</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># GOMPERTZ VISUALIZATION (Mean +/- SEM)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">plot_gompertz_mean_with_sem</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">df_params</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                                <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                                <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the MEAN Gompertz trajectory +/- SEM for each group.</span>
<span class="sd">    This effectively visualizes the &quot;Average Model&quot; vs. the &quot;Raw Data&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Setup Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># Define common grid for averaging</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get parameters for all animals in this group</span>
        <span class="n">group_params</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        
        <span class="c1"># 1. Generate curves for EVERY animal on the common grid</span>
        <span class="n">individual_curves</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group_params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Asymptote_a&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Displacement_b&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Rate_c&#39;</span><span class="p">]</span>
            
            <span class="c1"># Predict on grid</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">individual_curves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">individual_curves</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="c1"># 2. Calculate Mean and SEM across the population of curves</span>
        <span class="n">curve_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">individual_curves</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_curve</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">curve_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># 3. Plot the Model (Line + Ribbon)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Gompertz)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="c1"># 4. Plot the Raw Data</span>
        <span class="c1"># We need to map the group name back to the raw dataframe&#39;s group column</span>
        <span class="c1"># Assuming direct string match or stripping</span>
        <span class="n">subset_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">])</span>
        <span class="n">subset_raw</span> <span class="o">=</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">subset_raw</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">],</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subset_raw</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">current_max</span> <span class="o">=</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_max</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">current_max</span>

    <span class="c1"># Formatting</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gompertz Model: Mean Trajectory vs. Raw Data&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">df_results_fig3</span> <span class="o">=</span> <span class="n">plot_gompertz_fits</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">})</span>
<span class="n">plot_gompertz_mean_with_sem</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">df_results_fig3</span><span class="p">,</span> 
                            <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">})</span>
<span class="n">analyze_gompertz_stats</span><span class="p">(</span><span class="n">df_results_fig3</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="s2">&quot;paired_stim.&quot;</span><span class="p">)</span>
<span class="n">evaluate_gompertz_fit</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">df_results_fig3</span><span class="p">)</span>
<span class="n">df_results_fig3</span> <span class="o">=</span> <span class="n">plot_gompertz_fits</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">},</span><span class="n">plot_individual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/f839ea9d09c548e9d04ae47c08cc3c26bcaf56c7666072cea39dc726550aaf1b.png" src="_images/f839ea9d09c548e9d04ae47c08cc3c26bcaf56c7666072cea39dc726550aaf1b.png" />
<img alt="_images/ad6c4e1a2c55ed51c40abd32b8b5a39acd6282ef8a7aa384cdb3e81757f2405e.png" src="_images/ad6c4e1a2c55ed51c40abd32b8b5a39acd6282ef8a7aa384cdb3e81757f2405e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
GOMPERTZ PARAMETER STATISTICS
Hypothesis: Is paired_stim. &gt; learning?
================================================================================

Metric: Theoretical Max Replacement (%) [Asymptote_a]
  paired_stim.: 88.74 ± 9.33
  learning: 70.05 ± 4.76
  Difference: +18.69
----------------------------------------
  Two-Sided: p=0.0668 [n.s.]
  One-Sided: p=0.0334 [*]
................................................................................

Metric: Time of Peak Growth (Days) [Inflection_Point]
  paired_stim.: 13.08 ± 0.84
  learning: 10.98 ± 1.03
  Difference: +2.09
----------------------------------------
  Two-Sided: p=0.1814 [n.s.]
  One-Sided: p=0.0907 [n.s.]
................................................................................

Metric: Growth Rate Constant (c) [Rate_c]
  paired_stim.: 0.10 ± 0.01
  learning: 0.13 ± 0.03
  Difference: -0.03
----------------------------------------
  Two-Sided: p=0.4535 [n.s.]
  One-Sided: p=0.7733 [n.s.]
................................................................................
Fitting Group Templates (Pooled Data)...
==========================================================================================
GOMPERTZ GROUP TEMPLATE EVALUATION
Comparing deviation (RMSE) of individuals from the Group S-Curve
==========================================================================================
Metric             | learning     | paired_stim. | Diff     | P-Value 
------------------------------------------------------------------------------------------
RMSE_Overall       |      5.11    |      8.56    |  -3.45   | 0.0360 *
RMSE_Early         |      1.94    |      1.42    |  +0.52   | 0.1409 n.s.
RMSE_Middle        |      5.15    |      6.74    |  -1.59   | 0.4476 n.s.
RMSE_Late          |      5.99    |     11.62    |  -5.63   | 0.0240 *
------------------------------------------------------------------------------------------
INTERPRETATION: Significantly higher RMSE indicates the Group S-Curve fails to capture individual behavior.
</pre></div>
</div>
<img alt="_images/fb5b555359a44d6c81c6c7e6c66baefaed39fc60299d46315da7617d298f4836.png" src="_images/fb5b555359a44d6c81c6c7e6c66baefaed39fc60299d46315da7617d298f4836.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">analyze_non_parametric</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">smoothing_window_days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>\
                           <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span>\
                           <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs model-free validation:</span>
<span class="sd">    1. Calculates Max Observed Value &amp; AUC per animal.</span>
<span class="sd">    2. Runs Mann-Whitney U Tests (Two-Sided AND One-Sided).</span>
<span class="sd">    3. Plots CUSTOM LOESS curves (Physics-Constrained + Tunable Window).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        target_greater_group (str): The name of the group you hypothesize is LARGER.</span>
<span class="sd">                                    (e.g., &#39;VNS&#39;).</span>
<span class="sd">        smoothing_window_days (int): The size of the smoothing window in X-axis units (Days).</span>
<span class="sd">                                     Larger = smoother line (less detail).</span>
<span class="sd">                                     Smaller = wigglier line (more noise).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. CLEAN DATA</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># 2. CALCULATE SUMMARY METRICS (Per Animal)</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="k">continue</span> <span class="c1"># Need points to make a curve</span>
            
        <span class="n">x</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Metric A: Max Observed Value (The empirical ceiling)</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Metric B: AUC (Area Under Curve) - Normalized by duration</span>
        <span class="c1"># This represents &quot;Total Exposure&quot; to replacement over the experiment</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Trapz calculates area using trapezoids connecting the dots</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal</span><span class="p">,</span>
            <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="c1"># strip whitespace</span>
            <span class="s1">&#39;Max_Value&#39;</span><span class="p">:</span> <span class="n">max_val</span><span class="p">,</span>
            <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc</span>
        <span class="p">})</span>
        
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    
    <span class="c1"># 3. STATISTICAL REPORT</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NON-PARAMETRIC ROBUSTNESS CHECK (Mann-Whitney U)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_greater_group</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hypothesis Direction: Is </span><span class="si">{</span><span class="n">target_greater_group</span><span class="si">}</span><span class="s2"> &gt; Control?&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hypothesis: Two-Sided (Any Difference)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Need exactly 2 groups. Found: </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Identify Target vs Control</span>
    <span class="k">if</span> <span class="n">target_greater_group</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_greater_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: target_greater_group &#39;</span><span class="si">{</span><span class="n">target_greater_group</span><span class="si">}</span><span class="s2">&#39; not found. Available: </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">return</span>
        <span class="n">g1_name</span> <span class="o">=</span> <span class="n">target_greater_group</span>
        <span class="n">g2_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">target_greater_group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g1_name</span><span class="p">,</span> <span class="n">g2_name</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">g1</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g1_name</span><span class="p">]</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g2_name</span><span class="p">]</span>
    
    <span class="c1"># Helper for stars</span>
    <span class="k">def</span> <span class="nf">get_stars</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;n.s.&quot;</span>

    <span class="c1"># Test both metrics</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Max_Value&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]:</span>
        <span class="c1"># 1. Two-Sided Test</span>
        <span class="n">u_2</span><span class="p">,</span> <span class="n">p_2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
        
        <span class="c1"># 2. One-Sided Test (Greater)</span>
        <span class="n">u_1</span><span class="p">,</span> <span class="n">p_1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
        
        <span class="n">mean1</span><span class="p">,</span> <span class="n">se1</span> <span class="o">=</span> <span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span>
        <span class="n">mean2</span><span class="p">,</span> <span class="n">se2</span> <span class="o">=</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span>
        
        <span class="n">stars_2</span> <span class="o">=</span> <span class="n">get_stars</span><span class="p">(</span><span class="n">p_2</span><span class="p">)</span>
        <span class="n">stars_1</span> <span class="o">=</span> <span class="n">get_stars</span><span class="p">(</span><span class="n">p_1</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> (per animal)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">g1_name</span><span class="si">}</span><span class="s2"> (Target): </span><span class="si">{</span><span class="n">mean1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">se1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">g2_name</span><span class="si">}</span><span class="s2"> (Control): </span><span class="si">{</span><span class="n">mean2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">se2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Two-Sided Mann-Whitney: U=</span><span class="si">{</span><span class="n">u_2</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">p_2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">stars_2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  One-Sided Mann-Whitney: U=</span><span class="si">{</span><span class="n">u_1</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">p_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">stars_1</span><span class="si">}</span><span class="s2">] (Testing </span><span class="si">{</span><span class="n">g1_name</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">g2_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="c1"># 4. VISUALIZATION: LOESS PLOT</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># A. Plot Raw Data (Faint background dots)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> 
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># B. Plot Smooth Lines (Manual Calculation)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOESS SMOOTHING DETAILS (Target Window: ~</span><span class="si">{</span><span class="n">smoothing_window_days</span><span class="si">}</span><span class="s2"> Days)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">continue</span>
            
        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_vals</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># --- DYNAMIC FRACTION CALCULATION ---</span>
        <span class="c1"># Convert &quot;Days&quot; into the &quot;Fraction&quot; that statsmodels requires</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">smoothing_window_days</span> <span class="o">/</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Keep frac within safe bounds (0.05 to 1.0)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frac</span><span class="p">))</span>
        
        <span class="c1"># --- MANUAL LOESS CALCULATION ---</span>
        <span class="c1"># Calculate the smooth curve</span>
        <span class="n">lowess</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">lowess</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">x_vals</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
        <span class="n">lowess_x</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lowess_y</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># --- THE FIX: CLAMP NEGATIVE VALUES ---</span>
        <span class="c1"># Force the curve to respect biology (cannot have negative cells)</span>
        <span class="n">lowess_y_clamped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lowess_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Plot the result</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lowess_x</span><span class="p">,</span> <span class="n">lowess_y_clamped</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group &#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&#39;: Duration=</span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">d -&gt; using frac=</span><span class="si">{</span><span class="n">frac</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model-Free Trend (LOESS)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL Replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_non_parametric</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">},</span><span class="n">target_greater_group</span> <span class="o">=</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">,</span><span class="n">smoothing_window_days</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
NON-PARAMETRIC ROBUSTNESS CHECK (Mann-Whitney U)
Hypothesis Direction: Is paired_stim. &gt; Control?
================================================================================

Metric: Max_Value (per animal)
  paired_stim. (Target): 78.75 ± 8.89 (n=6)
  learning (Control): 65.14 ± 3.96 (n=10)
----------------------------------------
  Two-Sided Mann-Whitney: U=41.0, p=0.2635 [n.s.]
  One-Sided Mann-Whitney: U=41.0, p=0.1317 [n.s.] (Testing paired_stim. &gt; learning)
................................................................................

Metric: AUC (per animal)
  paired_stim. (Target): 31.24 ± 5.68 (n=6)
  learning (Control): 25.95 ± 2.08 (n=10)
----------------------------------------
  Two-Sided Mann-Whitney: U=33.0, p=0.7925 [n.s.]
  One-Sided Mann-Whitney: U=33.0, p=0.3962 [n.s.] (Testing paired_stim. &gt; learning)
................................................................................

============================================================
LOESS SMOOTHING DETAILS (Target Window: ~21 Days)
============================================================
Group &#39;learning&#39;: Duration=77.0d -&gt; using frac=0.27
Group &#39;paired_stim.&#39;: Duration=70.0d -&gt; using frac=0.30
</pre></div>
</div>
<img alt="_images/230e402c205ba14c82c3baeb867e6e9b694969b23bb44ff910d0e8211660d0fa.png" src="_images/230e402c205ba14c82c3baeb867e6e9b694969b23bb44ff910d0e8211660d0fa.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. HELPER: GENERATE HIERARCHICAL CURVES (PRE-FIT)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_individual_gp_curves</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a GP to each animal individually and returns the predicted curves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="n">curves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Kernel: RBF for shape + WhiteKernel for individual animal noise</span>
    <span class="n">base_kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span> <span class="o">+</span> \
                  <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">noise_level_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="c1"># Get Group</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Fit GP</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">base_kernel</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Predict on common grid</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># STRICT MASKING (No Extrapolation)</span>
        <span class="n">min_d</span><span class="p">,</span> <span class="n">max_d</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">y_pred</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y_pred</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">curves</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
        
    <span class="k">return</span> <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. STATISTICAL ENGINE (HIERARCHICAL LIKELIHOOD)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_hierarchical_D</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">group_assignments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates D = 2 * (LL_Separate - LL_Shared) based on curve distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. SHARED MODEL (Grand Mean &amp; Variance)</span>
    <span class="n">mu_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span> 
    
    <span class="c1"># Log-Likelihood (Shared)</span>
    <span class="n">resid_sq_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">curve_matrix</span> <span class="o">-</span> <span class="n">mu_all</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">ll_terms_all</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_all</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_all</span><span class="p">))</span>
    <span class="n">LL_shared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ll_terms_all</span><span class="p">)</span>

    <span class="c1"># 2. SEPARATE MODELS</span>
    <span class="n">LL_separate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">curve_matrix</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        
        <span class="c1"># Group Parameters</span>
        <span class="n">mu_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
        
        <span class="c1"># Group Likelihood</span>
        <span class="n">resid_sq_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_matrix</span> <span class="o">-</span> <span class="n">mu_g</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">ll_terms_g</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_g</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_g</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_g</span><span class="p">))</span>
        <span class="n">LL_separate</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ll_terms_g</span><span class="p">)</span>
        
    <span class="c1"># 3. STATISTIC</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">LL_separate</span> <span class="o">-</span> <span class="n">LL_shared</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_rolling_hierarchical_permutation</span><span class="p">(</span><span class="n">curve_dict</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> 
                                         <span class="n">start_day</span><span class="p">,</span> <span class="n">end_day</span><span class="p">,</span> 
                                         <span class="n">window_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> 
                                         <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Slides a window across the curves and runs stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curve_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">full_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curve_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span> 
    <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>
    
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_start</span> <span class="o">=</span> <span class="n">start_day</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running Rolling Stats (Window=</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">d, Step=</span><span class="si">{</span><span class="n">step_size</span><span class="si">}</span><span class="s2">d, N=</span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="n">curr_start</span> <span class="o">+</span> <span class="n">window_size</span> <span class="o">&lt;=</span> <span class="n">end_day</span><span class="p">:</span>
        <span class="n">curr_end</span> <span class="o">=</span> <span class="n">curr_start</span> <span class="o">+</span> <span class="n">window_size</span>
        
        <span class="c1"># Mask curves for this window</span>
        <span class="n">window_curves</span> <span class="o">=</span> <span class="n">full_curves</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">curr_start</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">curr_end</span><span class="p">)</span>
        <span class="n">window_curves</span><span class="p">[:,</span> <span class="n">mask_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate Observed D</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">D_obs</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">window_curves</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">curr_start</span> <span class="o">+=</span> <span class="n">step_size</span>
            <span class="k">continue</span>

        <span class="c1"># Permutation Loop</span>
        <span class="n">null_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">):</span>
            <span class="n">shuffled_labels</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">D_null</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">window_curves</span><span class="p">,</span> <span class="n">shuffled_labels</span><span class="p">)</span>
                <span class="n">null_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_null</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">null_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">null_scores</span> <span class="o">&gt;=</span> <span class="n">D_obs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">p_val</span><span class="p">))</span>
            
        <span class="n">curr_start</span> <span class="o">+=</span> <span class="n">step_size</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rolling Stats Complete.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">merge_significant_windows</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges overlapping or continuous windows into single blocks.</span>
<span class="sd">    Tracks the MINIMUM p-value (peak significance) for that block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Sort by start time</span>
    <span class="n">windows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="n">merged</span>
    
    <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)):</span>
        <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span> <span class="n">next_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Check overlap (next start &lt;= curr end)</span>
        <span class="c1"># We allow a small epsilon for float precision</span>
        <span class="k">if</span> <span class="n">next_start</span> <span class="o">&lt;=</span> <span class="n">curr_end</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span> 
            <span class="n">curr_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_end</span><span class="p">,</span> <span class="n">next_end</span><span class="p">)</span>
            <span class="n">curr_min_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_min_p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">)</span> <span class="c1"># Keep strongest significance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span><span class="p">))</span>
            <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span> <span class="o">=</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span> <span class="n">next_p</span>
            
    <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. MAIN WRAPPER</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">analyze_gaussian_process</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                             <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
                             <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                             <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">,</span>
                             <span class="n">constant_sem</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
    
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="c1"># Grid Setup</span>
    <span class="n">global_min</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">global_max</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># --- 1. FIT INDIVIDUALS ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STEP 1: Generating Individual GP Curves...&quot;</span><span class="p">)</span>
    <span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span> <span class="o">=</span> <span class="n">get_individual_gp_curves</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    
    <span class="c1"># --- 2. ROLLING STATISTICS ---</span>
    <span class="n">merged_sig_windows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STEP 2: Running Rolling Hierarchical Permutation...&quot;</span><span class="p">)</span>
        <span class="n">stats_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">global_min</span><span class="p">)</span> 
        <span class="n">stats_end</span> <span class="o">=</span> <span class="n">global_max</span>
        
        <span class="n">raw_windows</span> <span class="o">=</span> <span class="n">run_rolling_hierarchical_permutation</span><span class="p">(</span><span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span>
                                                           <span class="n">start_day</span><span class="o">=</span><span class="n">stats_start</span><span class="p">,</span> 
                                                           <span class="n">end_day</span><span class="o">=</span><span class="n">stats_end</span><span class="p">,</span>
                                                           <span class="n">window_size</span><span class="o">=</span><span class="n">stats_window_size</span><span class="p">,</span>
                                                           <span class="n">step_size</span><span class="o">=</span><span class="n">stats_step_size</span><span class="p">,</span>
                                                           <span class="n">n_permutations</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">,</span>
                                                           <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        <span class="c1"># Filter for raw significance first</span>
        <span class="n">sig_windows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw_windows</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span>
        
        <span class="c1"># Merge overlapping windows</span>
        <span class="n">merged_sig_windows</span> <span class="o">=</span> <span class="n">merge_significant_windows</span><span class="p">(</span><span class="n">sig_windows</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="c1"># --- 3. PLOTTING ---</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_ids</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="n">group_curve_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">])</span>
        
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group_curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_variable</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">group_curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">constant_sem</span><span class="p">:</span>
                <span class="n">avg_sem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sem_variable</span><span class="p">)</span>
                <span class="n">sem_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">mean_curve</span><span class="p">,</span> <span class="n">avg_sem</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sem_plot</span> <span class="o">=</span> <span class="n">sem_variable</span>
                
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_plot</span><span class="p">,</span> <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_plot</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        <span class="c1"># plt.scatter(sub[x_col], sub[y_col], color=color, alpha=0.4, s=20)</span>
        
        <span class="c1"># Track Max Y</span>
        <span class="n">curr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curr_max</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">curr_max</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># --- 4. PLOT MERGED BARS ---</span>
    <span class="k">if</span> <span class="n">merged_sig_windows</span><span class="p">:</span>
        <span class="n">base_y</span> <span class="o">=</span> <span class="mi">100</span><span class="c1">#max_y * 1.05</span>
        
        <span class="k">for</span> <span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span><span class="p">,</span> <span class="n">min_p</span> <span class="ow">in</span> <span class="n">merged_sig_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">elif</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">elif</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_start</span> <span class="o">+</span> <span class="n">w_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="c1"># Draw line</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span><span class="p">],</span> <span class="p">[</span><span class="n">base_y</span><span class="p">,</span> <span class="n">base_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Add star</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">base_y</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">85</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="c1"># plt.title(&quot;Hierarchical GP with Rolling Significance&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL</span><span class="se">\n</span><span class="s2">replacement (%)&quot;</span><span class="p">)</span>
    <span class="c1"># plt.legend(loc=&#39;upper left&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">group_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">palette</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># Sort to ensure consistent filename order</span>
    <span class="n">camel_case_groups</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">group_names</span><span class="p">])</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;totalOLReplacement&quot;</span> <span class="o">+</span> <span class="n">camel_case_groups</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
    
    <span class="c1"># plt.savefig(filename,bbox_inches=&#39;tight&#39;,format=&#39;pdf&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_gaussian_process</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">},</span>\
                         <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
STEP 1: Generating Individual GP Curves...
STEP 2: Running Rolling Hierarchical Permutation...
Running Rolling Stats (Window=5d, Step=2d, N=1000)...

Rolling Stats Complete.
============================================================
</pre></div>
</div>
<img alt="_images/af0b0577480f6ea9c2dd63cd35416a0d18b3be14529eb3bdf8f6dec7b6d0424f.png" src="_images/af0b0577480f6ea9c2dd63cd35416a0d18b3be14529eb3bdf8f6dec7b6d0424f.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. THE HYBRID MODEL CLASS</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">GompertzGP_Uncapped</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span> <span class="o">+</span> 
                   <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">noise_level_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_gompertz_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="o">-</span><span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_y</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span> 
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="p">,</span> 
                                                <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">ideal_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">)</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ideal_trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">correction</span>

    <span class="k">def</span> <span class="nf">get_biological_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span>
        <span class="n">asymptote</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">inflection_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inflection_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">asymptote</span><span class="p">,</span> <span class="n">inflection_time</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. DATA EXTRACTION</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_hybrid_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">curves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting Hybrid Models for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span><span class="si">}</span><span class="s2"> mice...&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span> 
        
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">GompertzGP_Uncapped</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">curves</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
        
        <span class="n">asymp</span><span class="p">,</span> <span class="n">inflect</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_biological_parameters</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
            <span class="s1">&#39;Asymptote&#39;</span><span class="p">:</span> <span class="n">asymp</span><span class="p">,</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">:</span> <span class="n">inflect</span>
        <span class="p">})</span>
        
    <span class="k">return</span> <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. STATS ENGINES</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_hierarchical_D</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">group_assignments</span><span class="p">):</span>
    <span class="n">mu_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span> 
    <span class="n">resid_sq_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">curve_matrix</span> <span class="o">-</span> <span class="n">mu_all</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">LL_shared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_all</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_all</span><span class="p">)))</span>

    <span class="n">LL_separate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">curve_matrix</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">mu_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
        <span class="n">resid_sq_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_matrix</span> <span class="o">-</span> <span class="n">mu_g</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">LL_separate</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_g</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_g</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_g</span><span class="p">)))</span>
        
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">LL_separate</span> <span class="o">-</span> <span class="n">LL_shared</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_rolling_stats</span><span class="p">(</span><span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">start_day</span><span class="p">,</span> <span class="n">end_day</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">n_perm</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curves_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">full_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span> 
    <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">labels_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">curr</span> <span class="o">=</span> <span class="n">start_day</span>
    <span class="k">while</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">window</span> <span class="o">&lt;=</span> <span class="n">end_day</span><span class="p">:</span>
        <span class="n">w_curves</span> <span class="o">=</span> <span class="n">full_curves</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">curr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">window</span><span class="p">)</span>
        <span class="n">w_curves</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">D_obs</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">w_curves</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>
            <span class="n">nulls</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">w_curves</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">)]</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nulls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">D_obs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr</span><span class="p">,</span> <span class="n">curr</span><span class="o">+</span><span class="n">window</span><span class="p">,</span> <span class="n">p_val</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">curr</span> <span class="o">+=</span> <span class="n">step</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">merge_significant_windows</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="n">windows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">next_s</span><span class="p">,</span> <span class="n">next_e</span><span class="p">,</span> <span class="n">next_p</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">next_s</span> <span class="o">&lt;=</span> <span class="n">curr_e</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">curr_e</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_e</span><span class="p">,</span> <span class="n">next_e</span><span class="p">)</span>
            <span class="n">curr_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span><span class="p">))</span>
            <span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span> <span class="o">=</span> <span class="n">next_s</span><span class="p">,</span> <span class="n">next_e</span><span class="p">,</span> <span class="n">next_p</span>
    <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="k">def</span> <span class="nf">permutation_test_params_median</span><span class="p">(</span><span class="n">df_params</span><span class="p">,</span> <span class="n">metric_col</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vals1</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">g1</span><span class="p">][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals2</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">g2</span><span class="p">][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span> <span class="o">=</span> <span class="n">vals1</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals1</span><span class="p">)],</span> <span class="n">vals2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals2</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;Insufficient Data&quot;</span>
    
    <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">null_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">):</span>
        <span class="n">shuffled</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
        <span class="n">null_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">shuffled</span><span class="p">[:</span><span class="n">n1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">shuffled</span><span class="p">[</span><span class="n">n1</span><span class="p">:]))</span>
        
    <span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">null_diffs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs_diff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Comparison&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">metric_col</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">iqr</span><span class="p">(</span><span class="n">vals1</span><span class="p">),</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">iqr</span><span class="p">(</span><span class="n">vals2</span><span class="p">),</span>
        <span class="s1">&#39;P_Value&#39;</span><span class="p">:</span> <span class="n">p_value</span>
    <span class="p">}</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 4. MAIN FUNCTION</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">analyze_hybrid_process</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                           <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                           <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                           <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">,</span>
                           <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data_min</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">projection_max</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># &lt;--- CUT X-AXIS AT 75 DAYS</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">df_params</span> <span class="o">=</span> <span class="n">get_hybrid_data</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">HYBRID PARAMETER STATISTICS (Permutation of MEDIANS, N=10000)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">asymp_p_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inflect_medians</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Asymptote&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test_params_median</span><span class="p">(</span><span class="n">df_params</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Comparison&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; vs &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g1</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: Median=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.2f</span><span class="si">}</span><span class="s2"> (IQR=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g2</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: Median=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.2f</span><span class="si">}</span><span class="s2"> (IQR=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-Value        : </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Asymptote&#39;</span><span class="p">:</span> <span class="n">asymp_p_val</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">:</span>
                <span class="n">inflect_medians</span><span class="p">[</span><span class="n">g1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span>
                <span class="n">inflect_medians</span><span class="p">[</span><span class="n">g2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SLIDING WINDOW STATISTICS (Trajectory)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">raw_wins</span> <span class="o">=</span> <span class="n">run_rolling_stats</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span><span class="p">,</span> 
                                 <span class="n">stats_window_size</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="p">,</span> <span class="n">n_permutations</span><span class="p">)</span>
    <span class="n">sig_wins</span> <span class="o">=</span> <span class="n">merge_significant_windows</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">raw_wins</span> <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">sig_wins</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant Windows found: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sig_wins</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No significant windows found.&quot;</span><span class="p">)</span>

    <span class="c1"># --- PLOTTING ---</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">max_y_plotted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">group_means</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">g_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g_ids</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">g_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">g_ids</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">g_curves</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_curve</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">g_curves</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_curve</span><span class="p">,</span> <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_y_plotted</span><span class="p">:</span> 
            <span class="n">max_y_plotted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">)</span>
        <span class="n">group_means</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mean_curve</span><span class="p">)</span>

    <span class="c1"># Sliding Window Significance Bars</span>
    <span class="k">if</span> <span class="n">sig_wins</span><span class="p">:</span>
        <span class="n">bar_height</span> <span class="o">=</span> <span class="n">max_y_plotted</span> <span class="o">*</span> <span class="mf">1.05</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig_wins</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="s2">&quot;**&quot;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="p">[</span><span class="n">bar_height</span><span class="p">,</span> <span class="n">bar_height</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">bar_height</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># --- NEW: Asymptote Significance Bracket ---</span>
    <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1"># Find end-point Y-values for the bracket</span>
        <span class="n">y_end_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_name</span> <span class="ow">in</span> <span class="n">group_means</span><span class="p">:</span>
            <span class="c1"># Get the Y-value at the last timepoint of the projection</span>
            <span class="n">y_end</span> <span class="o">=</span> <span class="n">group_means</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">y_end_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_end</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span>
            <span class="n">y_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span>
            <span class="n">x_pos</span> <span class="o">=</span> <span class="n">projection_max</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># Place bracket slightly to the right</span>
            
            <span class="c1"># Draw the bracket</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">],</span> <span class="p">[</span><span class="n">y_low</span><span class="p">,</span> <span class="n">y_high</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y_low</span><span class="p">,</span> <span class="n">y_low</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y_high</span><span class="p">,</span> <span class="n">y_high</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            
            <span class="c1"># Add the star</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span> <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="s2">&quot;**&quot;</span> <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">y_low</span> <span class="o">+</span> <span class="n">y_high</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> 
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="c1"># --- NEW: Inflection Point Markers ---</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">median_inflect</span> <span class="ow">in</span> <span class="n">inflect_medians</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># Find Y-value on the mean curve at the inflection point</span>
        <span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span> <span class="o">=</span> <span class="n">group_means</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_vec</span> <span class="o">-</span> <span class="n">median_inflect</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">y_inflect</span> <span class="o">=</span> <span class="n">y_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="c1"># Plot dashed line and marker</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">median_inflect</span><span class="p">,</span> <span class="n">median_inflect</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">y_inflect</span><span class="p">],</span> 
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">median_inflect</span><span class="p">,</span> <span class="n">y_inflect</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># --- REMOVED: Data End Line ---</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Add space for the bracket</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL</span><span class="se">\n</span><span class="s2">replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_hybrid_process</span><span class="p">(</span><span class="n">df_fig3</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;paired_stim.&#39;</span><span class="p">:</span> <span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="s1">&#39;learning&#39;</span><span class="p">:</span> <span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">},</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting Hybrid Models for 16 mice...

================================================================================
HYBRID PARAMETER STATISTICS (Permutation of MEDIANS, N=10000)
================================================================================

Metric: Asymptote
learning       : Median= 71.56 (IQR=15.06)
paired_stim.   : Median= 91.55 (IQR=31.41)
P-Value        : 0.04300 *

Metric: Inflection_Day
learning       : Median= 11.27 (IQR=3.52)
paired_stim.   : Median= 13.11 (IQR=2.78)
P-Value        : 0.27317 

================================================================================
SLIDING WINDOW STATISTICS (Trajectory)
================================================================================
Significant Windows found: [&#39;20.0-49.0&#39;]
</pre></div>
</div>
<img alt="_images/66d28511d38af2b4b5f40f199930aa393e618682857adefe53ff7325390e7e2e.png" src="_images/66d28511d38af2b4b5f40f199930aa393e618682857adefe53ff7325390e7e2e.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: Paired VNS Enhances the Magnitude of Myelin Regeneration</b><br>
    Applying the Hybrid Gompertz-GP framework reveals that Paired VNS fundamentally alters the extent of the adaptive myelination response during recovery:
    <ul>
        <li><b>Increased Capacity (Asymptote):</b> Paired VNS significantly elevated the theoretical limit of oligodendrocyte generation (Median: <b>91.55%</b>) compared to Motor Learning alone (Median: <b>71.56%</b>; <i>p = 0.043</i>). This indicates that VNS drives a more complete restoration of the oligodendrocyte pool.</li>
        <li><b>Extended Plasticity Window:</b> The rolling significance test identifies a critical window of divergence between <b>Day 20 and Day 49</b>. While the control group begins to plateau, the VNS group sustains active oligodendrocyte generation, effectively extending the period of repair.</li>
        <li><b>Preserved Kinetics:</b> The timing of the peak response (Inflection Day) was unchanged (<i>p = 0.27</i>), confirming that VNS amplifies the *scale* of regeneration without altering the fundamental timing of the cellular response.</li>
    </ul>
</div></section>
<section id="panel-g">
<h2>Panel G<a class="headerlink" href="#panel-g" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 3 Panel G" src="_images/panelG.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Formatting function for clear headers</span>
<span class="k">def</span> <span class="nf">pretty_print_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># Apply styling to highlight significant p-values</span>
    <span class="k">def</span> <span class="nf">highlight_sig</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s1">&#39;*&#39;</span> <span class="ow">in</span> <span class="n">val</span> <span class="ow">or</span> <span class="s1">&#39;&lt;&#39;</span> <span class="ow">in</span> <span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;background-color: #d4edda; font-weight: bold;&#39;</span> <span class="c1"># Light green for sig</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="n">styled_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">highlight_sig</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;P-Value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">set_table_styles</span><span class="p">(</span>
        <span class="p">[{</span><span class="s1">&#39;selector&#39;</span><span class="p">:</span> <span class="s1">&#39;th&#39;</span><span class="p">,</span> <span class="s1">&#39;props&#39;</span><span class="p">:</span> <span class="p">[(</span><span class="s1">&#39;text-align&#39;</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">)]}]</span>
    <span class="p">)</span><span class="o">.</span><span class="n">hide</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
    
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">styled_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="s1">&#39;table table-striped table-hover&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)))</span>

<span class="c1"># --- TABLE 1: MAIN MODEL EFFECTS (Linear Regression) ---</span>
<span class="n">data_main</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Factor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Group Effect (Paired VNS vs ML)&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Effect (Week)&quot;</span><span class="p">,</span> <span class="s2">&quot;Interaction (Group × Week)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;OL Replacement Rate (Post-Stimulation)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Least Squares Regression Model&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0026 (**)&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt; 0.0001 (****)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.4459 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Paired VNS accelerates repair&quot;</span><span class="p">,</span> <span class="s2">&quot;Rate slows over time&quot;</span><span class="p">,</span> <span class="s2">&quot;Parallel advantage (No convergence)&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_main</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_main</span><span class="p">)</span>

<span class="c1"># --- TABLE 2: TUKEY&#39;S HSD POST-HOC (Week-by-Week) ---</span>
<span class="n">data_posthoc</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Comparison&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Learning W1 vs Learning W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W1 vs Learning W3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Learning W1 vs Paired VNS W1&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W1 vs Paired VNS W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W1 vs Paired VNS W3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Learning W2 vs Learning W3&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W2 vs Paired VNS W1&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W2 vs Paired VNS W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W2 vs Paired VNS W3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Learning W3 vs Paired VNS W1&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W3 vs Paired VNS W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Learning W3 vs Paired VNS W3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Paired VNS W1 vs Paired VNS W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Paired VNS W1 vs Paired VNS W3&quot;</span><span class="p">,</span> <span class="s2">&quot;Paired VNS W2 vs Paired VNS W3&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;0.1334 (n.s.)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0010 (**)&quot;</span><span class="p">,</span> 
        <span class="s2">&quot;0.0659 (Trend)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.9861 (n.s.)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.1011 (n.s.)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;0.4487 (n.s.)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0001 (***)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.6313 (n.s.)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.9969 (n.s.)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&lt; 0.0001 (****)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0330 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.8674 (n.s.)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;0.0334 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0002 (***)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.4687 (n.s.)&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;Inference&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;Stable baseline&quot;</span><span class="p">,</span> <span class="s2">&quot;Significant decline over time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;VNS trending higher immediately&quot;</span><span class="p">,</span> <span class="s2">&quot;VNS W2 returns to Learning W1 levels&quot;</span><span class="p">,</span> <span class="s2">&quot;VNS W3 returns to Learning W1 levels&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Stable low rate&quot;</span><span class="p">,</span> <span class="s2">&quot;VNS W1 far exceeds Learning W2&quot;</span><span class="p">,</span> <span class="s2">&quot;Rates similar&quot;</span><span class="p">,</span> <span class="s2">&quot;Rates similar&quot;</span><span class="p">,</span>
        <span class="s2">&quot;VNS W1 far exceeds Learning W3&quot;</span><span class="p">,</span> <span class="s2">&quot;VNS W2 exceeds Learning W3&quot;</span><span class="p">,</span> <span class="s2">&quot;Rates similar at end&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Significant drop after VNS week&quot;</span><span class="p">,</span> <span class="s2">&quot;Significant drop after VNS week&quot;</span><span class="p">,</span> <span class="s2">&quot;Stable post-stimulation&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="n">df_posthoc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_posthoc</span><span class="p">)</span>

<span class="c1"># Display both tables</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_main</span><span class="p">,</span> <span class="s2">&quot;--- Panel G1: Main Model Effects ---&quot;</span><span class="p">)</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_posthoc</span><span class="p">,</span> <span class="s2">&quot;--- Panel G2: Granular Week-by-Week Comparisons (Tukey&#39;s HSD) ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel G1: Main Model Effects ---
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
#T_4b8a5 th {
  text-align: left;
}
#T_4b8a5_row0_col3, #T_4b8a5_row1_col3 {
  background-color: #d4edda;
  font-weight: bold;
}
</style>
<table id="T_4b8a5">
  <thead>
    <tr>
      <th id="T_4b8a5_level0_col0" class="col_heading level0 col0" >Factor</th>
      <th id="T_4b8a5_level0_col1" class="col_heading level0 col1" >Metric</th>
      <th id="T_4b8a5_level0_col2" class="col_heading level0 col2" >Test</th>
      <th id="T_4b8a5_level0_col3" class="col_heading level0 col3" >P-Value</th>
      <th id="T_4b8a5_level0_col4" class="col_heading level0 col4" >Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_4b8a5_row0_col0" class="data row0 col0" >Group Effect (Paired VNS vs ML)</td>
      <td id="T_4b8a5_row0_col1" class="data row0 col1" >OL Replacement Rate (Post-Stimulation)</td>
      <td id="T_4b8a5_row0_col2" class="data row0 col2" >Least Squares Regression Model</td>
      <td id="T_4b8a5_row0_col3" class="data row0 col3" >0.0026 (**)</td>
      <td id="T_4b8a5_row0_col4" class="data row0 col4" >Paired VNS accelerates repair</td>
    </tr>
    <tr>
      <td id="T_4b8a5_row1_col0" class="data row1 col0" >Time Effect (Week)</td>
      <td id="T_4b8a5_row1_col1" class="data row1 col1" >OL Replacement Rate (Post-Stimulation)</td>
      <td id="T_4b8a5_row1_col2" class="data row1 col2" >Least Squares Regression Model</td>
      <td id="T_4b8a5_row1_col3" class="data row1 col3" >< 0.0001 (****)</td>
      <td id="T_4b8a5_row1_col4" class="data row1 col4" >Rate slows over time</td>
    </tr>
    <tr>
      <td id="T_4b8a5_row2_col0" class="data row2 col0" >Interaction (Group × Week)</td>
      <td id="T_4b8a5_row2_col1" class="data row2 col1" >OL Replacement Rate (Post-Stimulation)</td>
      <td id="T_4b8a5_row2_col2" class="data row2 col2" >Least Squares Regression Model</td>
      <td id="T_4b8a5_row2_col3" class="data row2 col3" >0.4459 (n.s.)</td>
      <td id="T_4b8a5_row2_col4" class="data row2 col4" >Parallel advantage (No convergence)</td>
    </tr>
  </tbody>
</table>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel G2: Granular Week-by-Week Comparisons (Tukey&#39;s HSD) ---
</pre></div>
</div>
<div class="output text_html"><style type="text/css">
#T_7be8b th {
  text-align: left;
}
#T_7be8b_row1_col1, #T_7be8b_row6_col1, #T_7be8b_row9_col1, #T_7be8b_row10_col1, #T_7be8b_row12_col1, #T_7be8b_row13_col1 {
  background-color: #d4edda;
  font-weight: bold;
}
</style>
<table id="T_7be8b">
  <thead>
    <tr>
      <th id="T_7be8b_level0_col0" class="col_heading level0 col0" >Comparison</th>
      <th id="T_7be8b_level0_col1" class="col_heading level0 col1" >P-Value</th>
      <th id="T_7be8b_level0_col2" class="col_heading level0 col2" >Inference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td id="T_7be8b_row0_col0" class="data row0 col0" >Learning W1 vs Learning W2</td>
      <td id="T_7be8b_row0_col1" class="data row0 col1" >0.1334 (n.s.)</td>
      <td id="T_7be8b_row0_col2" class="data row0 col2" >Stable baseline</td>
    </tr>
    <tr>
      <td id="T_7be8b_row1_col0" class="data row1 col0" >Learning W1 vs Learning W3</td>
      <td id="T_7be8b_row1_col1" class="data row1 col1" >0.0010 (**)</td>
      <td id="T_7be8b_row1_col2" class="data row1 col2" >Significant decline over time</td>
    </tr>
    <tr>
      <td id="T_7be8b_row2_col0" class="data row2 col0" >Learning W1 vs Paired VNS W1</td>
      <td id="T_7be8b_row2_col1" class="data row2 col1" >0.0659 (Trend)</td>
      <td id="T_7be8b_row2_col2" class="data row2 col2" >VNS trending higher immediately</td>
    </tr>
    <tr>
      <td id="T_7be8b_row3_col0" class="data row3 col0" >Learning W1 vs Paired VNS W2</td>
      <td id="T_7be8b_row3_col1" class="data row3 col1" >0.9861 (n.s.)</td>
      <td id="T_7be8b_row3_col2" class="data row3 col2" >VNS W2 returns to Learning W1 levels</td>
    </tr>
    <tr>
      <td id="T_7be8b_row4_col0" class="data row4 col0" >Learning W1 vs Paired VNS W3</td>
      <td id="T_7be8b_row4_col1" class="data row4 col1" >0.1011 (n.s.)</td>
      <td id="T_7be8b_row4_col2" class="data row4 col2" >VNS W3 returns to Learning W1 levels</td>
    </tr>
    <tr>
      <td id="T_7be8b_row5_col0" class="data row5 col0" >Learning W2 vs Learning W3</td>
      <td id="T_7be8b_row5_col1" class="data row5 col1" >0.4487 (n.s.)</td>
      <td id="T_7be8b_row5_col2" class="data row5 col2" >Stable low rate</td>
    </tr>
    <tr>
      <td id="T_7be8b_row6_col0" class="data row6 col0" >Learning W2 vs Paired VNS W1</td>
      <td id="T_7be8b_row6_col1" class="data row6 col1" >0.0001 (***)</td>
      <td id="T_7be8b_row6_col2" class="data row6 col2" >VNS W1 far exceeds Learning W2</td>
    </tr>
    <tr>
      <td id="T_7be8b_row7_col0" class="data row7 col0" >Learning W2 vs Paired VNS W2</td>
      <td id="T_7be8b_row7_col1" class="data row7 col1" >0.6313 (n.s.)</td>
      <td id="T_7be8b_row7_col2" class="data row7 col2" >Rates similar</td>
    </tr>
    <tr>
      <td id="T_7be8b_row8_col0" class="data row8 col0" >Learning W2 vs Paired VNS W3</td>
      <td id="T_7be8b_row8_col1" class="data row8 col1" >0.9969 (n.s.)</td>
      <td id="T_7be8b_row8_col2" class="data row8 col2" >Rates similar</td>
    </tr>
    <tr>
      <td id="T_7be8b_row9_col0" class="data row9 col0" >Learning W3 vs Paired VNS W1</td>
      <td id="T_7be8b_row9_col1" class="data row9 col1" >< 0.0001 (****)</td>
      <td id="T_7be8b_row9_col2" class="data row9 col2" >VNS W1 far exceeds Learning W3</td>
    </tr>
    <tr>
      <td id="T_7be8b_row10_col0" class="data row10 col0" >Learning W3 vs Paired VNS W2</td>
      <td id="T_7be8b_row10_col1" class="data row10 col1" >0.0330 (*)</td>
      <td id="T_7be8b_row10_col2" class="data row10 col2" >VNS W2 exceeds Learning W3</td>
    </tr>
    <tr>
      <td id="T_7be8b_row11_col0" class="data row11 col0" >Learning W3 vs Paired VNS W3</td>
      <td id="T_7be8b_row11_col1" class="data row11 col1" >0.8674 (n.s.)</td>
      <td id="T_7be8b_row11_col2" class="data row11 col2" >Rates similar at end</td>
    </tr>
    <tr>
      <td id="T_7be8b_row12_col0" class="data row12 col0" >Paired VNS W1 vs Paired VNS W2</td>
      <td id="T_7be8b_row12_col1" class="data row12 col1" >0.0334 (*)</td>
      <td id="T_7be8b_row12_col2" class="data row12 col2" >Significant drop after VNS week</td>
    </tr>
    <tr>
      <td id="T_7be8b_row13_col0" class="data row13 col0" >Paired VNS W1 vs Paired VNS W3</td>
      <td id="T_7be8b_row13_col1" class="data row13 col1" >0.0002 (***)</td>
      <td id="T_7be8b_row13_col2" class="data row13 col2" >Significant drop after VNS week</td>
    </tr>
    <tr>
      <td id="T_7be8b_row14_col0" class="data row14 col0" >Paired VNS W2 vs Paired VNS W3</td>
      <td id="T_7be8b_row14_col1" class="data row14 col1" >0.4687 (n.s.)</td>
      <td id="T_7be8b_row14_col2" class="data row14 col2" >Stable post-stimulation</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="alert alert-block alert-info">
    <b>Data Transparency: Pinpointing the Acceleration</b><br>
    While the main model confirms a broad group effect, the full pairwise breakdown (Table G2) reveals the precise temporal dynamics that printed manuscripts often obscure:
    <ul>
        <li><b>The "VNS Spike":</b> The most dramatic differences occur against <b>Paired VNS Week 1</b>. It is significantly higher than nearly all later timepoints (<i>p < 0.0001</i> vs Learning W3), confirming that the intervention triggers an immediate, massive mobilization of progenitors.</li>
        <li><b>Rapid Normalization:</b> By Week 2, the Paired VNS rate (<i>p = 0.6313</i> vs Learning W2) returns to a level comparable to the early Learning phase. This indicates VNS acts as a "pulse" amplifier rather than a tonic elevator of baseline rates.</li>
    </ul>
</div><div class="alert alert-block alert-success">
    <b>Statistical Insight: A Sustained "Speed Boost"</b><br>
    The regression analysis of the post-stimulation period confirms that the benefits of Paired VNS extend well beyond the stimulation week:
    <ul>
        <li><b>Significant Acceleration (Group Effect):</b> Paired VNS drove a highly significant increase in the daily rate of oligodendrocyte replacement compared to Motor Learning alone (<i>p = 0.0026</i>).</li>
        <li><b>Parallel Decay (No Interaction):</b> While both groups showed the expected biological deceleration in replacement rate over time (<i>p < 0.0001</i>), the lack of interaction (<i>p = 0.4459</i>) indicates that the Paired VNS group maintained its kinetic advantage throughout the recovery period, rather than quickly falling back to baseline levels.</li>
    </ul>
</div></section>
<section id="panel-h">
<h2>Panel H<a class="headerlink" href="#panel-h" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 3 Panel H" src="_images/panelH1.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- PANEL H DATA (Maximum Velocity) ---</span>
<span class="n">data_h</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Comparison&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Paired VNS vs. Motor Learning&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Maximum OL Replacement Rate (Peak Velocity)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Student&#39;s t-test&quot;</span><span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0026 (**)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Significant increase in peak regeneration speed&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_h</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_h</span><span class="p">,</span> <span class="s2">&quot;--- Panel H Statistics: Breaking the Speed Limit ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel H Statistics: Breaking the Speed Limit ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Comparison</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Paired VNS vs. Motor Learning</td>
      <td>Maximum OL Replacement Rate (Peak Velocity)</td>
      <td>Student's t-test</td>
      <td>0.0026 (**)</td>
      <td>Significant increase in peak regeneration speed</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: Paired VNS "Breaks the Speed Limit"</b><br>
    This result marks a critical divergence from the passive stimulation effects seen in Figure 1:
    <ul>
        <li><b>Doubling Velocity:</b> Unlike passive VNS (which extended the window but respected the speed limit), Paired VNS significantly increased the <i>maximum</i> rate of oligodendrocyte replacement compared to Motor Learning controls (<b>6.82% vs. 3.55%</b>; <i>p = 0.0026</i>).</li>
        <li><b>Synergistic Mechanism:</b> This suggests that the coincidence of VNS with task-specific neural activity recruits a distinct, more aggressive regenerative mechanism, effectively "supercharging" the differentiation capacity of the available progenitor pool beyond what is possible with training or stimulation alone.</li>
    </ul>
</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="figure1_VNSOligos.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Figure 1 VNS Enhances Oligodendrogenesis</p>
      </div>
    </a>
    <a class="right-next"
       href="figure6_Neuropixels.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Figure 6 Neuropixels</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-a-b-the-paired-stimulation-paradigm">Panels A &amp; B: The Paired Stimulation Paradigm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c">Panel C</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c-visualizing-individual-trajectories">Panel C: Visualizing Individual Trajectories</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-d">Panel D</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e">Panel E</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f">Panel F</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-g">Panel G</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-h">Panel H</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Shayok 'Shay' Dutta, PhD
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>