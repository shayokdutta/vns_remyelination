

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Figure 6 Neuropixels &#8212; VNS Myelin Manuscript Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'figure6_Neuropixels';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Figure 7: Myelin-Dependent Motor Recovery" href="figure7_longtermMyelin.html" />
    <link rel="prev" title="Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">VNS Myelin Manuscript Book</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Figures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Figure 6: Neuropixels</a></li>
<li class="toctree-l1"><a class="reference internal" href="figure7_longtermMyelin.html">Figure 7: Myelin-Dependent Long-Term Recovery</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/figure6_Neuropixels.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Figure 6 Neuropixels</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-and-shared-things">Load data and shared things</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-a">Panel a</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-b-overall-firing-rates">Panel b (Overall firing rates)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c-fs-rs-neurons">Panel c (FS &amp; RS Neurons)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-d-rs-vs-fs-temporal-variability-over-the-recording-session">Panel d (RS vs FS temporal variability over the recording session)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e-early-vs-late-phase-rs-and-fs-neurons">Panel e (Early vs Late Phase RS and FS Neurons)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f-success-aligned-trajectories">Panel f (Success-aligned trajectories)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-data-figure">Extended Data Figure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Panel a</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-b">Panel b</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="figure-6-neuropixels">
<h1>Figure 6 Neuropixels<a class="headerlink" href="#figure-6-neuropixels" title="Permalink to this heading">#</a></h1>
<section id="load-data-and-shared-things">
<h2>Load data and shared things<a class="headerlink" href="#load-data-and-shared-things" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">nelpy</span> <span class="k">as</span> <span class="nn">nel</span>
<span class="kn">import</span> <span class="nn">nelpy.plotting</span> <span class="k">as</span> <span class="nn">npl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="c1"># Suppress warnings</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Set the root logger&#39;s level to ERROR to suppress WARNING messages</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="c1"># --- 1. Load Data ---</span>
<span class="c1"># Absolute paths from your local machine</span>
<span class="n">df_reaches</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s2">&quot;/home/shayok/Documents/Data/VNS-Remyelination/NPX/df_reaches_all.json&quot;</span><span class="p">)</span>
<span class="n">df_zeta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="s2">&quot;/home/shayok/Documents/Data/VNS-Remyelination/NPX/df_zeta_shayUpdates.json&quot;</span><span class="p">)</span>

<span class="c1"># --- 2. Pre-process Spike Trains ---</span>
<span class="c1"># Create SpikeTrainArray and smooth (30ms bins, sigma=0.1s)</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">SpikeTrainArray</span><span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;times&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">fs</span><span class="o">=</span><span class="mi">30000</span><span class="p">)</span>
<span class="n">bst</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">bin</span><span class="p">(</span><span class="n">ds</span><span class="o">=</span><span class="mf">0.030</span><span class="p">)</span><span class="o">.</span><span class="n">smooth</span><span class="p">(</span><span class="n">sigma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># --- 3. Define Global Styling &amp; Palettes ---</span>
<span class="c1"># Exact styling from your notebook</span>
<span class="n">npl</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">rc</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> 
             <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
             <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">}))</span>

<span class="c1"># Exact hex codes from Cell 15 of your notebook</span>
<span class="n">my_pal_rs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#cedcdc&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#66b2ff&quot;</span><span class="p">}</span>
<span class="n">my_pal_fs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#5f7575&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#004080&quot;</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data Loaded and Styles Set.&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Data Loaded and Styles Set.
</pre></div>
</div>
</div>
</div>
</section>
<section id="panel-a">
<h2>Panel a<a class="headerlink" href="#panel-a" title="Permalink to this heading">#</a></h2>
<p>(aka Shay spending his Friday night drawing a mouse while his partner throws dog toys at him)</p>
<p><img alt="Figure 6 Panel A" src="_images/panelA.svg" /></p>
</section>
<section id="panel-b-overall-firing-rates">
<h2>Panel b (Overall firing rates)<a class="headerlink" href="#panel-b-overall-firing-rates" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- 1. Prepare Data ---</span>
<span class="n">motor_learning_firing_rate</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">paired_vns_firing_rate</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># --- 2. Statistical Testing (Restored) ---</span>
<span class="n">ks_statistic</span><span class="p">,</span> <span class="n">ks_p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span><span class="n">motor_learning_firing_rate</span><span class="p">,</span> <span class="n">paired_vns_firing_rate</span><span class="p">)</span>
<span class="n">mw_statistic</span><span class="p">,</span> <span class="n">mw_p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">motor_learning_firing_rate</span><span class="p">,</span> <span class="n">paired_vns_firing_rate</span><span class="p">)</span>
<span class="n">wasserstein_dist</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wasserstein_distance</span><span class="p">(</span><span class="n">motor_learning_firing_rate</span><span class="p">,</span> <span class="n">paired_vns_firing_rate</span><span class="p">)</span>
<span class="n">ad_result</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">anderson_ksamp</span><span class="p">([</span><span class="n">motor_learning_firing_rate</span><span class="p">,</span> <span class="n">paired_vns_firing_rate</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Comparison of Distributions ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mann-Whitney U Test:              Statistic=</span><span class="si">{</span><span class="n">mw_statistic</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P-value=</span><span class="si">{</span><span class="n">mw_p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Kolmogorov-Smirnov Test:          Statistic=</span><span class="si">{</span><span class="n">ks_statistic</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P-value=</span><span class="si">{</span><span class="n">ks_p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anderson-Darling k-sample Test:   Statistic=</span><span class="si">{</span><span class="n">ad_result</span><span class="o">.</span><span class="n">statistic</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P-value=</span><span class="si">{</span><span class="n">ad_result</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Wasserstein Distance (EMD):       </span><span class="si">{</span><span class="n">wasserstein_dist</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------&quot;</span><span class="p">)</span>

<span class="c1"># --- 3. Setup Plot ---</span>
<span class="c1"># Exact dimensions from your code</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># --- 4. Plotting Parameters ---</span>
<span class="n">bw_method_choice</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">num_eval_points</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">x_position</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Center violin at 0</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.8</span>

<span class="c1"># Define Groups</span>
<span class="n">experiments_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="c1"># [&#39;motorlearning&#39;, &#39;pairedVNS&#39;]</span>

<span class="c1"># Loop to draw Split Violin</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">experiments_list</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">experiment</span><span class="p">][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1"># Calculate KDE</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">bw_method_choice</span><span class="p">)</span>
    <span class="n">x_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> 
                         <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">num_eval_points</span><span class="p">)</span>
    
    <span class="n">violin_shape</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_eval</span><span class="p">)</span>
    <span class="n">violin_shape</span> <span class="o">=</span> <span class="n">violin_shape</span> <span class="o">/</span> <span class="n">violin_shape</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
    
    <span class="c1"># Plotting Logic</span>
    <span class="k">if</span> <span class="n">experiment</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">:</span> <span class="c1"># Left Side</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">x_eval</span><span class="p">,</span> <span class="n">x_position</span><span class="p">,</span> <span class="n">x_position</span> <span class="o">-</span> <span class="n">violin_shape</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#cfd9d9ff&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_position</span> <span class="o">-</span> <span class="n">violin_shape</span><span class="p">,</span> <span class="n">x_eval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#9fb3b3ff&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="c1"># Sticks</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">index_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_eval</span> <span class="o">-</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">stick_xmax</span> <span class="o">=</span> <span class="n">x_position</span> <span class="o">-</span> <span class="n">violin_shape</span><span class="p">[</span><span class="n">index_val</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">x_position</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">stick_xmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#9fb3b3ff&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
            
    <span class="k">elif</span> <span class="n">experiment</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">:</span> <span class="c1"># Right Side</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">x_eval</span><span class="p">,</span> <span class="n">x_position</span><span class="p">,</span> <span class="n">x_position</span> <span class="o">+</span> <span class="n">violin_shape</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#7fbcffff&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_position</span> <span class="o">+</span> <span class="n">violin_shape</span><span class="p">,</span> <span class="n">x_eval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
        <span class="c1"># Sticks</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">index_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_eval</span> <span class="o">-</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">stick_xmax</span> <span class="o">=</span> <span class="n">x_position</span> <span class="o">+</span> <span class="n">violin_shape</span><span class="p">[</span><span class="n">index_val</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">x_position</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">stick_xmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#0e80ffff&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c1"># --- 5. Significance Annotation (Exact Position) ---</span>
<span class="c1"># Hardcoded params from your notebook</span>
<span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span>  
<span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="mf">9.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span>  <span class="c1"># Fixed y=9.5 as per your snippet</span>

<span class="k">if</span> <span class="n">mw_p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
    <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">if</span> <span class="n">mw_p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">if</span> <span class="n">mw_p_value</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
    <span class="c1"># Stars centered at 0.5 (relative to x1, x2 logic)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="mf">.5</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># &quot;n.s.&quot; placed at 0.25 (shifted left/center-left)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x1</span><span class="o">+</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="mf">.25</span><span class="p">,</span> <span class="n">y</span><span class="o">+</span><span class="n">h</span><span class="o">+</span><span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;n.s.&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>

<span class="c1"># --- 6. Formatting ---</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="n">x_position</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;firing rate (Hz)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top_bottom</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Comparison of Distributions ---
Mann-Whitney U Test:              Statistic=33460.0000, P-value=0.1877
Kolmogorov-Smirnov Test:          Statistic=0.1148, P-value=0.0781
Anderson-Darling k-sample Test:   Statistic=2.0433, P-value=0.0468
Wasserstein Distance (EMD):       0.4442
-----------------------------------
</pre></div>
</div>
<img alt="_images/ecbedb288d8a5c6c5cd2c2272bccc3054506f3d9cf9998128353aaa5ac079ac9.png" src="_images/ecbedb288d8a5c6c5cd2c2272bccc3054506f3d9cf9998128353aaa5ac079ac9.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Note: Distribution vs. Median</b><br>
    While the <b>Mann-Whitney U test</b> (<i>p=0.1877</i>) indicates no significant difference in the median firing rates between the <i>Motor Learning</i> and <i>Paired VNS</i> groups, the <b>Anderson-Darling k-sample test</b> (<i>p=0.0468</i>) reveals a statistically significant difference in the underlying distributions.
    <br><br>
    This suggests that while the <i>average</i> activity levels are comparable, Paired VNS may be modulating specific sub-populations of neurons differently. To investigate this distributional shift, we next stratify the population into <b>Regular Spiking (RS)</b> and <b>Fast Spiking (FS)</b> neurons.
</div></section>
<section id="panel-c-fs-rs-neurons">
<h2>Panel c (FS &amp; RS Neurons)<a class="headerlink" href="#panel-c-fs-rs-neurons" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- 1. Prepare Data ---</span>
<span class="c1"># RS Neurons</span>
<span class="n">ml_rs</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">vns_rs</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># FS Neurons</span>
<span class="n">ml_fs</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">vns_fs</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)][</span><span class="s1">&#39;overall_rate&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># --- 2. Statistical Testing (Full Block) ---</span>
<span class="n">mw_stat_rs</span><span class="p">,</span> <span class="n">mw_p_rs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">ml_rs</span><span class="p">,</span> <span class="n">vns_rs</span><span class="p">)</span>
<span class="n">mw_stat_fs</span><span class="p">,</span> <span class="n">mw_p_fs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">ml_fs</span><span class="p">,</span> <span class="n">vns_fs</span><span class="p">)</span>

<span class="n">ks_stat_rs</span><span class="p">,</span> <span class="n">ks_p_rs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span><span class="n">ml_rs</span><span class="p">,</span> <span class="n">vns_rs</span><span class="p">)</span>
<span class="n">ks_stat_fs</span><span class="p">,</span> <span class="n">ks_p_fs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kstest</span><span class="p">(</span><span class="n">ml_fs</span><span class="p">,</span> <span class="n">vns_fs</span><span class="p">)</span>

<span class="n">ad_res_rs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">anderson_ksamp</span><span class="p">([</span><span class="n">ml_rs</span><span class="p">,</span> <span class="n">vns_rs</span><span class="p">])</span>
<span class="n">ad_res_fs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">anderson_ksamp</span><span class="p">([</span><span class="n">ml_fs</span><span class="p">,</span> <span class="n">vns_fs</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Comparison of Distributions ---&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mann-Whitney U (RS):    Stat=</span><span class="si">{</span><span class="n">mw_stat_rs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">mw_p_rs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mann-Whitney U (FS):    Stat=</span><span class="si">{</span><span class="n">mw_stat_fs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">mw_p_fs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KS Test (RS):           Stat=</span><span class="si">{</span><span class="n">ks_stat_rs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">ks_p_rs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;KS Test (FS):           Stat=</span><span class="si">{</span><span class="n">ks_stat_fs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">ks_p_fs</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anderson-Darling (RS):  Stat=</span><span class="si">{</span><span class="n">ad_res_rs</span><span class="o">.</span><span class="n">statistic</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">ad_res_rs</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Anderson-Darling (FS):  Stat=</span><span class="si">{</span><span class="n">ad_res_fs</span><span class="o">.</span><span class="n">statistic</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, P=</span><span class="si">{</span><span class="n">ad_res_fs</span><span class="o">.</span><span class="n">pvalue</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------------&quot;</span><span class="p">)</span>

<span class="c1"># --- 3. Define Plotting Function (Manual Split Violin) ---</span>
<span class="k">def</span> <span class="nf">plot_manual_split_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data_left</span><span class="p">,</span> <span class="n">data_right</span><span class="p">,</span> <span class="n">palette</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Manually builds a split violin plot from a KDE with an internal &#39;stick&#39; plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">plot_half</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">color</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
            <span class="c1"># Use a consistent y_eval range for better comparison</span>
            <span class="n">y_min</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_left</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_left</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data_right</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_right</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span> <span class="c1"># at least 10</span>
            
            <span class="n">y_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span> <span class="o">-</span> <span class="n">y_max</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="n">y_max</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_eval</span><span class="p">)</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">/</span> <span class="n">shape</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.8</span> <span class="o">/</span> <span class="mf">2.0</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y_eval</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">shape</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">direction</span> <span class="o">*</span> <span class="n">shape</span><span class="p">,</span> <span class="n">y_eval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="n">y_eval</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">y_eval</span><span class="o">.</span><span class="n">max</span><span class="p">():</span> <span class="k">continue</span> <span class="c1"># Skip outliers</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_eval</span> <span class="o">-</span> <span class="n">val</span><span class="p">))</span>
                <span class="n">stick_xmax</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">stick_xmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
    
    <span class="n">plot_half</span><span class="p">(</span><span class="n">data_left</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">])</span>
    <span class="n">plot_half</span><span class="p">(</span><span class="n">data_right</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">add_sig_stars</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds significance stars above a plot.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data2</span><span class="p">))</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">0.05</span>
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="s1">&#39;n.s.&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># --- 4. Main Plotting Block ---</span>
<span class="c1"># Exact styling from your snippet</span>
<span class="n">npl</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
         <span class="n">rc</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> 
               <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
               <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">}))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Color Palettes</span>
<span class="n">my_pal_rs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#cfd9d9&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#7fbcff&quot;</span><span class="p">}</span>
<span class="n">my_pal_fs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#9fb3b3&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#0e80ff&quot;</span><span class="p">}</span>

<span class="c1"># PLOT 1: RS Neurons (Left)</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ml_rs</span><span class="p">,</span> <span class="n">vns_rs</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mw_p_rs</span><span class="p">,</span> <span class="n">ml_rs</span><span class="p">,</span> <span class="n">vns_rs</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;firing rate (Hz)&quot;</span><span class="p">)</span>

<span class="c1"># PLOT 2: FS Neurons (Right)</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ml_fs</span><span class="p">,</span> <span class="n">vns_fs</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mw_p_fs</span><span class="p">,</span> <span class="n">ml_fs</span><span class="p">,</span> <span class="n">vns_fs</span><span class="p">)</span>

<span class="c1"># --- 5. Formatting ---</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="c1"># Correct Nelpy Utils Calls</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top_bottom</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="c1"># Remove left spine/ticks from right plot (FS)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_left</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Comparison of Distributions ---
Mann-Whitney U (RS):    Stat=12739.0000, P=0.0001
Mann-Whitney U (FS):    Stat=4247.0000, P=0.0576
KS Test (RS):           Stat=0.2178, P=0.0027
KS Test (FS):           Stat=0.1859, P=0.0599
Anderson-Darling (RS):  Stat=9.0058, P=0.0010
Anderson-Darling (FS):  Stat=1.8423, P=0.0565
-----------------------------------
</pre></div>
</div>
<img alt="_images/91474672735d17d3f66b23729f4880217c256d110ef1211aa8d5c5eb316e6b14.png" src="_images/91474672735d17d3f66b23729f4880217c256d110ef1211aa8d5c5eb316e6b14.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: Cell-Type Specific Modulation</b><br>
    The stratification reveals a clear divergence in how VNS affects neuronal subtypes. 
    <b>RS Neurons</b> exhibit a robust, statistically significant difference in firing distributions across all tests (<i>Mann-Whitney p=0.0001</i>), confirming that Paired VNS strongly modulates excitatory activity. 
    In contrast, <b>FS Neurons</b> show only a marginal trend toward difference (<i>p  0.058</i>) in this aggregate view.
    <br><br>
    However, these aggregate statistics collapse the temporal dimension of the recording. Given that VNS is delivered phasically during behavior, these differences may be driven by specific windows of time (e.g., early vs. late consolidation). To disentangle these dynamics, we next examine the <b>temporal trajectories</b> of firing rates across the 1-hour session.
</div></section>
<section id="panel-d-rs-vs-fs-temporal-variability-over-the-recording-session">
<h2>Panel d (RS vs FS temporal variability over the recording session)<a class="headerlink" href="#panel-d-rs-vs-fs-temporal-variability-over-the-recording-session" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================================================================</span>
<span class="c1"># 1. SLIDING WINDOW &amp; DATA PREPARATION</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># --- Define Sliding Window Parameters ---</span>
<span class="n">window_size</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">stride</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">total_duration</span> <span class="o">=</span> <span class="mi">3600</span> <span class="o">+</span> <span class="mi">60</span> <span class="c1"># Constrain analysis to 1 hour</span>

<span class="c1"># Generate a list of all possible epoch objects for the sliding window</span>
<span class="n">all_epochs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">start_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_duration</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
<span class="k">for</span> <span class="n">start_time</span> <span class="ow">in</span> <span class="n">start_times</span><span class="p">:</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">window_size</span>
    <span class="n">all_epochs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">]))</span>

<span class="c1"># --- Get Neuron Indices for Each Subgroup ---</span>
<span class="c1"># (&#39;+ 1&#39; added back as &#39;st&#39; expects 1-based series_ids)</span>
<span class="n">ml_rs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">vns_rs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">ml_fs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">vns_fs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># --- Calculate Firing Rates for all conditions in each window ---</span>
<span class="n">fr_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_epochs</span><span class="p">):</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">.</span><span class="n">duration</span>
    <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span> <span class="n">ml_rs_indices</span><span class="p">][</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
    <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span> <span class="n">vns_rs_indices</span><span class="p">][</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
    <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span> <span class="n">ml_fs_indices</span><span class="p">][</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
    <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span> <span class="n">vns_fs_indices</span><span class="p">][</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>

<span class="c1"># --- Calculate Mean and SEM for each group/window ---</span>
<span class="n">summary_stats</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">fr_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">summary_stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s1">&#39;sem&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">summary_stats</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s1">&#39;sem&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 2. STATISTICAL ANALYSIS (Significant Epochs)</span>
<span class="c1"># =============================================================================</span>
<span class="n">significant_epochs_rs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">significant_epochs_fs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.05</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_epochs</span><span class="p">):</span>
    <span class="c1"># RS comparison</span>
    <span class="n">data_rs_ml</span> <span class="o">=</span> <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="n">data_rs_vns</span> <span class="o">=</span> <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rs_ml</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rs_vns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p_val_rs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">data_rs_ml</span><span class="p">,</span> <span class="n">data_rs_vns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_val_rs</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">significant_epochs_rs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>
            
    <span class="c1"># FS comparison</span>
    <span class="n">data_fs_ml</span> <span class="o">=</span> <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="n">data_fs_vns</span> <span class="o">=</span> <span class="n">fr_data</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_fs_ml</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_fs_vns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">p_val_fs</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">data_fs_ml</span><span class="p">,</span> <span class="n">data_fs_vns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_val_fs</span> <span class="o">&lt;</span> <span class="n">alpha</span><span class="p">:</span>
            <span class="n">significant_epochs_fs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">epoch</span><span class="p">)</span>

<span class="c1"># Convert lists of epochs to a single EpochArray for plotting</span>
<span class="n">sig_epoch_array_rs</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">significant_epochs_rs</span><span class="p">]))</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span> <span class="k">if</span> <span class="n">significant_epochs_rs</span> <span class="k">else</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">(</span><span class="n">empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sig_epoch_array_fs</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">significant_epochs_fs</span><span class="p">]))</span><span class="o">.</span><span class="n">merge</span><span class="p">()</span> <span class="k">if</span> <span class="n">significant_epochs_fs</span> <span class="k">else</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">(</span><span class="n">empty</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 3. SUCCESS DATA PREPARATION</span>
<span class="c1"># =============================================================================</span>
<span class="n">ml_mice_list</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">][</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">vns_mice_list</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">][</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="c1"># Filter df_reaches for successes for each group</span>
<span class="n">df_successes</span> <span class="o">=</span> <span class="n">df_reaches</span><span class="p">[</span><span class="n">df_reaches</span><span class="p">[</span><span class="s1">&#39;behaviors&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">]</span>
<span class="n">ml_success_times</span> <span class="o">=</span> <span class="n">df_successes</span><span class="p">[</span><span class="n">df_successes</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">ml_mice_list</span><span class="p">)][</span><span class="s1">&#39;rMax_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">vns_success_times</span> <span class="o">=</span> <span class="n">df_successes</span><span class="p">[</span><span class="n">df_successes</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">vns_mice_list</span><span class="p">)][</span><span class="s1">&#39;rMax_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 4. PLOTTING</span>
<span class="c1"># =============================================================================</span>
<span class="n">n_windows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_epochs</span><span class="p">)</span>
<span class="n">x_axis</span> <span class="o">=</span> <span class="n">start_times</span> <span class="o">+</span> <span class="p">(</span><span class="n">window_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

<span class="c1"># Define Helper Function for Significance Bar</span>
<span class="k">def</span> <span class="nf">plot_significance_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">sig_epochs</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sig_epochs</span><span class="o">.</span><span class="n">isempty</span><span class="p">:</span>
        <span class="k">return</span>
    
    <span class="c1"># This transform uses X in data coordinates and Y in axis coordinates (0-1)</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis_transform</span><span class="p">()</span>
    <span class="n">y_pos</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="c1"># 95% of the way up the axis</span>
    
    <span class="k">for</span> <span class="n">interval</span> <span class="ow">in</span> <span class="n">sig_epochs</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
        <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">],</span> <span class="p">[</span><span class="n">y_pos</span><span class="p">,</span> <span class="n">y_pos</span><span class="p">],</span> 
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">)</span>

<span class="c1"># Figure Dimensions</span>
<span class="n">figure_width</span> <span class="o">=</span> <span class="mf">4.75</span>
<span class="n">height_rs</span> <span class="o">=</span> <span class="mf">1.3</span>
<span class="n">height_fs</span> <span class="o">=</span> <span class="mf">1.3</span>
<span class="n">height_hist</span> <span class="o">=</span> <span class="mf">0.6</span>
<span class="n">total_figure_height</span> <span class="o">=</span> <span class="n">height_rs</span> <span class="o">+</span> <span class="n">height_fs</span> <span class="o">+</span> <span class="n">height_hist</span>

<span class="c1"># Create Subplots (Histogram -&gt; RS -&gt; FS)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> 
                         <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">figure_width</span><span class="p">,</span> <span class="n">total_figure_height</span><span class="p">),</span> 
                         <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                         <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">height_hist</span><span class="p">,</span> <span class="n">height_rs</span><span class="p">,</span> <span class="n">height_fs</span><span class="p">]})</span>

<span class="n">my_pal_rs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#9FCFC8&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#1F6F6F&quot;</span><span class="p">}</span>
<span class="n">my_pal_fs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#D8A6A6&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#A00000&quot;</span><span class="p">}</span>

<span class="c1"># --- PLOT 1: Histogram (axes[0]) ---</span>
<span class="n">ax_hist</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">hist_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_duration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">90</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#9fb3b3&#39;</span><span class="p">,</span> <span class="s1">&#39;#0e80ff&#39;</span><span class="p">]</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Motor Learning&#39;</span><span class="p">,</span> <span class="s1">&#39;Paired VNS&#39;</span><span class="p">]</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">hist</span><span class="p">([</span><span class="n">ml_success_times</span><span class="p">,</span> <span class="n">vns_success_times</span><span class="p">],</span> 
             <span class="n">bins</span><span class="o">=</span><span class="n">hist_bins</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> 
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;success</span><span class="se">\n</span><span class="s2">count&quot;</span><span class="p">)</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="c1"># --- PLOT 2: RS Neurons (axes[1]) ---</span>
<span class="n">ax_rs</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">]:</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary_stats</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">)]</span>
    <span class="n">sems</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary_stats</span><span class="p">[(</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;sem&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">)]</span>
    <span class="n">means</span><span class="p">,</span> <span class="n">sems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sems</span><span class="p">)</span>
    
    <span class="n">color</span> <span class="o">=</span> <span class="n">my_pal_rs</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">ax_rs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="n">ax_rs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">means</span> <span class="o">-</span> <span class="n">sems</span><span class="p">,</span> <span class="n">means</span> <span class="o">+</span> <span class="n">sems</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax_rs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;RS</span><span class="se">\n</span><span class="s2">firing rate</span><span class="se">\n</span><span class="s2">(Hz)&quot;</span><span class="p">)</span>
<span class="n">ax_rs</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># --- PLOT 3: FS Neurons (axes[2]) ---</span>
<span class="n">ax_fs</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">]:</span>
    <span class="n">means</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary_stats</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">)]</span>
    <span class="n">sems</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary_stats</span><span class="p">[(</span><span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">i</span><span class="p">)][</span><span class="s1">&#39;sem&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_windows</span><span class="p">)]</span>
    <span class="n">means</span><span class="p">,</span> <span class="n">sems</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sems</span><span class="p">)</span>
    
    <span class="n">color</span> <span class="o">=</span> <span class="n">my_pal_fs</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
    <span class="n">ax_fs</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
    <span class="n">ax_fs</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">means</span> <span class="o">-</span> <span class="n">sems</span><span class="p">,</span> <span class="n">means</span> <span class="o">+</span> <span class="n">sems</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

<span class="n">ax_fs</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;FS</span><span class="se">\n</span><span class="s2">firing rate</span><span class="se">\n</span><span class="s2">(Hz)&quot;</span><span class="p">)</span>
<span class="n">ax_fs</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 5. AESTHETICS &amp; AXIS CLEANUP</span>
<span class="c1"># =============================================================================</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_duration</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">ax</span> <span class="o">==</span> <span class="n">ax_rs</span><span class="p">:</span> 
        <span class="n">plot_significance_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">sig_epoch_array_rs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">4.01</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">ax</span> <span class="o">==</span> <span class="n">ax_fs</span><span class="p">:</span> 
        <span class="n">plot_significance_bar</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">sig_epoch_array_fs</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">6.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mf">6.51</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="c1"># Clean up axes that should be blank (Bottoms)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_bottom</span><span class="p">(</span><span class="n">ax_hist</span><span class="p">)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_bottom</span><span class="p">(</span><span class="n">ax_rs</span><span class="p">)</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ax_rs</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Clean up x-axis ticks and labels on upper plots</span>
<span class="n">ax_hist</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax_rs</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Add a full x-axis to the *bottom* plot (ax_fs)</span>
<span class="n">x_ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_duration</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">600</span><span class="p">)</span> <span class="c1"># Ticks every 10 minutes (600s)</span>
<span class="n">ax_fs</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_ticks</span><span class="p">)</span>
<span class="n">ax_fs</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">t</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x_ticks</span><span class="p">])</span> 
<span class="n">ax_fs</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;time (min)&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 6. PRINT SIGNIFICANT DURATIONS</span>
<span class="c1"># =============================================================================</span>

<span class="k">def</span> <span class="nf">print_sig_epochs</span><span class="p">(</span><span class="n">epoch_array</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Significant Intervals for </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epoch_array</span><span class="o">.</span><span class="n">isempty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No significant intervals found.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># epoch_array.data returns a list of [start, stop] pairs</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">interval</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">epoch_array</span><span class="o">.</span><span class="n">data</span><span class="p">):</span>
        <span class="n">start_s</span><span class="p">,</span> <span class="n">stop_s</span> <span class="o">=</span> <span class="n">interval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">interval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">stop_s</span> <span class="o">-</span> <span class="n">start_s</span>
        
        <span class="c1"># Format: Seconds (Minutes)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Interval </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">start_s</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s - </span><span class="si">{</span><span class="n">stop_s</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s  &quot;</span>
              <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">start_s</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">stop_s</span><span class="o">/</span><span class="mi">60</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> min) | Duration: </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="c1"># Print for RS</span>
<span class="n">print_sig_epochs</span><span class="p">(</span><span class="n">sig_epoch_array_rs</span><span class="p">,</span> <span class="s2">&quot;RS Neurons&quot;</span><span class="p">)</span>

<span class="c1"># Print for FS</span>
<span class="n">print_sig_epochs</span><span class="p">(</span><span class="n">sig_epoch_array_fs</span><span class="p">,</span> <span class="s2">&quot;FS Neurons&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/cbfeeee8f8c6a946d9a8827cb8b15c34bb8b7f8a352f55fc9418597a9836a91e.png" src="_images/cbfeeee8f8c6a946d9a8827cb8b15c34bb8b7f8a352f55fc9418597a9836a91e.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Significant Intervals for RS Neurons ---
Interval 1: 420s - 600s  (7.0 - 10.0 min) | Duration: 180s
Interval 2: 1080s - 1200s  (18.0 - 20.0 min) | Duration: 120s
Interval 3: 1500s - 3660s  (25.0 - 61.0 min) | Duration: 2160s

--- Significant Intervals for FS Neurons ---
Interval 1: 240s - 780s  (4.0 - 13.0 min) | Duration: 540s
Interval 2: 1380s - 1500s  (23.0 - 25.0 min) | Duration: 120s
Interval 3: 1620s - 1860s  (27.0 - 31.0 min) | Duration: 240s
Interval 4: 2700s - 2880s  (45.0 - 48.0 min) | Duration: 180s
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: Distinct Temporal Phases</b><br>
    The sliding window analysis reveals two distinct phases of circuit modulation:
    <ul>
        <li><b>Early Phase (0-20 min):</b> Both populations show transient modulation, but FS neurons exhibit a prominent, continuous engagement early on (<i>Interval 1: 4-13 min</i>), consistent with an "inhibition-first" stabilization mechanism.</li>
        <li><b>Late Phase (40-60 min):</b> RS neurons exhibit a massive, sustained divergence starting around 25 minutes and lasting for the remainder of the session (<i>Interval 3: 25-61 min</i>). In contrast, FS modulation becomes intermittent and less robust during this period.</li>
    </ul>
    To formalize this separation, we define two specific epochs for the next analysis: an <b>Early Epoch (0-20 min)</b> to capture the initial inhibitory recruitment, and a <b>Late Epoch (40-60 min)</b> to capture the sustained excitatory stabilization.
</div></section>
<section id="panel-e-early-vs-late-phase-rs-and-fs-neurons">
<h2>Panel e (Early vs Late Phase RS and FS Neurons)<a class="headerlink" href="#panel-e-early-vs-late-phase-rs-and-fs-neurons" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================================================================</span>
<span class="c1"># 1. EPOCH DEFINITIONS &amp; DATA EXTRACTION</span>
<span class="c1"># =============================================================================</span>

<span class="c1"># --- Define Epochs ---</span>
<span class="n">epoch1</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1200</span><span class="p">])</span>    <span class="c1"># 0-20 minutes</span>
<span class="n">epoch2</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="mi">2400</span><span class="p">,</span> <span class="mi">3600</span><span class="p">])</span> <span class="c1"># 40-60 minutes</span>
<span class="n">duration1</span> <span class="o">=</span> <span class="n">epoch1</span><span class="o">.</span><span class="n">duration</span>
<span class="n">duration2</span> <span class="o">=</span> <span class="n">epoch2</span><span class="o">.</span><span class="n">duration</span>

<span class="c1"># --- Get Neuron Indices (&#39;+1&#39; logic maintained) ---</span>
<span class="n">ml_rs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="mi">1</span>
<span class="n">vns_rs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;rs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="mi">1</span>
<span class="n">ml_fs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="mi">1</span>
<span class="n">vns_fs_indices</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fs&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">+</span><span class="mi">1</span>

<span class="c1"># --- Calculate Firing Rates ---</span>
<span class="c1"># Epoch 1 (0-20 min)</span>
<span class="n">fr_ml_rs_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">ml_rs_indices</span><span class="p">][</span><span class="n">epoch1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_vns_rs_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">vns_rs_indices</span><span class="p">][</span><span class="n">epoch1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_ml_fs_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">ml_fs_indices</span><span class="p">][</span><span class="n">epoch1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_vns_fs_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration1</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">vns_fs_indices</span><span class="p">][</span><span class="n">epoch1</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>

<span class="c1"># Epoch 2 (40-60 min)</span>
<span class="n">fr_ml_rs_e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">ml_rs_indices</span><span class="p">][</span><span class="n">epoch2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_vns_rs_e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">vns_rs_indices</span><span class="p">][</span><span class="n">epoch2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_ml_fs_e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">ml_fs_indices</span><span class="p">][</span><span class="n">epoch2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>
<span class="n">fr_vns_fs_e2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration2</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span><span class="n">vns_fs_indices</span><span class="p">][</span><span class="n">epoch2</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">])</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># 2. HELPER FUNCTIONS</span>
<span class="c1"># =============================================================================</span>
<span class="k">def</span> <span class="nf">plot_manual_split_violin</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data_left</span><span class="p">,</span> <span class="n">data_right</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">palette</span><span class="p">):</span>
    <span class="n">data_left</span><span class="p">,</span> <span class="n">data_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_left</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_right</span><span class="p">)</span>
    <span class="n">bw_method_choice</span><span class="p">,</span> <span class="n">num_eval_points</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mf">0.8</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_left</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data_left</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">bw_method_choice</span><span class="p">)</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_left</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> 
        <span class="n">y_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">num_eval_points</span><span class="p">)</span>
        
        <span class="n">shape</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_eval</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">/</span> <span class="n">shape</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y_eval</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">position</span> <span class="o">-</span> <span class="n">shape</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">position</span> <span class="o">-</span> <span class="n">shape</span><span class="p">,</span> <span class="n">y_eval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data_left</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_eval</span> <span class="o">-</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">position</span> <span class="o">-</span> <span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_right</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">kde</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gaussian_kde</span><span class="p">(</span><span class="n">data_right</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="n">bw_method_choice</span><span class="p">)</span>
        <span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_right</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2</span> 
        <span class="n">y_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span><span class="p">,</span> <span class="n">num_eval_points</span><span class="p">)</span>
        
        <span class="n">shape</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_eval</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">shape</span> <span class="o">/</span> <span class="n">shape</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">width</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_betweenx</span><span class="p">(</span><span class="n">y_eval</span><span class="p">,</span> <span class="n">position</span><span class="p">,</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">,</span> <span class="n">y_eval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data_right</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_eval</span> <span class="o">-</span> <span class="n">val</span><span class="p">))</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">position</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="n">position</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_sig_stars</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs Mann-Whitney U test and adds significance stars.</span>
<span class="sd">    Prints detailed statistics with the provided label.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">p_value</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
    
    <span class="c1"># Detailed Printout</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">] Mann-Whitney U p-value: </span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> 
                    <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="n">star</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">if</span> <span class="n">p_value</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="n">star</span> <span class="o">+=</span> <span class="s1">&#39;*&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># 3. MAIN PLOTTING</span>
<span class="c1"># =============================================================================</span>
<span class="n">npl</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
          <span class="n">rc</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
               <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span><span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
               <span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span><span class="mi">42</span><span class="p">,}))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="c1"># --- COLOR PALETTES ---</span>
<span class="n">my_pal_rs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#cedcdc&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#66b2ff&quot;</span><span class="p">}</span>
<span class="n">my_pal_fs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;motorlearning&quot;</span><span class="p">:</span> <span class="s2">&quot;#5f7575&quot;</span><span class="p">,</span> <span class="s2">&quot;pairedVNS&quot;</span><span class="p">:</span> <span class="s2">&quot;#004080&quot;</span><span class="p">}</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--- Statistical Results by Epoch ---&quot;</span><span class="p">)</span>

<span class="c1"># 1. RS Early (0-20 min) -&gt; Axes[0]</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr_ml_rs_e1</span><span class="p">,</span> <span class="n">fr_vns_rs_e1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fr_ml_rs_e1</span><span class="p">,</span> <span class="n">fr_vns_rs_e1</span><span class="p">,</span> <span class="s2">&quot;RS Neurons (Early: 0-20 min)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;firing rate (Hz)&quot;</span><span class="p">)</span> 
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;RS</span><span class="se">\n</span><span class="s1">0-20 min&#39;</span><span class="p">)</span> 

<span class="c1"># 2. FS Early (0-20 min) -&gt; Axes[1]</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr_ml_fs_e1</span><span class="p">,</span> <span class="n">fr_vns_fs_e1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fr_ml_fs_e1</span><span class="p">,</span> <span class="n">fr_vns_fs_e1</span><span class="p">,</span> <span class="s2">&quot;FS Neurons (Early: 0-20 min)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;FS</span><span class="se">\n</span><span class="s1">0-20 min&#39;</span><span class="p">)</span> 

<span class="c1"># 3. RS Late (40-60 min) -&gt; Axes[2]</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fr_ml_rs_e2</span><span class="p">,</span> <span class="n">fr_vns_rs_e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fr_ml_rs_e2</span><span class="p">,</span> <span class="n">fr_vns_rs_e2</span><span class="p">,</span> <span class="s2">&quot;RS Neurons (Late: 40-60 min)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;RS</span><span class="se">\n</span><span class="s1">40-60 min&#39;</span><span class="p">)</span> 

<span class="c1"># 4. FS Late (40-60 min) -&gt; Axes[3]</span>
<span class="n">plot_manual_split_violin</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fr_ml_fs_e2</span><span class="p">,</span> <span class="n">fr_vns_fs_e2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">)</span>
<span class="n">add_sig_stars</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">fr_ml_fs_e2</span><span class="p">,</span> <span class="n">fr_vns_fs_e2</span><span class="p">,</span> <span class="s2">&quot;FS Neurons (Late: 40-60 min)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;FS</span><span class="se">\n</span><span class="s1">40-60 min&#39;</span><span class="p">)</span> 

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;------------------------------------&quot;</span><span class="p">)</span>

<span class="c1"># --- DYNAMIC Y-LIMIT ---</span>
<span class="n">all_data_arrays</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">fr_ml_rs_e1</span><span class="p">,</span> <span class="n">fr_vns_rs_e1</span><span class="p">,</span> <span class="n">fr_ml_fs_e1</span><span class="p">,</span> <span class="n">fr_vns_fs_e1</span><span class="p">,</span>
    <span class="n">fr_ml_rs_e2</span><span class="p">,</span> <span class="n">fr_vns_rs_e2</span><span class="p">,</span> <span class="n">fr_ml_fs_e2</span><span class="p">,</span> <span class="n">fr_vns_fs_e2</span>
<span class="p">]</span>
<span class="n">global_max</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_data_arrays</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">global_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">global_max</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">global_max</span> <span class="o">*</span> <span class="mf">1.15</span><span class="p">)</span>

<span class="c1"># --- AESTHETICS ---</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span> 
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Statistical Results by Epoch ---
[RS Neurons (Early: 0-20 min)] Mann-Whitney U p-value: 0.1665
[FS Neurons (Early: 0-20 min)] Mann-Whitney U p-value: 0.0338
[RS Neurons (Late: 40-60 min)] Mann-Whitney U p-value: 0.0000
[FS Neurons (Late: 40-60 min)] Mann-Whitney U p-value: 0.9515
------------------------------------
</pre></div>
</div>
<img alt="_images/f70e8be68401d2e950d9f4aa921edbbf728c815fea9eaf949ea08c30d69d9cdc.png" src="_images/f70e8be68401d2e950d9f4aa921edbbf728c815fea9eaf949ea08c30d69d9cdc.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: The "Inhibition-First" Sequence</b><br>
    The epoch analysis confirms a specific temporal hand-off:
    <ul>
        <li><b>Early Phase (0-20 min):</b> <b>FS neurons</b> are significantly modulated (<i>p=0.0338</i>), while RS neurons remain indistinguishable from controls. This supports the hypothesis that VNS engages an initial "inhibitory brake."</li>
        <li><b>Late Phase (40-60 min):</b> The dynamic flips. FS modulation fades (<i>p=0.95</i>), while <b>RS neurons</b> show a highly significant divergence (<i>p<0.0001</i>), reflecting the long-term stabilization of excitatory output.</li>
    </ul>
    Given that VNS is delivered phasically upon successful reaches, we hypothesized that this early inhibitory recruitment is directly locked to the stimulation events. To test this, we next align firing rate trajectories to <b>individual success events</b> to visualize the immediate, acute modulation.
</div></section>
<section id="panel-f-success-aligned-trajectories">
<h2>Panel f (Success-aligned trajectories)<a class="headerlink" href="#panel-f-success-aligned-trajectories" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Mouse success times ---</span>
<span class="n">successes_by_mouse</span> <span class="o">=</span> <span class="p">{</span><span class="n">mouse</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;rMax_t&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                      <span class="k">for</span> <span class="n">mouse</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">df_reaches</span><span class="p">[</span><span class="n">df_reaches</span><span class="p">[</span><span class="s1">&#39;behaviors&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;success&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.multitest</span> <span class="kn">import</span> <span class="n">fdrcorrection</span>

<span class="c1"># --- 1. baseline firing rate calculation ---</span>
<span class="k">def</span> <span class="nf">baseline_firing_rate</span><span class="p">(</span><span class="n">spike_train</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="n">num_bins</span><span class="o">=</span><span class="mi">60</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate fraction of time the unit is present within an epoch.</span>
<span class="sd">    This version aggressively cleans the spike_train data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Ensure min/max are scalars</span>
        <span class="n">min_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">min_time</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">max_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">max_time</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: min_time or max_time are not scalar-like.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Not 0.0, this is a config error</span>
    
    <span class="c1"># Check for valid binning parameters</span>
    <span class="k">if</span> <span class="n">max_t</span> <span class="o">&lt;=</span> <span class="n">min_t</span> <span class="ow">or</span> <span class="n">num_bins</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="c1"># Config error</span>

    <span class="c1"># --- AGGRESSIVE DATA CLEANING ---</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1. Convert to numpy array, force float, force 1D</span>
        <span class="n">st_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">spike_train</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
        <span class="k">return</span> <span class="mf">0.0</span> <span class="c1"># No valid data</span>

    <span class="c1"># 2. Filter out non-finite values (NaNs, Infs)</span>
    <span class="n">st_data</span> <span class="o">=</span> <span class="n">st_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">st_data</span><span class="p">)]</span>
    
    <span class="c1"># 3. Check if any valid data remains</span>
    <span class="k">if</span> <span class="n">st_data</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span> <span class="c1"># No valid spikes</span>
            
    <span class="c1"># --- END CLEANING ---</span>

    <span class="c1"># 4. Now, call np.histogram with *only* clean data</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">st_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">num_bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">min_t</span><span class="p">,</span> <span class="n">max_t</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Internal histogram call failed despite cleaning: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
    <span class="c1"># 5. Calculate baseline firing rate</span>
    <span class="n">bfr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_bins</span>
    
    <span class="k">return</span> <span class="n">bfr</span>
    
<span class="c1"># --- 2. Helper functions for final metrics ---</span>
<span class="k">def</span> <span class="nf">get_last_non_nan</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the last non-NaN value from a 1D array.&quot;&quot;&quot;</span>
    <span class="n">non_nan_vals</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">non_nan_vals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_nan_vals</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="k">def</span> <span class="nf">get_trajectory_slope</span><span class="p">(</span><span class="n">delta_traj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a line to the delta_trajectory (skipping baseline) </span>
<span class="sd">    and returns the slope.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">delta_traj</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> 
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="n">y_valid</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        <span class="n">x_valid</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_valid</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_val</span><span class="p">,</span> <span class="n">p_val</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x_valid</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">slope</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 1 complete: Helper functions defined (with corrections).&quot;</span><span class="p">)</span>

<span class="c1"># --- 3. Calculate Baseline Firing Rate (0-120s) ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating baseline firing rate (fr_baseline) for all neurons...&quot;</span><span class="p">)</span>

<span class="c1"># Assume &#39;st&#39; (SpikeTrainArray) and &#39;df_zeta&#39; (DataFrame) are loaded</span>
<span class="n">baseline_epoch</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">120</span><span class="p">])</span>

<span class="c1"># Pass the array-like properties directly to the robust function</span>
<span class="n">min_time</span> <span class="o">=</span> <span class="n">baseline_epoch</span><span class="o">.</span><span class="n">start</span>
<span class="n">max_time</span> <span class="o">=</span> <span class="n">baseline_epoch</span><span class="o">.</span><span class="n">stop</span>

<span class="n">num_bins</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># 1-second bins for the 120-second epoch</span>

<span class="n">fr_baselines</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># 1. Restrict the *entire* SpikeTrainArray in time.</span>
<span class="c1"># This creates a new SpikeTrainArray.</span>
<span class="n">st_baseline</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">baseline_epoch</span><span class="p">]</span>

<span class="c1"># 2. Get the .data attribute, which is a *list* of np.arrays</span>
<span class="c1"># (one for each neuron, in order).</span>
<span class="n">restricted_spike_data_list</span> <span class="o">=</span> <span class="n">st_baseline</span><span class="o">.</span><span class="n">data</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">restricted_spike_data_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> neurons...&quot;</span><span class="p">)</span>

<span class="c1"># 3. Iterate the *list*, not the nelpy object.</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">restricted_spike_data_list</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Calculating FR&quot;</span><span class="p">):</span>
    <span class="n">spike_train_data</span> <span class="o">=</span> <span class="n">restricted_spike_data_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># Call the robust function</span>
    <span class="n">fr</span> <span class="o">=</span> <span class="n">baseline_firing_rate</span><span class="p">(</span><span class="n">spike_train_data</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="n">max_time</span><span class="p">,</span> <span class="n">num_bins</span><span class="p">)</span>
    <span class="n">fr_baselines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fr</span><span class="p">)</span>

<span class="c1"># --- 4. Add fr_baseline to df_zeta ---</span>
<span class="c1"># This assumes the order of st.data matches the order of df_zeta</span>
<span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fr_baselines</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 2 complete: &#39;fr_baseline&#39; column added to df_zeta.&quot;</span><span class="p">)</span>
<span class="c1"># print(df_zeta[[&#39;mouse&#39;, &#39;experiment&#39;, &#39;waveform_class&#39;, &#39;fr_baseline&#39;]].head())</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Distribution of &#39;fr_baseline&#39;:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
<span class="n">fr_median_threshold</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>

<span class="c1"># --- 5. Calculate Per-Neuron Trajectories (Raw and Delta) ---</span>

<span class="c1"># --- THESE ARE OUR CHANGES ---</span>
<span class="n">n_successes_to_track</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">analysis_window_size</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># From your code</span>

<span class="c1"># Assume &#39;successes_by_mouse&#39;, &#39;df_zeta&#39;, and &#39;st&#39; are pre-loaded</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating per-neuron trajectories for first </span><span class="si">{</span><span class="n">n_successes_to_track</span><span class="si">}</span><span class="s2"> successes...&quot;</span><span class="p">)</span>

<span class="n">per_neuron_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">]:</span>
        <span class="c1"># Get all neurons for this group and cell type</span>
        <span class="n">df_sub</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="p">[(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">)</span> <span class="o">&amp;</span>\
                 <span class="p">(</span><span class="n">df_zeta</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)]</span>
        
        <span class="c1"># Get the DataFrame indices (0-based)</span>
        <span class="n">df_indices</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> 
        
        <span class="c1"># Get the &#39;st&#39; indices (1-based, from your code)</span>
        <span class="n">st_indices</span> <span class="o">=</span> <span class="n">df_indices</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No neurons found for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rates_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>\
                    <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="n">baseline_epoch</span><span class="o">.</span><span class="n">duration</span> \
                         <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">st</span><span class="p">[:,</span> <span class="n">st_indices</span><span class="p">][</span><span class="n">baseline_epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">]</span>\
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during baseline calc for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rates_baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">st_indices</span><span class="p">))</span>
            
        <span class="c1"># Iterate through each neuron one by one</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_indices</span><span class="p">):</span>
            
            <span class="c1"># Get the &#39;st&#39; index for this neuron</span>
            <span class="n">neuron_st_index</span> <span class="o">=</span> <span class="n">st_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> 
            
            <span class="c1"># Get metadata for this neuron from the DataFrame using the df_index</span>
            <span class="n">neuron_meta</span> <span class="o">=</span> <span class="n">df_sub</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_index</span><span class="p">]</span>
            <span class="n">mouse_id</span> <span class="o">=</span> <span class="n">neuron_meta</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span>
            
            <span class="c1"># Get this specific mouse&#39;s success times</span>
            <span class="n">mouse_successes</span> <span class="o">=</span> <span class="n">successes_by_mouse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mouse_id</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>

            <span class="c1"># Create trajectory array (Baseline + N successes)</span>
            <span class="n">raw_trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_successes_to_track</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">raw_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rates_baseline</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># S0 is baseline</span>
            
            <span class="c1"># Loop from S1 to S(N)</span>
            <span class="k">for</span> <span class="n">success_n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_successes_to_track</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">success_n</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">mouse_successes</span><span class="p">):</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">mouse_successes</span><span class="p">[</span><span class="n">success_n</span><span class="p">]</span>
                    <span class="n">epoch</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="n">t</span><span class="p">,</span> <span class="n">t</span> <span class="o">+</span> <span class="n">analysis_window_size</span><span class="p">])</span>
                    
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">rate</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">st</span><span class="p">[:,</span> <span class="p">[</span><span class="n">neuron_st_index</span><span class="p">]][</span><span class="n">epoch</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">epoch</span><span class="o">.</span><span class="n">duration</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    
                    <span class="n">raw_trajectory</span><span class="p">[</span><span class="n">success_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span>
            
            <span class="c1"># --- Calculate Delta Trajectory Per Neuron ---</span>
            <span class="n">baseline_rate</span> <span class="o">=</span> <span class="n">raw_trajectory</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">baseline_rate</span><span class="p">):</span>
                <span class="n">delta_trajectory</span> <span class="o">=</span> <span class="n">raw_trajectory</span> <span class="o">-</span> <span class="n">baseline_rate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">delta_trajectory</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">raw_trajectory</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">per_neuron_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="c1"># We store the 0-based df_index, which is the</span>
                <span class="c1"># true unique ID for the neuron in df_zeta</span>
                <span class="s1">&#39;neuron_id&#39;</span><span class="p">:</span> <span class="n">df_index</span><span class="p">,</span> 
                <span class="s1">&#39;mouse_id&#39;</span><span class="p">:</span> <span class="n">mouse_id</span><span class="p">,</span> 
                <span class="s1">&#39;group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span> 
                <span class="s1">&#39;cell_type&#39;</span><span class="p">:</span> <span class="n">cell_type</span><span class="p">,</span>
                <span class="s1">&#39;fr_baseline&#39;</span><span class="p">:</span> <span class="n">neuron_meta</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">],</span>
                <span class="s1">&#39;raw_trajectory&#39;</span><span class="p">:</span> <span class="n">raw_trajectory</span><span class="p">,</span>
                <span class="s1">&#39;delta_trajectory&#39;</span><span class="p">:</span> <span class="n">delta_trajectory</span>
            <span class="p">})</span>

<span class="c1"># --- Create the DataFrame and SET THE INDEX ---</span>
<span class="n">df_neuron_trajectories</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">per_neuron_data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;neuron_id&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 3 complete: &#39;df_neuron_trajectories&#39; created.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_neuron_trajectories</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="c1"># --- 6. Calculate &#39;delta_final&#39; and &#39;trajectory_slope&#39; ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating final analysis metrics...&quot;</span><span class="p">)</span>

<span class="c1"># &#39;delta_final&#39; is the change after the LAST tracked success</span>
<span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;delta_final&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">get_last_non_nan</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="c1"># Get last non-nan delta, skipping baseline</span>
<span class="p">)</span>

<span class="c1"># &#39;trajectory_slope&#39; fits a line to the delta_trajectory</span>
<span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;trajectory_slope&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_trajectory_slope</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Step 4 complete: &#39;delta_final&#39; and &#39;trajectory_slope&#39; calculated.&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_neuron_trajectories</span><span class="p">[[</span><span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_type&#39;</span><span class="p">,</span> <span class="s1">&#39;fr_baseline&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_final&#39;</span><span class="p">,</span> <span class="s1">&#39;trajectory_slope&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step 5: Running Hierarchical Bootstrap (N=1000)...&quot;</span><span class="p">)</span>

<span class="c1"># --- 1. Define Parameters ---</span>
<span class="n">fr_threshold</span> <span class="o">=</span> <span class="n">fr_median_threshold</span>
<span class="n">metrics_to_test</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;trajectory_slope&#39;</span><span class="p">,</span> <span class="s1">&#39;delta_final&#39;</span><span class="p">]</span>
<span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">]</span>
<span class="n">N_BOOTSTRAPS</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># As you requested</span>
<span class="n">N_SAMPLES_PER_DIST</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Size of each inner bootstrapped distribution</span>

<span class="c1"># --- 2. Prepare the DataFrame ---</span>
<span class="n">df_analysis</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr_threshold</span><span class="p">,</span> 
    <span class="s1">&#39;low_fr&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;high_fr&#39;</span>
<span class="p">)</span>
<span class="n">df_analysis</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">metrics_to_test</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;fr_group&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse_id&#39;</span><span class="p">])</span>

<span class="c1"># --- 3. Helper function for hierarchical sampling ---</span>
<span class="k">def</span> <span class="nf">generate_hierarchical_sample</span><span class="p">(</span><span class="n">animals</span><span class="p">,</span> <span class="n">neuron_pool</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Faster implementation using list comprehension.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Pre-select all animals at once (Vectorized)</span>
    <span class="n">chosen_animals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">animals</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
    
    <span class="c1"># 2. List comprehension for the second stage</span>
    <span class="c1"># (Still iterates, but faster than a standard for-loop with append)</span>
    <span class="n">bootstrapped_dist</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">neuron_pool</span><span class="p">[</span><span class="n">animal</span><span class="p">])</span> <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">chosen_animals</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">bootstrapped_dist</span>

<span class="c1"># --- 4. Loop over all 8 comparisons ---</span>
<span class="n">results_bootstrap</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">fr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low_fr&#39;</span><span class="p">,</span> <span class="s1">&#39;high_fr&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics_to_test</span><span class="p">:</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bootstrapping: </span><span class="si">{</span><span class="n">fr_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            
            <span class="n">df_sub</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fr_name</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="p">]</span>
            
            <span class="c1"># --- Create data structures for fast sampling ---</span>
            <span class="n">ml_data</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">]</span>
            <span class="n">vns_data</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">]</span>

            <span class="n">ml_animals</span> <span class="o">=</span> <span class="n">ml_data</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">vns_animals</span> <span class="o">=</span> <span class="n">vns_data</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

            <span class="c1"># Check if we have data from both groups</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_animals</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">vns_animals</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping: Not enough animals in both groups.&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="c1"># Create a dict: {mouse_id: [val1, val2, ...]}</span>
            <span class="n">ml_neuron_pool</span> <span class="o">=</span> <span class="p">{</span><span class="n">mouse</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mouse</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">ml_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">)}</span>
            <span class="n">vns_neuron_pool</span> <span class="o">=</span> <span class="p">{</span><span class="n">mouse</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mouse</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">vns_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">)}</span>
            
            <span class="c1"># --- Run the N_BOOTSTRAPS ---</span>
            <span class="n">bootstrapped_median_diffs</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="c1"># Use tqdm for a progress bar</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_BOOTSTRAPS</span><span class="p">)):</span>
                
                <span class="c1"># Generate a resampled ML distribution</span>
                <span class="n">ml_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span>
                    <span class="n">ml_animals</span><span class="p">,</span> <span class="n">ml_neuron_pool</span><span class="p">,</span> <span class="n">N_SAMPLES_PER_DIST</span>
                <span class="p">)</span>
                
                <span class="c1"># Generate a resampled VNS distribution</span>
                <span class="n">vns_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span>
                    <span class="n">vns_animals</span><span class="p">,</span> <span class="n">vns_neuron_pool</span><span class="p">,</span> <span class="n">N_SAMPLES_PER_DIST</span>
                <span class="p">)</span>
                
                <span class="c1"># Calculate the test statistic (difference in medians)</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vns_dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ml_dist</span><span class="p">)</span>
                <span class="n">bootstrapped_median_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
            
            <span class="c1"># --- Calculate the final p-value ---</span>
            <span class="n">bootstrapped_median_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bootstrapped_median_diffs</span><span class="p">)</span>
            
            <span class="c1"># Find the proportion of the distribution that crosses 0</span>
            <span class="c1"># This is a two-tailed test</span>
            <span class="n">p_val_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_median_diffs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
            <span class="n">p_val_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_median_diffs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
            
            <span class="c1"># The two-tailed p-value is 2 * (the smaller one-tailed p-value)</span>
            <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p_val_pos</span><span class="p">,</span> <span class="n">p_val_neg</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
            
            <span class="n">results_bootstrap</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;FR_Group&#39;</span><span class="p">:</span> <span class="n">fr_name</span><span class="p">,</span>
                <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                <span class="s1">&#39;Cell_Type&#39;</span><span class="p">:</span> <span class="n">cell_type</span><span class="p">,</span>
                <span class="s1">&#39;N_Animals_ML&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ml_animals</span><span class="p">),</span>
                <span class="s1">&#39;N_Animals_VNS&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vns_animals</span><span class="p">),</span>
                <span class="s1">&#39;Median_of_Median_Diffs&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bootstrapped_median_diffs</span><span class="p">),</span>
                <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span>
            <span class="p">})</span>

<span class="c1"># --- 5. Display Results ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">--- HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS ---&quot;</span><span class="p">)</span>
<span class="n">df_bs_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_bootstrap</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_bs_results</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Hierarchical bootstrap analysis complete.&quot;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Step 6: Running Pointwise Hierarchical Bootstrap (S1-S25)...&quot;</span><span class="p">)</span>

<span class="c1"># --- 1. Define Parameters ---</span>
<span class="n">cell_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">]</span>
<span class="n">N_BOOTSTRAPS</span> <span class="o">=</span> <span class="mi">10000</span>  <span class="c1"># As you requested</span>
<span class="n">N_SAMPLES_PER_DIST</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1"># Size of each inner bootstrapped distribution</span>
<span class="n">n_successes_to_track</span> <span class="o">=</span> <span class="mi">25</span> <span class="c1"># Must match the trajectory data</span>

<span class="c1"># --- 2. Prepare the DataFrame ---</span>
<span class="n">df_analysis</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
    <span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr_threshold</span><span class="p">,</span> 
    <span class="s1">&#39;low_fr&#39;</span><span class="p">,</span> 
    <span class="s1">&#39;high_fr&#39;</span>
<span class="p">)</span>
<span class="n">df_analysis</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">,</span> <span class="s1">&#39;fr_group&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse_id&#39;</span><span class="p">])</span>

<span class="c1"># --- 3. Helper function for hierarchical sampling ---</span>
<span class="c1"># already defined above</span>

<span class="c1"># --- 4. Loop over all 4 comparisons ---</span>
<span class="n">results_pointwise</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">fr_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;low_fr&#39;</span><span class="p">,</span> <span class="s1">&#39;high_fr&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="n">cell_types</span><span class="p">:</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Bootstrapping: </span><span class="si">{</span><span class="n">fr_name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2"> ---&quot;</span><span class="p">)</span>
            
        <span class="n">df_sub</span> <span class="o">=</span> <span class="n">df_analysis</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;fr_group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fr_name</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_analysis</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span>
        <span class="p">]</span>
        
        <span class="c1"># --- Get base animal lists ---</span>
        <span class="n">ml_animals</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">][</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">vns_animals</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">][</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_animals</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">vns_animals</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping: Not enough animals in both groups.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="n">raw_p_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">median_diffs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># --- Loop S1 through S25 ---</span>
        <span class="k">for</span> <span class="n">s_n</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_successes_to_track</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Pointwise test&quot;</span><span class="p">):</span>
            
            <span class="c1"># --- Create data pools for *just* this success point (s_n) ---</span>
            <span class="n">ml_neuron_pool_sN</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mouse</span> <span class="ow">in</span> <span class="n">ml_animals</span><span class="p">:</span>
                <span class="c1"># Get all delta_FR values for this mouse at S_n</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mouse</span><span class="p">)</span>
                <span class="p">][</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">s_n</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">s_n</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                
                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ml_neuron_pool_sN</span><span class="p">[</span><span class="n">mouse</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>

            <span class="n">vns_neuron_pool_sN</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mouse</span> <span class="ow">in</span> <span class="n">vns_animals</span><span class="p">:</span>
                <span class="c1"># Get all delta_FR values for this mouse at S_n</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mouse</span><span class="p">)</span>
                <span class="p">][</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">s_n</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">s_n</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
                
                <span class="k">if</span> <span class="n">vals</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">vns_neuron_pool_sN</span><span class="p">[</span><span class="n">mouse</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
            
            <span class="c1"># Get animals that actually have data at this timepoint</span>
            <span class="n">ml_animals_sN</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ml_neuron_pool_sN</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">vns_animals_sN</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vns_neuron_pool_sN</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_animals_sN</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">vns_animals_sN</span><span class="p">:</span>
                <span class="n">raw_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="c1"># No data to compare</span>
                <span class="n">median_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">continue</span>
                
            <span class="c1"># --- Run the Bootstrap for this point (S_n) ---</span>
            <span class="n">bootstrapped_median_diffs_sN</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_BOOTSTRAPS</span><span class="p">):</span>
                <span class="n">ml_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span>
                    <span class="n">ml_animals_sN</span><span class="p">,</span> <span class="n">ml_neuron_pool_sN</span><span class="p">,</span> <span class="n">N_SAMPLES_PER_DIST</span>
                <span class="p">)</span>
                <span class="n">vns_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span>
                    <span class="n">vns_animals_sN</span><span class="p">,</span> <span class="n">vns_neuron_pool_sN</span><span class="p">,</span> <span class="n">N_SAMPLES_PER_DIST</span>
                <span class="p">)</span>
                <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vns_dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ml_dist</span><span class="p">)</span>
                <span class="n">bootstrapped_median_diffs_sN</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

            <span class="n">bootstrapped_median_diffs_sN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bootstrapped_median_diffs_sN</span><span class="p">)</span>
            <span class="n">median_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bootstrapped_median_diffs_sN</span><span class="p">))</span>
            
            <span class="c1"># Calculate two-tailed p-value for S_n</span>
            <span class="n">p_val_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_median_diffs_sN</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
            <span class="n">p_val_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_median_diffs_sN</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
            <span class="n">p_value_sN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p_val_pos</span><span class="p">,</span> <span class="n">p_val_neg</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">raw_p_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p_value_sN</span><span class="p">)</span>

        <span class="c1"># --- Now we have 25 p-values. Apply FDR correction. ---</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_p_values</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping FDR: No p-values generated.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="n">reject_fdr</span><span class="p">,</span> <span class="n">pvals_corrected</span> <span class="o">=</span> <span class="n">fdrcorrection</span><span class="p">(</span><span class="n">raw_p_values</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;indep&#39;</span><span class="p">)</span>
        
        <span class="n">results_pointwise</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;FR_Group&#39;</span><span class="p">:</span> <span class="n">fr_name</span><span class="p">,</span>
            <span class="s1">&#39;Cell_Type&#39;</span><span class="p">:</span> <span class="n">cell_type</span><span class="p">,</span>
            <span class="s1">&#39;N_Animals_ML&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ml_animals</span><span class="p">),</span>
            <span class="s1">&#39;N_Animals_VNS&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vns_animals</span><span class="p">),</span>
            <span class="s1">&#39;median_diffs_S1_S25&#39;</span><span class="p">:</span> <span class="n">median_diffs</span><span class="p">,</span>
            <span class="s1">&#39;raw_p_values_S1_S25&#39;</span><span class="p">:</span> <span class="n">raw_p_values</span><span class="p">,</span>
            <span class="s1">&#39;fdr_corrected_p_values_S1_S25&#39;</span><span class="p">:</span> <span class="n">pvals_corrected</span><span class="p">,</span>
            <span class="s1">&#39;significant_at_q_0.05&#39;</span><span class="p">:</span> <span class="n">reject_fdr</span>
        <span class="p">})</span>

<span class="c1"># --- 5. Display Results ---</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">--- POINTWISE HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS ---&quot;</span><span class="p">)</span>
<span class="n">df_pw_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_pointwise</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># To see the full lists</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Pointwise analysis complete. Results below...&quot;</span><span class="p">)</span>
<span class="n">df_pw_results</span><span class="p">[[</span><span class="s1">&#39;FR_Group&#39;</span><span class="p">,</span> <span class="s1">&#39;Cell_Type&#39;</span><span class="p">,</span> <span class="s1">&#39;N_Animals_ML&#39;</span><span class="p">,</span> <span class="s1">&#39;N_Animals_VNS&#39;</span><span class="p">,</span> <span class="s1">&#39;fdr_corrected_p_values_S1_S25&#39;</span><span class="p">,</span> <span class="s1">&#39;significant_at_q_0.05&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Step 1 complete: Helper functions defined (with corrections).
Calculating baseline firing rate (fr_baseline) for all neurons...
Processing 524 neurons...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Calculating FR: 100%|| 524/524 [00:00&lt;00:00, 40422.57it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Step 2 complete: &#39;fr_baseline&#39; column added to df_zeta.

Distribution of &#39;fr_baseline&#39;:
count    524.000000
mean       0.312961
std        0.316124
min        0.000000
25%        0.041667
50%        0.191667
75%        0.518750
max        1.000000
Name: fr_baseline, dtype: float64
Calculating per-neuron trajectories for first 25 successes...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Step 3 complete: &#39;df_neuron_trajectories&#39; created.
           mouse_id          group cell_type  fr_baseline  \
neuron_id                                                   
0              8307  motorlearning        rs     0.141667   
1              8307  motorlearning        rs     0.300000   
7              8307  motorlearning        rs     0.000000   
8              8307  motorlearning        rs     0.000000   
10             8307  motorlearning        rs     0.050000   

                                              raw_trajectory  \
neuron_id                                                      
0          [0.25, 0.1, 0.1, 0.2, 0.35, 0.1, 0.3, 0.9, 1.3...   
1          [0.8166666666666667, 0.0, 0.0, 0.0, 0.0, 0.0, ...   
7          [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...   
8          [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...   
10         [0.058333333333333334, 0.0, 0.05, 0.0, 0.0, 0....   

                                            delta_trajectory  
neuron_id                                                     
0          [0.0, -0.15, -0.15, -0.04999999999999999, 0.09...  
1          [0.0, -0.8166666666666667, -0.8166666666666667...  
7          [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...  
8          [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, ...  
10         [0.0, -0.058333333333333334, -0.00833333333333...  
Calculating final analysis metrics...
Step 4 complete: &#39;delta_final&#39; and &#39;trajectory_slope&#39; calculated.
                   group cell_type  fr_baseline  delta_final  trajectory_slope
neuron_id                                                                     
0          motorlearning        rs     0.141667    -0.250000         -0.004808
1          motorlearning        rs     0.300000    -0.566667          0.017962
7          motorlearning        rs     0.000000     0.000000          0.001231
8          motorlearning        rs     0.000000     0.050000          0.012731
10         motorlearning        rs     0.050000     1.691667          0.041885

Step 5: Running Hierarchical Bootstrap (N=1000)...

Bootstrapping: low_fr, rs, trajectory_slope...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1471.02it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: low_fr, rs, delta_final...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1462.64it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: low_fr, fs, trajectory_slope...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1475.63it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: low_fr, fs, delta_final...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1485.85it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: high_fr, rs, trajectory_slope...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1497.05it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: high_fr, rs, delta_final...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1500.20it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: high_fr, fs, trajectory_slope...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1484.02it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: high_fr, fs, delta_final...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 1000/1000 [00:00&lt;00:00, 1499.11it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS ---
  FR_Group            Metric Cell_Type  N_Animals_ML  N_Animals_VNS  \
0   low_fr  trajectory_slope        rs             5              4   
1   low_fr       delta_final        rs             5              4   
2   low_fr  trajectory_slope        fs             5              4   
3   low_fr       delta_final        fs             5              4   
4  high_fr  trajectory_slope        rs             5              4   
5  high_fr       delta_final        rs             5              4   
6  high_fr  trajectory_slope        fs             5              4   
7  high_fr       delta_final        fs             5              4   

   Median_of_Median_Diffs  p_value  
0               -0.025808    0.010  
1               -0.145833    0.630  
2                0.015490    0.202  
3                0.491667    0.296  
4                0.035529    0.002  
5                0.325000    0.150  
6               -0.108000    0.104  
7                0.100000    0.768  


Hierarchical bootstrap analysis complete.

Step 6: Running Pointwise Hierarchical Bootstrap (S1-S25)...

--- Bootstrapping: low_fr, rs ---
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pointwise test: 100%|| 25/25 [02:46&lt;00:00,  6.66s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Bootstrapping: low_fr, fs ---
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pointwise test: 100%|| 25/25 [02:45&lt;00:00,  6.64s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Bootstrapping: high_fr, rs ---
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pointwise test: 100%|| 25/25 [02:45&lt;00:00,  6.62s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Bootstrapping: high_fr, fs ---
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Pointwise test: 100%|| 25/25 [02:44&lt;00:00,  6.60s/it]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- POINTWISE HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS ---


Pointwise analysis complete. Results below...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FR_Group</th>
      <th>Cell_Type</th>
      <th>N_Animals_ML</th>
      <th>N_Animals_VNS</th>
      <th>fdr_corrected_p_values_S1_S25</th>
      <th>significant_at_q_0.05</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>low_fr</td>
      <td>rs</td>
      <td>5</td>
      <td>4</td>
      <td>[1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0]</td>
      <td>[False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False]</td>
    </tr>
    <tr>
      <th>1</th>
      <td>low_fr</td>
      <td>fs</td>
      <td>5</td>
      <td>4</td>
      <td>[0.0, 0.8784, 0.8582142857142857, 0.6575, 0.7661538461538461, 0.8784, 0.8784, 0.7661538461538461, 0.7661538461538461, 0.7661538461538461, 0.8784, 0.7661538461538461, 0.8784, 0.8784, 0.8784, 0.7661538461538461, 0.8784, 0.7661538461538461, 0.8784, 0.8784, 0.7661538461538461, 0.7661538461538461, 0.675, 0.8784, 0.7661538461538461]</td>
      <td>[True, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>high_fr</td>
      <td>rs</td>
      <td>5</td>
      <td>4</td>
      <td>[0.3433333333333333, 0.46875, 0.2909090909090909, 0.9868, 0.2909090909090909, 0.6367499999999999, 0.6595454545454545, 0.6595454545454545, 0.6808333333333333, 0.2909090909090909, 0.08666666666666667, 0.4936111111111111, 0.2909090909090909, 0.3067857142857143, 0.6808333333333333, 0.4936111111111111, 0.3067857142857143, 0.059, 0.0, 0.18857142857142856, 0.059, 0.059, 0.63, 0.059, 0.3067857142857143]</td>
      <td>[False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, False, True, False, False, False, False, False, False]</td>
    </tr>
    <tr>
      <th>3</th>
      <td>high_fr</td>
      <td>fs</td>
      <td>5</td>
      <td>4</td>
      <td>[0.80625, 0.5192307692307693, 0.6811764705882353, 0.5192307692307693, 0.1775, 0.008333333333333333, 0.6811764705882353, 0.35812499999999997, 0.057, 0.017499999999999998, 0.0, 0.0, 0.5192307692307693, 0.3214285714285714, 0.80625, 0.5666666666666668, 0.8526190476190476, 0.5666666666666668, 0.5192307692307693, 0.5192307692307693, 0.9708, 0.9002173913043479, 0.9379166666666667, 0.80625, 0.8877272727272727]</td>
      <td>[False, False, False, False, False, True, False, False, False, True, True, True, False, False, False, False, False, False, False, False, False, False, False, False, False]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_low_fr</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">fr_threshold</span><span class="p">]</span>
<span class="n">df_high_fr</span> <span class="o">=</span> <span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="n">df_neuron_trajectories</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">fr_threshold</span><span class="p">]</span>
<span class="n">fr_group_lo</span> <span class="o">=</span> <span class="s1">&#39;low_fr&#39;</span>
<span class="n">fr_group_hi</span> <span class="o">=</span> <span class="s1">&#39;high_fr&#39;</span>

<span class="k">def</span> <span class="nf">get_plot_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">group</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filters df and calculates per-animal averages.&quot;&quot;&quot;</span>
    <span class="n">df_neuron_sub</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;cell_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">)]</span>
    <span class="n">per_animal_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">df_neuron_sub</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">mouse_id</span> <span class="ow">in</span> <span class="n">df_neuron_sub</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">mouse_df</span> <span class="o">=</span> <span class="n">df_neuron_sub</span><span class="p">[</span><span class="n">df_neuron_sub</span><span class="p">[</span><span class="s1">&#39;mouse_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">mouse_id</span><span class="p">]</span>
            <span class="c1"># Handle potential all-NaN slices</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mean_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">mouse_df</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">mean_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_successes_to_track</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">per_animal_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_traj</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">per_animal_list</span><span class="p">,</span> <span class="n">df_neuron_sub</span>

<span class="k">def</span> <span class="nf">get_both_pvals</span><span class="p">(</span><span class="n">fr_group_str</span><span class="p">,</span> <span class="n">cell_type_str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the list of FDR-corrected pointwise p-values from df_pw_results</span>
<span class="sd">    AND the overall slope p-value from df_bs_results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get Pointwise p-values</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p_val_list</span> <span class="o">=</span> <span class="n">df_pw_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_pw_results</span><span class="p">[</span><span class="s1">&#39;FR_Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fr_group_str</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_pw_results</span><span class="p">[</span><span class="s1">&#39;Cell_Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type_str</span><span class="p">),</span>
            <span class="s1">&#39;fdr_corrected_p_values_S1_S25&#39;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pointwise_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">p_val_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pointwise_pvals</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n_successes_to_track</span><span class="p">,):</span>
             <span class="n">pointwise_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_successes_to_track</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Fallback</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="n">pointwise_pvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_successes_to_track</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span> <span class="c1"># Fallback</span>

    <span class="c1"># Get Overall Slope p-value</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">slope_p</span> <span class="o">=</span> <span class="n">df_bs_results</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_bs_results</span><span class="p">[</span><span class="s1">&#39;FR_Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">fr_group_str</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_bs_results</span><span class="p">[</span><span class="s1">&#39;Metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;trajectory_slope&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df_bs_results</span><span class="p">[</span><span class="s1">&#39;Cell_Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type_str</span><span class="p">)</span>
        <span class="p">][</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="n">slope_p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># Fallback</span>

    <span class="k">return</span> <span class="n">pointwise_pvals</span><span class="p">,</span> <span class="n">slope_p</span>
    
<span class="k">def</span> <span class="nf">p_to_stars</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts a p-value to a significance string.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;***&#39;</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;**&#39;</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="k">return</span> <span class="s1">&#39;*&#39;</span>
    <span class="k">return</span> <span class="s1">&#39;ns&#39;</span> <span class="c1"># Not significant</span>

<span class="k">def</span> <span class="nf">draw_sig_bracket</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Draws a significance bracket with text.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">text</span> <span class="o">==</span> <span class="s1">&#39;ns&#39;</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">h</span><span class="p">):</span> <span class="k">return</span> <span class="c1"># Add nan check</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">y</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.2</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">x1</span> <span class="o">+</span> <span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">plot_mean_comparison_pointwise</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">neuron_data_vns</span><span class="p">,</span> <span class="n">neuron_data_ml</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">pointwise_p_vals</span><span class="p">,</span> <span class="n">overall_slope_p_val</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the weighted mean trajectories, adds POINTWISE significance BARS,</span>
<span class="sd">    and adds overall SLOPE significance stars.</span>
<span class="sd">    MODIFIED: Removed title.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_points</span> <span class="o">=</span> <span class="n">n_successes_to_track</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Baseline + N successes</span>
    <span class="n">x_axis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_points</span><span class="p">)</span>

    <span class="n">has_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">vns_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">ml_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="c1"># Plot VNS mean trace</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">neuron_data_vns</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">vns_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">neuron_data_vns</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">vns_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">vns_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">vns_mean</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">],</span>
                 <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;PairedVNS&#39;</span><span class="p">)</span>
        <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Plot ML mean trace</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">neuron_data_ml</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="n">ml_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">neuron_data_ml</span><span class="p">[</span><span class="s1">&#39;delta_trajectory&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ml_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ml_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_axis</span><span class="p">,</span> <span class="n">ml_mean</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">],</span>
                 <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mec</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Motorlearning&#39;</span><span class="p">)</span>
        <span class="n">has_data</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">has_data</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;No Data&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># ax.set_title(title) # &lt;--- MODIFICATION: Removed title</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_axis</span><span class="p">[::</span><span class="mi">5</span><span class="p">])</span> <span class="c1"># Only label every 5th tick</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;n&quot;</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">x_axis</span><span class="p">[::</span><span class="mi">5</span><span class="p">]])</span>
    <span class="n">ticks_to_show</span> <span class="o">=</span> <span class="n">x_axis</span><span class="p">[::</span><span class="mi">5</span><span class="p">]</span>  <span class="c1"># This will be [0, 5, 10, 15, 20, 25]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks_to_show</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">ticks_to_show</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">n_points</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># --- ADD POINTWISE SIGNIFICANCE BARS ---</span>
    <span class="k">if</span> <span class="n">pointwise_p_vals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">pointwise_p_vals</span><span class="p">)</span> <span class="o">==</span> <span class="n">n_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Get max y-value for positioning the bar</span>
        <span class="n">all_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vns_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">ml_mean</span><span class="p">[</span><span class="mi">1</span><span class="p">:]])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">all_y</span><span class="p">)):</span> <span class="c1"># Check if all values are NaN</span>
             <span class="n">y_max_data</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Default if no data</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="n">y_max_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">all_y</span><span class="p">)</span>

        <span class="n">y_range</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">y_range</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">y_range</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Handle flat lines or no range</span>

        <span class="c1"># Position bar slightly above the max data point</span>
        <span class="n">y_bar_pos</span> <span class="o">=</span> <span class="n">y_max_data</span> <span class="o">+</span> <span class="n">y_range</span> <span class="o">*</span> <span class="mf">0.05</span>
        <span class="n">bar_height</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="mf">0.01</span> <span class="c1"># Smaller height for caps</span>
        <span class="n">star_offset</span> <span class="o">=</span> <span class="n">y_range</span> <span class="o">*</span> <span class="mf">0.02</span> <span class="c1"># Offset for stars above bar</span>

        <span class="c1"># Find significant indices (S1, S2, ...) based on p &lt; 0.05</span>
        <span class="n">p_val_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">pointwise_p_vals</span><span class="p">)</span>
        <span class="n">significant_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">p_val_array</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">significant_indices</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Find contiguous blocks</span>
            <span class="n">blocks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">current_block</span> <span class="o">=</span> <span class="p">[</span><span class="n">significant_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">significant_indices</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">significant_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">significant_indices</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">current_block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">significant_indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">)</span>
                    <span class="n">current_block</span> <span class="o">=</span> <span class="p">[</span><span class="n">significant_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="n">blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_block</span><span class="p">)</span> <span class="c1"># Add the last block</span>

            <span class="c1"># Draw a bar and add stars for each block</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
                <span class="n">start_point</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">end_point</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># Draw main horizontal line</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start_point</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">end_point</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="n">y_bar_pos</span><span class="p">,</span> <span class="n">y_bar_pos</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
                <span class="c1"># Draw start cap</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start_point</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">start_point</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="n">y_bar_pos</span> <span class="o">-</span> <span class="n">bar_height</span><span class="p">,</span> <span class="n">y_bar_pos</span> <span class="o">+</span> <span class="n">bar_height</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="p">)</span>
                <span class="c1"># Draw end cap</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">end_point</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">end_point</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">],</span> <span class="p">[</span><span class="n">y_bar_pos</span> <span class="o">-</span> <span class="n">bar_height</span><span class="p">,</span> <span class="n">y_bar_pos</span> <span class="o">+</span> <span class="n">bar_height</span><span class="p">],</span>
                         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,)</span>

                <span class="c1"># --- ADD STARS ---</span>
                <span class="c1"># Find the minimum p-value within this block&#39;s indices</span>
                <span class="n">min_p_in_block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">p_val_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">star_str</span> <span class="o">=</span> <span class="n">p_to_stars</span><span class="p">(</span><span class="n">min_p_in_block</span><span class="p">)</span>
                <span class="c1"># Center the stars above the middle of the bar</span>
                <span class="n">center_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">start_point</span> <span class="o">+</span> <span class="n">end_point</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">y_bar_pos</span> <span class="o">+</span> <span class="n">star_offset</span><span class="p">,</span> <span class="n">star_str</span><span class="p">,</span>
                         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

    <span class="c1"># --- ADD OVERALL SLOPE SIGNIFICANCE ---</span>
    <span class="k">if</span> <span class="n">overall_slope_p_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slope_star_str</span> <span class="o">=</span> <span class="n">p_to_stars</span><span class="p">(</span><span class="n">overall_slope_p_val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slope_star_str</span><span class="p">:</span> <span class="c1"># Only add text if significant</span>
            <span class="c1"># Position in the top-right corner</span>
            <span class="n">ax_ymin</span><span class="p">,</span> <span class="n">ax_ymax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
            <span class="n">y_pos_slope</span> <span class="o">=</span> <span class="n">ax_ymax</span> <span class="o">-</span> <span class="n">y_range</span> <span class="o">*</span> <span class="mf">0.05</span>
            <span class="n">x_pos_slope</span> <span class="o">=</span> <span class="p">(</span><span class="n">n_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.95</span> <span class="c1"># Near the right edge</span>
            <span class="k">if</span><span class="p">(</span><span class="n">slope_star_str</span> <span class="ow">is</span> <span class="ow">not</span> <span class="s2">&quot;ns&quot;</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">y_pos_slope</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;trajectory slope: </span><span class="si">{</span><span class="n">slope_star_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span> <span class="c1"># Red to distinguish</span>


<span class="c1"># ======================================================================</span>
<span class="c1"># --- GENERATE FIGURE 1: Mean Trajectory Comparisons (2x2) ---</span>
<span class="c1"># ======================================================================</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Generating Mean Comparison plot (2x2)...&quot;</span><span class="p">)</span>

<span class="c1"># --- Create a 2x2 figure, sharing Y-axis ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">3.8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;wspace&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span><span class="mf">0.06</span><span class="p">})</span>

<span class="c1"># --- Plot [0, 0]: RS, Low PR ---</span>
<span class="n">pa_rs_vns_lo</span><span class="p">,</span> <span class="n">dn_rs_vns_lo</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_low_fr</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span>
<span class="n">pa_rs_ml_lo</span><span class="p">,</span> <span class="n">dn_rs_ml_lo</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_low_fr</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span>
<span class="n">pvals_pw_rs_lo</span><span class="p">,</span> <span class="n">pval_slope_rs_lo</span> <span class="o">=</span> <span class="n">get_both_pvals</span><span class="p">(</span><span class="n">fr_group_lo</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">)</span>
<span class="n">plot_mean_comparison_pointwise</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dn_rs_vns_lo</span><span class="p">,</span> <span class="n">dn_rs_ml_lo</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">,</span> <span class="n">pvals_pw_rs_lo</span><span class="p">,</span> <span class="n">pval_slope_rs_lo</span><span class="p">)</span>
<span class="c1"># axes[0, 0].set_title(&quot;Low PR&quot;, fontsize=10) # &lt;-- REMOVED</span>

<span class="c1"># --- Plot [0, 1]: RS, High PR ---</span>
<span class="n">pa_rs_vns_hi</span><span class="p">,</span> <span class="n">dn_rs_vns_hi</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_high_fr</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span>
<span class="n">pa_rs_ml_hi</span><span class="p">,</span> <span class="n">dn_rs_ml_hi</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_high_fr</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span>
<span class="n">pvals_pw_rs_hi</span><span class="p">,</span> <span class="n">pval_slope_rs_hi</span> <span class="o">=</span> <span class="n">get_both_pvals</span><span class="p">(</span><span class="n">fr_group_hi</span><span class="p">,</span> <span class="s1">&#39;rs&#39;</span><span class="p">)</span>
<span class="n">plot_mean_comparison_pointwise</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dn_rs_vns_hi</span><span class="p">,</span> <span class="n">dn_rs_ml_hi</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">,</span> <span class="n">pvals_pw_rs_hi</span><span class="p">,</span> <span class="n">pval_slope_rs_hi</span><span class="p">)</span>
<span class="c1"># axes[0, 1].set_title(&quot;High PR&quot;, fontsize=10) # &lt;-- REMOVED</span>

<span class="c1"># --- Plot [1, 0]: FS, Low PR ---</span>
<span class="n">pa_fs_vns_lo</span><span class="p">,</span> <span class="n">dn_fs_vns_lo</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_low_fr</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span>
<span class="n">pa_fs_ml_lo</span><span class="p">,</span> <span class="n">dn_fs_ml_lo</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_low_fr</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span>
<span class="n">pvals_pw_fs_lo</span><span class="p">,</span> <span class="n">pval_slope_fs_lo</span> <span class="o">=</span> <span class="n">get_both_pvals</span><span class="p">(</span><span class="n">fr_group_lo</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">)</span>
<span class="n">plot_mean_comparison_pointwise</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dn_fs_vns_lo</span><span class="p">,</span> <span class="n">dn_fs_ml_lo</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">,</span> <span class="n">pvals_pw_fs_lo</span><span class="p">,</span> <span class="n">pval_slope_fs_lo</span><span class="p">)</span>

<span class="c1"># --- Plot [1, 1]: FS, High PR ---</span>
<span class="n">pa_fs_vns_hi</span><span class="p">,</span> <span class="n">dn_fs_vns_hi</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_high_fr</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span>
<span class="n">pa_fs_ml_hi</span><span class="p">,</span> <span class="n">dn_fs_ml_hi</span> <span class="o">=</span> <span class="n">get_plot_data</span><span class="p">(</span><span class="n">df_high_fr</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span>
<span class="n">pvals_pw_fs_hi</span><span class="p">,</span> <span class="n">pval_slope_fs_hi</span> <span class="o">=</span> <span class="n">get_both_pvals</span><span class="p">(</span><span class="n">fr_group_hi</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">)</span>
<span class="n">plot_mean_comparison_pointwise</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">dn_fs_vns_hi</span><span class="p">,</span> <span class="n">dn_fs_ml_hi</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">,</span> <span class="n">pvals_pw_fs_hi</span><span class="p">,</span> <span class="n">pval_slope_fs_hi</span><span class="p">)</span>

<span class="c1"># --- Aesthetics ---</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;RS</span><span class="se">\n</span><span class="s2">FR (Hz)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;FS</span><span class="se">\n</span><span class="s2">FR (Hz)&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># --- Remove x-axis elements from the top row (RS neurons) ---</span>
<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]:</span> <span class="c1"># Targets axes[0, 0] and axes[0, 1]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>            <span class="c1"># Remove x-label</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>       <span class="c1"># Remove x-tick labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Remove x-ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;bottom&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Hide the x-axis line</span>

<span class="c1"># --- START OF MODIFICATION ---</span>
<span class="c1"># Add rotated column labels under the bottom plots</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;Low PR&quot;</span><span class="p">,</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span> 
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s2">&quot;High PR&quot;</span><span class="p">,</span> 
                    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span> 
                    <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> 
                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> 
                    <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="c1"># Add central x-label</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">rect</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">])</span> <span class="c1"># Leave 10% space at bottom</span>
<span class="n">fig</span><span class="o">.</span><span class="n">supxlabel</span><span class="p">(</span><span class="s2">&quot;Success number&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">y</span><span class="o">=-</span><span class="mf">0.12</span><span class="p">)</span> <span class="c1"># Position label at 1% from bottom</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Plot generation complete for Mean Comparison (2x2).&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Generating Mean Comparison plot (2x2)...
</pre></div>
</div>
<img alt="_images/583123e9ea09781e3679150b2f2b65d3612acd39a4097518d84ede92a4875305.png" src="_images/583123e9ea09781e3679150b2f2b65d3612acd39a4097518d84ede92a4875305.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Plot generation complete for Mean Comparison (2x2).
</pre></div>
</div>
</div>
</div>
<div class="alert alert-block alert-success">
    <b> Mechanistic Insight: Success-Locked Gain Control</b><br>
    The success-aligned analysis reveals the precise temporal logic of VNS-driven modulation:
    <ul>
        <li><b>Acute "Inhibitory Brake":</b> VNS triggers an immediate, success-locked increase in <b>FS neuron</b> firing. This effect is most prominent in Low-FR FS neurons right at the first success (S1), confirming a rapid, phasic recruitment of inhibition.</li>
        <li><b>Stabilization of Excitatory Output:</b> In Motor Learning controls, Low-FR <b>RS neurons</b> exhibit a progressive "run-up" in firing rate, a signature of demyelination-induced hyperexcitability. Paired VNS significantly flattens this trajectory (<i>p=0.022</i>), effectively clamping cortical gain.</li>
        <li><b>Prevention of Runaway Excitation:</b> By engaging this phasic inhibition, VNS prevents the pathologic conversion of neurons from a Low-FR to a High-FR state (<i>p=0.0001</i>; see Extended Data Fig. 6b).</li>
    </ul>
    <b>Conclusion:</b> Paired VNS does not simply "boost" activity; it engages a precise, success-locked inhibitory mechanism to constrain the hyperexcitability inherent to the demyelinated cortex, thereby creating a stable network state for motor relearning.
</div></section>
<section id="extended-data-figure">
<h2>Extended Data Figure<a class="headerlink" href="#extended-data-figure" title="Permalink to this heading">#</a></h2>
<section id="id1">
<h3>Panel a<a class="headerlink" href="#id1" title="Permalink to this heading">#</a></h3>
</section>
<section id="panel-b">
<h3>Panel b<a class="headerlink" href="#panel-b" title="Permalink to this heading">#</a></h3>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># =============================================================================</span>
<span class="c1"># 1. SETUP &amp; PARAMETERS</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Using the 20-second window from your trajectory code</span>
<span class="n">analysis_window_size</span> <span class="o">=</span> <span class="mi">20</span> 
<span class="n">n_successes_to_track</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">final_success_index</span> <span class="o">=</span> <span class="n">n_successes_to_track</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># 24 (0-based)</span>

<span class="c1"># (Assumes fr_threshold is already defined from Panel F)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using Baseline FR Threshold: </span><span class="si">{</span><span class="n">fr_threshold</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>

<span class="c1"># =============================================================================</span>
<span class="c1"># 2. CALCULATE FINAL FIRING RATE &amp; IDENTIFY SWAPS</span>
<span class="c1"># =============================================================================</span>
<span class="n">fr_swap_data</span> <span class="o">=</span> <span class="p">[]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating &#39;fr_final&#39; for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df_zeta</span><span class="p">)</span><span class="si">}</span><span class="s2"> neurons...&quot;</span><span class="p">)</span>

<span class="c1"># Iterate through all neurons</span>
<span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">neuron</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df_zeta</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_zeta</span><span class="p">)):</span>
    
    <span class="c1"># Get metadata</span>
    <span class="n">mouse_id</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span>
    <span class="n">neuron_st_index</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># 1-based indexing for SpikeTrainArray</span>
    
    <span class="c1"># Get this mouse&#39;s success times</span>
    <span class="n">mouse_successes</span> <span class="o">=</span> <span class="n">successes_by_mouse</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mouse_id</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
    
    <span class="c1"># Default values</span>
    <span class="n">fr_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">is_low_to_high</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">is_high_to_low</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="c1"># Check if this mouse reached the 25th success</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mouse_successes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">final_success_index</span><span class="p">:</span>
        <span class="n">t_final</span> <span class="o">=</span> <span class="n">mouse_successes</span><span class="p">[</span><span class="n">final_success_index</span><span class="p">]</span>
        
        <span class="c1"># Define the final 20-second epoch</span>
        <span class="n">epoch_final</span> <span class="o">=</span> <span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([</span><span class="n">t_final</span><span class="p">,</span> <span class="n">t_final</span> <span class="o">+</span> <span class="n">analysis_window_size</span><span class="p">])</span>
        
        <span class="c1"># Calculate Final Firing Rate (Hz)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">spike_data</span> <span class="o">=</span> <span class="n">st</span><span class="p">[:,</span> <span class="p">[</span><span class="n">neuron_st_index</span><span class="p">]][</span><span class="n">epoch_final</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Rate = Count / Duration</span>
            <span class="n">fr_final</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">spike_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">analysis_window_size</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Handle errors (e.g., if neuron index is out of bounds)</span>
            <span class="c1"># print(f&quot;Warning: Could not get spike data for neuron {idx}. Error: {e}&quot;)</span>
            <span class="n">fr_final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1"># Retrieve the Baseline FR (calculated in Panel F)</span>
    <span class="n">fr_baseline</span> <span class="o">=</span> <span class="n">neuron</span><span class="p">[</span><span class="s1">&#39;fr_baseline&#39;</span><span class="p">]</span>
    
    <span class="c1"># Check for Swaps (Low-&gt;High or High-&gt;Low)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fr_baseline</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fr_final</span><span class="p">):</span>
        <span class="c1"># Classify based on the global median threshold</span>
        <span class="n">initial_group</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span> <span class="k">if</span> <span class="n">fr_baseline</span> <span class="o">&lt;=</span> <span class="n">fr_threshold</span> <span class="k">else</span> <span class="s1">&#39;high&#39;</span>
        <span class="n">final_group</span> <span class="o">=</span> <span class="s1">&#39;low&#39;</span> <span class="k">if</span> <span class="n">fr_final</span> <span class="o">&lt;=</span> <span class="n">fr_threshold</span> <span class="k">else</span> <span class="s1">&#39;high&#39;</span>
        
        <span class="c1"># Define swap flags</span>
        <span class="n">is_low_to_high</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">initial_group</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span> <span class="ow">and</span> <span class="n">final_group</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">is_high_to_low</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="p">(</span><span class="n">initial_group</span> <span class="o">==</span> <span class="s1">&#39;high&#39;</span> <span class="ow">and</span> <span class="n">final_group</span> <span class="o">==</span> <span class="s1">&#39;low&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">fr_swap_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s1">&#39;neuron_id&#39;</span><span class="p">:</span> <span class="n">idx</span><span class="p">,</span> <span class="c1"># Index matches df_zeta</span>
        <span class="s1">&#39;fr_final&#39;</span><span class="p">:</span> <span class="n">fr_final</span><span class="p">,</span>
        <span class="s1">&#39;is_low_to_high&#39;</span><span class="p">:</span> <span class="n">is_low_to_high</span><span class="p">,</span>
        <span class="s1">&#39;is_high_to_low&#39;</span><span class="p">:</span> <span class="n">is_high_to_low</span>
    <span class="p">})</span>

<span class="c1"># Add new columns to a copy of the dataframe for analysis</span>
<span class="n">df_fr_swap_analysis</span> <span class="o">=</span> <span class="n">df_zeta</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fr_swap_data</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;neuron_id&#39;</span><span class="p">)</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Neuron FR swapping calculated.&quot;</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># 3. STATISTICAL ANALYSIS (Hierarchical Bootstrap)</span>
<span class="c1"># =============================================================================</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Running Hierarchical Bootstrap on FR Swapping...&quot;</span><span class="p">)</span>
<span class="n">N_BOOTSTRAPS</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># Drop rows with missing critical data</span>
<span class="n">df_analysis_swap</span> <span class="o">=</span> <span class="n">df_fr_swap_analysis</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
    <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;is_low_to_high&#39;</span><span class="p">,</span> <span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">,</span> <span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># Reuse the helper function from Panel F</span>
<span class="c1"># def generate_hierarchical_sample(...) assumed to be in memory</span>

<span class="n">results_bootstrap_swap</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Loop over Cell Types (RS, FS) and Metric Types (Low-&gt;High, High-&gt;Low)</span>
<span class="k">for</span> <span class="n">cell_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="s1">&#39;fs&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">metric_label</span><span class="p">,</span> <span class="n">metric_col</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">&#39;Low-to-High&#39;</span><span class="p">,</span> <span class="s1">&#39;is_low_to_high&#39;</span><span class="p">),</span> 
                                     <span class="p">(</span><span class="s1">&#39;High-to-Low&#39;</span><span class="p">,</span> <span class="s1">&#39;is_high_to_low&#39;</span><span class="p">)]:</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Bootstrapping </span><span class="si">{</span><span class="n">metric_label</span><span class="si">}</span><span class="s2"> proportion: </span><span class="si">{</span><span class="n">cell_type</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
        
        <span class="c1"># Filter for Cell Type</span>
        <span class="n">df_sub</span> <span class="o">=</span> <span class="n">df_analysis_swap</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df_analysis_swap</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Split by Group</span>
        <span class="n">ml_data</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">]</span>
        <span class="n">vns_data</span> <span class="o">=</span> <span class="n">df_sub</span><span class="p">[</span><span class="n">df_sub</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">]</span>

        <span class="n">ml_animals</span> <span class="o">=</span> <span class="n">ml_data</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">vns_animals</span> <span class="o">=</span> <span class="n">vns_data</span><span class="p">[</span><span class="s1">&#39;mouse&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        
        <span class="n">n_ml_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ml_data</span><span class="p">)</span>   
        <span class="n">n_vns_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vns_data</span><span class="p">)</span> 

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_animals</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">vns_animals</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="n">n_ml_total</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">n_vns_total</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping: Not enough animals or neurons.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="c1"># Create Pools: {mouse_id: [0, 1, 0...]}</span>
        <span class="n">ml_neuron_pool</span> <span class="o">=</span> <span class="p">{</span><span class="n">mouse</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mouse</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">ml_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">)}</span>
        <span class="n">vns_neuron_pool</span> <span class="o">=</span> <span class="p">{</span><span class="n">mouse</span><span class="p">:</span> <span class="n">group</span><span class="p">[</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">for</span> <span class="n">mouse</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">vns_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;mouse&#39;</span><span class="p">)}</span>

        <span class="c1"># Run Bootstrap</span>
        <span class="n">bootstrapped_mean_diffs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">N_BOOTSTRAPS</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Bootstrapping&quot;</span><span class="p">):</span>
            <span class="c1"># Resample ML</span>
            <span class="n">ml_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span><span class="n">ml_animals</span><span class="p">,</span> <span class="n">ml_neuron_pool</span><span class="p">,</span> <span class="n">n_ml_total</span><span class="p">)</span>
            <span class="c1"># Resample VNS</span>
            <span class="n">vns_dist</span> <span class="o">=</span> <span class="n">generate_hierarchical_sample</span><span class="p">(</span><span class="n">vns_animals</span><span class="p">,</span> <span class="n">vns_neuron_pool</span><span class="p">,</span> <span class="n">n_vns_total</span><span class="p">)</span>
            
            <span class="c1"># Calculate difference in Proportions (Means of 0/1s)</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vns_dist</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ml_dist</span><span class="p">)</span>
            <span class="n">bootstrapped_mean_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

        <span class="c1"># Calculate Statistics</span>
        <span class="n">bootstrapped_mean_diffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bootstrapped_mean_diffs</span><span class="p">)</span>
        <span class="n">p_val_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_mean_diffs</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
        <span class="n">p_val_neg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bootstrapped_mean_diffs</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">N_BOOTSTRAPS</span>
        <span class="n">p_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">p_val_pos</span><span class="p">,</span> <span class="n">p_val_neg</span><span class="p">])</span> <span class="o">*</span> <span class="mi">2</span>
        
        <span class="n">results_bootstrap_swap</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">metric_label</span><span class="p">,</span>
            <span class="s1">&#39;Cell_Type&#39;</span><span class="p">:</span> <span class="n">cell_type</span><span class="p">,</span>
            <span class="s1">&#39;N_Animals_ML&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ml_animals</span><span class="p">),</span>
            <span class="s1">&#39;N_Animals_VNS&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">vns_animals</span><span class="p">),</span>
            <span class="s1">&#39;p_value&#39;</span><span class="p">:</span> <span class="n">p_value</span>
        <span class="p">})</span>

<span class="c1"># Display Results</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">--- HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS (FR Swapping) ---&quot;</span><span class="p">)</span>
<span class="n">df_bs_results_swap</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">results_bootstrap_swap</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_bs_results_swap</span><span class="p">)</span>


<span class="c1"># =============================================================================</span>
<span class="c1"># 4. PLOTTING</span>
<span class="c1"># =============================================================================</span>
<span class="c1"># Helper function for a single subplot</span>
<span class="k">def</span> <span class="nf">plot_swap_subplot</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">cell_type</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">animal_prop_data</span><span class="p">,</span> <span class="n">df_bs_results</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots a single subplot for RS or FS neuron FR swapping.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sub_categories</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;LowToHigh_Prop&#39;</span><span class="p">,</span> <span class="s1">&#39;Low-to-High&#39;</span><span class="p">,</span> <span class="s1">&#39;Low-to-High&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;HighToLow_Prop&#39;</span><span class="p">,</span> <span class="s1">&#39;High-to-Low&#39;</span><span class="p">,</span> <span class="s1">&#39;High-to-Low&#39;</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="n">x_base_positions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">]</span>
    <span class="n">x_tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Low-to-High&#39;</span><span class="p">,</span> <span class="s1">&#39;High-to-Low&#39;</span><span class="p">]</span> 
    <span class="n">bar_width</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="n">overall_max_y</span> <span class="o">=</span> <span class="mi">0</span> 

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_label</span><span class="p">,</span> <span class="n">tick_label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_categories</span><span class="p">):</span>
        <span class="n">x_base</span> <span class="o">=</span> <span class="n">x_base_positions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">x_pos_ml</span> <span class="o">=</span> <span class="n">x_base</span> <span class="o">-</span> <span class="n">bar_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">x_pos_vns</span> <span class="o">=</span> <span class="n">x_base</span> <span class="o">+</span> <span class="n">bar_width</span> <span class="o">/</span> <span class="mi">2</span>
        
        <span class="c1"># Get Per-Animal Proportions</span>
        <span class="n">ml_props</span> <span class="o">=</span> <span class="n">animal_prop_data</span><span class="p">[</span>
            <span class="p">(</span><span class="n">animal_prop_data</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;motorlearning&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">animal_prop_data</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span> 
        <span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        
        <span class="n">vns_props</span> <span class="o">=</span> <span class="n">animal_prop_data</span><span class="p">[</span>
            <span class="p">(</span><span class="n">animal_prop_data</span><span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pairedVNS&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">animal_prop_data</span><span class="p">[</span><span class="s1">&#39;waveform_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span>
        <span class="p">][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="c1"># Stats for bars</span>
        <span class="n">ml_mean</span> <span class="o">=</span> <span class="n">ml_props</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_props</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">vns_mean</span> <span class="o">=</span> <span class="n">vns_props</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">vns_props</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">ml_sem</span> <span class="o">=</span> <span class="n">ml_props</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ml_props</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="n">vns_sem</span> <span class="o">=</span> <span class="n">vns_props</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">vns_props</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="mi">0</span>

        <span class="c1"># Draw Bars</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_pos_ml</span><span class="p">,</span> <span class="n">ml_mean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;motorlearning&#39;</span><span class="p">],</span> 
               <span class="n">yerr</span><span class="o">=</span><span class="n">ml_sem</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x_pos_vns</span><span class="p">,</span> <span class="n">vns_mean</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">bar_width</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="s1">&#39;pairedVNS&#39;</span><span class="p">],</span>
               <span class="n">yerr</span><span class="o">=</span><span class="n">vns_sem</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Get Significance</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="n">df_bs_results</span><span class="p">[</span>
                <span class="p">(</span><span class="n">df_bs_results</span><span class="p">[</span><span class="s1">&#39;Metric&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">metric_label</span><span class="p">)</span> <span class="o">&amp;</span>
                <span class="p">(</span><span class="n">df_bs_results</span><span class="p">[</span><span class="s1">&#39;Cell_Type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_type</span><span class="p">)</span>
            <span class="p">][</span><span class="s1">&#39;p_value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="mf">1.0</span>
        
        <span class="n">star_text</span> <span class="o">=</span> <span class="n">p_to_stars</span><span class="p">(</span><span class="n">p_val</span><span class="p">)</span>

        <span class="c1"># Draw Sig Bracket</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">([</span><span class="n">ml_mean</span> <span class="o">+</span> <span class="n">ml_sem</span><span class="p">,</span> <span class="n">vns_mean</span> <span class="o">+</span> <span class="n">vns_sem</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_max</span><span class="p">):</span> <span class="n">y_max</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">bracket_y</span> <span class="o">=</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">3</span>
        <span class="n">bracket_h</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">draw_sig_bracket</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x_pos_vns</span><span class="p">,</span> <span class="n">x_pos_ml</span><span class="p">,</span> <span class="n">bracket_y</span><span class="p">,</span> <span class="n">bracket_h</span><span class="p">,</span> <span class="n">star_text</span><span class="p">)</span>
        <span class="n">overall_max_y</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">overall_max_y</span><span class="p">,</span> <span class="n">bracket_y</span> <span class="o">+</span> <span class="n">bracket_h</span><span class="p">)</span>
        
    <span class="c1"># X-Axis formatting</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_base_positions</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">x_tick_labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span> 
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cell_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s1"> neurons&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="c1"># Clean Spines</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;top&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1"># --- Prepare Aggregated Data for Plotting ---</span>
<span class="n">animal_swap_summary</span> <span class="o">=</span> <span class="n">df_fr_swap_analysis</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
    <span class="p">[</span><span class="s1">&#39;experiment&#39;</span><span class="p">,</span> <span class="s1">&#39;waveform_class&#39;</span><span class="p">,</span> <span class="s1">&#39;mouse&#39;</span><span class="p">]</span>
<span class="p">)[[</span><span class="s1">&#39;is_low_to_high&#39;</span><span class="p">,</span> <span class="s1">&#39;is_high_to_low&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">])</span>

<span class="c1"># Calculate percentages</span>
<span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;LowToHigh_Prop&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;is_low_to_high&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)]</span> <span class="o">/</span> 
                                                <span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;is_low_to_high&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)])</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;HighToLow_Prop&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="p">(</span><span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;is_high_to_low&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">)]</span> <span class="o">/</span> 
                                                <span class="n">animal_swap_summary</span><span class="p">[(</span><span class="s1">&#39;is_high_to_low&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">)])</span> <span class="o">*</span> <span class="mi">100</span>

<span class="n">animal_swap_summary</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">animal_swap_summary</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
<span class="n">animal_swap_summary</span> <span class="o">=</span> <span class="n">animal_swap_summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># --- Create Figure ---</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;wspace&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">})</span>

<span class="c1"># Left: RS Neurons</span>
<span class="n">plot_swap_subplot</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span> <span class="n">my_pal_rs</span><span class="p">,</span> <span class="n">animal_swap_summary</span><span class="p">,</span> <span class="n">df_bs_results_swap</span><span class="p">)</span>

<span class="c1"># Right: FS Neurons</span>
<span class="n">plot_swap_subplot</span><span class="p">(</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;fs&#39;</span><span class="p">,</span> <span class="n">my_pal_fs</span><span class="p">,</span> <span class="n">animal_swap_summary</span><span class="p">,</span> <span class="n">df_bs_results_swap</span><span class="p">)</span>

<span class="c1"># Final Aesthetics</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Percentage of neurons (%)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Using Baseline FR Threshold: 0.1917 Hz
Calculating &#39;fr_final&#39; for 524 neurons...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>100%|| 524/524 [00:03&lt;00:00, 166.90it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Neuron FR swapping calculated.

Running Hierarchical Bootstrap on FR Swapping...

Bootstrapping Low-to-High proportion: rs...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: 100%|| 10000/10000 [00:09&lt;00:00, 1012.58it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping High-to-Low proportion: rs...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: 100%|| 10000/10000 [00:09&lt;00:00, 1026.85it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping Low-to-High proportion: fs...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: 100%|| 10000/10000 [00:06&lt;00:00, 1456.98it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping High-to-Low proportion: fs...
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Bootstrapping: 100%|| 10000/10000 [00:06&lt;00:00, 1442.14it/s]
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- HIERARCHICAL BOOTSTRAP STATISTICAL RESULTS (FR Swapping) ---
        Metric Cell_Type  N_Animals_ML  N_Animals_VNS  p_value
0  Low-to-High        rs             5              4   0.0338
1  High-to-Low        rs             5              4   0.3376
2  Low-to-High        fs             5              4   0.4790
3  High-to-Low        fs             5              4   0.6158
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<img alt="_images/39eb997428696066fab4dbeb9d8f1da751e31a6bfa881c3d39d80943759f75d1.png" src="_images/39eb997428696066fab4dbeb9d8f1da751e31a6bfa881c3d39d80943759f75d1.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Mechanistic Validation: Preventing the "Hyperexcitability Shift"</b><br>
    The trajectory analysis suggested that Motor Learning controls exhibit a "run-up" in excitability. To quantify this, we tracked individual neurons to see if they physically shifted from the "Low-FR" stratum to the "High-FR" stratum by the end of the session.
    <ul>
        <li><b>Result:</b> In Motor Learning controls, a significant proportion of <b>RS neurons</b> transitioned from Low-FR to High-FR, confirming a progressive drift toward hyperexcitability.</li>
        <li><b>VNS Effect:</b> Paired VNS significantly reduced this conversion rate (<i>p = 0.033</i>), effectively "locking" neurons in their stable, low-firing state.</li>
    </ul>
    <b>Conclusion:</b> This confirms that the "flattened" trajectories observed in Panel F are not an artifact of averaging, but distinct cellular stabilization: VNS actively prevents the recruitment of RS neurons into a hyperexcitable phenotype.
</div></section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss</p>
      </div>
    </a>
    <a class="right-next"
       href="figure7_longtermMyelin.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Figure 7: Myelin-Dependent Motor Recovery</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data-and-shared-things">Load data and shared things</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-a">Panel a</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-b-overall-firing-rates">Panel b (Overall firing rates)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-c-fs-rs-neurons">Panel c (FS &amp; RS Neurons)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-d-rs-vs-fs-temporal-variability-over-the-recording-session">Panel d (RS vs FS temporal variability over the recording session)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e-early-vs-late-phase-rs-and-fs-neurons">Panel e (Early vs Late Phase RS and FS Neurons)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f-success-aligned-trajectories">Panel f (Success-aligned trajectories)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#extended-data-figure">Extended Data Figure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Panel a</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-b">Panel b</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Shayok 'Shay' Dutta, PhD
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
       Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>