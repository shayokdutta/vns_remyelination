

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Figure 1 VNS Enhances Oligodendrogenesis &#8212; VNS Myelin Manuscript Book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=bd9e20870c6007c4c509" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=bd9e20870c6007c4c509"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'figure1_VNSOligos';</script>
    <link rel="canonical" href="/vns_remyelination/figure1_VNSOligos.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Figure 3 Success-Paired VNS Enhances Oligodendrogenesis" href="figure3_pairedVNSOligos.html" />
    <link rel="prev" title="Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss" href="intro.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <header>
  
    <div class="bd-header navbar navbar-expand-lg bd-navbar">
    </div>
  
  </header>

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
  
    <p class="title logo__title">VNS Myelin Manuscript Book</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Figures</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Figure 1 VNS Enhances Oligodendrogenesis</a></li>

<li class="toctree-l1"><a class="reference internal" href="figure3_pairedVNSOligos.html">Figure 3 Success-Paired VNS Enhances Oligodendrogenesis</a></li>
<li class="toctree-l1"><a class="reference internal" href="figure6_Neuropixels.html">Figure 6: Neuropixels</a></li>
<li class="toctree-l1"><a class="reference internal" href="figure7_longtermMyelin.html">Figure 7: Myelin-Dependent Long-Term Recovery</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/figure1_VNSOligos.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Figure 1 VNS Enhances Oligodendrogenesis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Figure 1 VNS Enhances Oligodendrogenesis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-a-b-experimental-design-timeline">Panels A &amp; B: Experimental Design &amp; Timeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-c-d-longitudinal-tracking-of-demyelination">Panels C &amp; D: Longitudinal Tracking of Demyelination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e-ol-loss-4-wks">Panel e (OL Loss @ 4 wks)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f-new-vs-lost-ols">Panel f (New vs. Lost OLs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-g-modeled-ol-replacement-vs-time">Panel g (Modeled OL Replacement vs. Time)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-h-ol-replacement-rate-post-stimulation">Panel h (OL Replacement Rate Post-stimulation)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-i-max-ol-replacement-post-stimulation">Panel i (Max OL Replacement Post-stimulation)</a></li>
</ul>
</li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="figure-1-vns-enhances-oligodendrogenesis">
<h1>Figure 1 VNS Enhances Oligodendrogenesis<a class="headerlink" href="#figure-1-vns-enhances-oligodendrogenesis" title="Permalink to this heading">#</a></h1>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm_notebook</span> <span class="k">as</span> <span class="n">tqdm</span>

<span class="kn">import</span> <span class="nn">nelpy</span> <span class="k">as</span> <span class="nn">nel</span>
<span class="kn">import</span> <span class="nn">nelpy.plotting</span> <span class="k">as</span> <span class="nn">npl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1.inset_locator</span> <span class="kn">import</span> <span class="n">inset_axes</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Patch</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># Manuscript Mode Setup (White Background / Black Text)</span>
<span class="n">npl</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">font</span><span class="o">=</span><span class="s1">&#39;Arial&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> 
          <span class="n">rc</span><span class="o">=</span><span class="p">({</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> 
               <span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;axes.labelsize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> 
               <span class="s1">&#39;axes.titlesize&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> <span class="s1">&#39;legend.fontsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> 
               <span class="s1">&#39;ytick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;xtick.labelsize&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
               <span class="s1">&#39;xtick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="s1">&#39;ytick.direction&#39;</span><span class="p">:</span> <span class="s1">&#39;out&#39;</span><span class="p">,</span> 
               <span class="s1">&#39;xtick.major.size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ytick.major.size&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
               <span class="s1">&#39;pdf.fonttype&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s1">&#39;ps.fonttype&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
               
               <span class="c1"># --- MANUSCRIPT MODE OVERRIDES ---</span>
               <span class="s1">&#39;figure.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># Transparent background</span>
               <span class="s1">&#39;axes.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>    <span class="c1"># Transparent axes</span>
               <span class="s1">&#39;savefig.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="c1"># Transparent on save</span>
               
               <span class="s1">&#39;text.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>       <span class="c1"># Black Text</span>
               <span class="s1">&#39;axes.labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>  <span class="c1"># Black Axis Labels</span>
               <span class="s1">&#39;xtick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>      <span class="c1"># Black Ticks</span>
               <span class="s1">&#39;ytick.color&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>      <span class="c1"># Black Ticks</span>
               <span class="s1">&#39;axes.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span><span class="p">,</span>   <span class="c1"># Black Spines</span>
               
               <span class="s1">&#39;legend.facecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># Transparent Legend</span>
               <span class="s1">&#39;legend.edgecolor&#39;</span><span class="p">:</span> <span class="s1">&#39;None&#39;</span><span class="p">,</span>  <span class="c1"># No border on legend</span>
               <span class="s1">&#39;legend.labelcolor&#39;</span><span class="p">:</span> <span class="s1">&#39;black&#39;</span> <span class="c1"># Black Legend Text</span>
               <span class="p">}))</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="c1"># Set the root logger&#39;s level to ERROR to suppress WARNING messages</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<span class="o">%</span><span class="k">matplotlib</span> inline 

<span class="n">df_fig1</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../2025-09-30Fig1.csv&quot;</span><span class="p">)</span>
<span class="n">df_fig1</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Marker for Cup at 34 days</th>
      <th>Behavior</th>
      <th>Day</th>
      <th>phase_bin_10 days</th>
      <th>phase_bin_10 days 2, copy</th>
      <th>phase_bin_7Days</th>
      <th>phase_bin_7Days_complete</th>
      <th>daysInPhase2</th>
      <th>days_between_TP</th>
      <th>...</th>
      <th>Replacement Rate w/Phase for graph help column</th>
      <th>Replacement rate w/phase for graph</th>
      <th>Max_loss</th>
      <th>MaxGain_normToLoss</th>
      <th>rate between each tp</th>
      <th>max rate after stim</th>
      <th>max rate during stim</th>
      <th>Asymptote</th>
      <th>Growth Rate</th>
      <th>Inflection Point</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MOBP61</td>
      <td>NaN</td>
      <td>unstimulated</td>
      <td>0</td>
      <td>baseline</td>
      <td>baseline</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>61</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>61.676662</td>
      <td>0.213034</td>
      <td>4.782487</td>
    </tr>
    <tr>
      <th>1</th>
      <td>MOBP61</td>
      <td>NaN</td>
      <td>unstimulated</td>
      <td>4</td>
      <td>cuprizone diet</td>
      <td>cuprizone diet</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>...</td>
      <td>61</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>MOBP61</td>
      <td>NaN</td>
      <td>unstimulated</td>
      <td>7</td>
      <td>cuprizone diet</td>
      <td>cuprizone diet</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>...</td>
      <td>61</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MOBP61</td>
      <td>NaN</td>
      <td>unstimulated</td>
      <td>11</td>
      <td>cuprizone diet</td>
      <td>cuprizone diet</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>4.0</td>
      <td>...</td>
      <td>61</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MOBP61</td>
      <td>NaN</td>
      <td>unstimulated</td>
      <td>14</td>
      <td>cuprizone diet</td>
      <td>cuprizone diet</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>3.0</td>
      <td>...</td>
      <td>61</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>225</th>
      <td>MOBP70</td>
      <td>NaN</td>
      <td>VNS</td>
      <td>50</td>
      <td>post-learning1</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>...</td>
      <td>55</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.602410</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>226</th>
      <td>MOBP70</td>
      <td>NaN</td>
      <td>VNS</td>
      <td>53</td>
      <td>post-learning1</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>7.0</td>
      <td>3.0</td>
      <td>...</td>
      <td>55</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>1.204819</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>227</th>
      <td>MOBP70</td>
      <td>NaN</td>
      <td>VNS</td>
      <td>55</td>
      <td>post-learning1</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>post-learning3</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>...</td>
      <td>55</td>
      <td>0.860585</td>
      <td>83.838384</td>
      <td>68.674699</td>
      <td>0.602410</td>
      <td>2.409639</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>228</th>
      <td>MOBP70</td>
      <td>NaN</td>
      <td>VNS</td>
      <td>60</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>5.0</td>
      <td>...</td>
      <td>67</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>229</th>
      <td>MOBP70</td>
      <td>NaN</td>
      <td>VNS</td>
      <td>67</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>7.0</td>
      <td>...</td>
      <td>67</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
<p>230 rows × 38 columns</p>
</div></div></div>
</div>
<section id="panels-a-b-experimental-design-timeline">
<h2>Panels A &amp; B: Experimental Design &amp; Timeline<a class="headerlink" href="#panels-a-b-experimental-design-timeline" title="Permalink to this heading">#</a></h2>
<p><strong>In vivo imaging of VNS-mediated recovery.</strong> We utilized a longitudinal two-photon imaging approach to track oligodendrocyte dynamics in the motor cortex of MOBP-EGFP mice throughout demyelination and recovery.</p>
<div class="alert alert-block alert-info">
    <b>Experimental Context: Protocol Design</b><br>
    To isolate the effects of VNS on repair, we designed a specific intervention timeline (<i>Fig. 1b</i>):
    <ul>
        <li><b>Induction:</b> Demyelination was induced via a 0.2% cuprizone diet for 3 weeks.</li>
        <li><b>Intervention:</b> VNS (or Sham) was delivered daily for 7 days. Crucially, stimulation began <b>3 days after</b> cuprizone removal, targeting the early recovery phase rather than the injury phase.</li>
        <li><b>Validation:</b> VNS efficacy was confirmed by acute physiological markers (<i>see Extended Data Fig. 1d,e</i>).</li>
    </ul>
</div><p><img alt="Figure 1 Panel A" src="_images/mouseWithVNCuffCranialWindow.svg" /></p>
<p><img alt="Figure 1 Panel B" src="_images/panelB.svg" /></p>
</section>
<section id="panels-c-d-longitudinal-tracking-of-demyelination">
<h2>Panels C &amp; D: Longitudinal Tracking of Demyelination<a class="headerlink" href="#panels-c-d-longitudinal-tracking-of-demyelination" title="Permalink to this heading">#</a></h2>
<p><strong>Visualizing cellular turnover.</strong> Longitudinal imaging allowed us to classify individual cells as stable (yellow), lost (pink), or newly generated (blue) over the 7-week observation period (<i>Fig. 1c</i>).</p>
<div class="alert alert-block alert-success">
    <b>Model Validation: Robust Demyelination</b><br>
    Before assessing recovery, we confirmed the validity of the injury model:
    <ul>
        <li><b>Significant Loss (Fig. 1d):</b> Individual animal traces confirm that cuprizone treatment induced a robust and significant loss of oligodendrocytes across the cohort.</li>
        <li><b>Consistency:</b> The trajectory of oligodendrocyte loss was consistent with our previous work, establishing a reliable baseline from which to measure VNS-mediated regeneration.</li>
    </ul>
</div><p><img alt="Figure 1 Panel C" src="_images/panelC1.svg" /></p>
<p><img alt="Figure 1 Panel D" src="_images/panelD1.svg" /></p>
</section>
<section id="panel-e-ol-loss-4-wks">
<h2>Panel e (OL Loss &#64; 4 wks)<a class="headerlink" href="#panel-e-ol-loss-4-wks" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 1 Panel E" src="_images/panelE1.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>

<span class="c1"># Formatting function</span>
<span class="k">def</span> <span class="nf">pretty_print_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">to_html</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="s1">&#39;table table-striped table-hover&#39;</span><span class="p">,</span> <span class="n">justify</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)))</span>

<span class="c1"># --- PANEL E DATA (Manually entered from text) ---</span>
<span class="n">data_e</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Comparison&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;VNS vs. Unstimulated Controls&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;% Oligodendrocyte Loss (4 weeks post-cuprizone)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;VNS Mean ± SEM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;62.92 ± 7.82%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Control Mean ± SEM&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;76.64 ± 5.10%&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Student&#39;s t-test&quot;</span><span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.1632 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;No significant difference in injury severity&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_e</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_e</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_e</span><span class="p">,</span> <span class="s2">&quot;--- Panel E Statistics: Baseline Injury Severity ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel E Statistics: Baseline Injury Severity ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Comparison</th>
      <th>Metric</th>
      <th>VNS Mean ± SEM</th>
      <th>Control Mean ± SEM</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>VNS vs. Unstimulated Controls</td>
      <td>% Oligodendrocyte Loss (4 weeks post-cuprizone)</td>
      <td>62.92 ± 7.82%</td>
      <td>76.64 ± 5.10%</td>
      <td>Student's t-test</td>
      <td>0.1632 (n.s.)</td>
      <td>No significant difference in injury severity</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Model Validation: Equal Baseline Injury</b><br>
    Crucially, the extent of demyelination was comparable between groups prior to the intervention:
    <ul>
        <li><b>No Bias:</b> There was no significant difference in the percentage of oligodendrocyte loss between VNS-treated animals (<b>62.92%</b>) and unstimulated controls (<b>76.64%</b>; <i>p = 0.1632</i>).</li>
        <li><b>Implication:</b> This confirms that the subsequent enhancement in regeneration observed in the VNS group is not an artifact of milder injury, but rather a direct effect of the stimulation on the repair process.</li>
    </ul>
</div></section>
<section id="panel-f-new-vs-lost-ols">
<h2>Panel f (New vs. Lost OLs)<a class="headerlink" href="#panel-f-new-vs-lost-ols" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 1 Panel F" src="_images/panelF1.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- PANEL F DATA (ANCOVA Results) ---</span>
<span class="n">data_f</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Factor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Group Effect (VNS vs Control)&quot;</span><span class="p">,</span> <span class="s2">&quot;Cumulative Loss Effect&quot;</span><span class="p">,</span> <span class="s2">&quot;Interaction (Group × Loss)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Cumulative % New OLs (4 weeks)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ANCOVA (Unequal Slopes)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0157 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0045 (**)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0136 (*)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Significant Treatment Effect&quot;</span><span class="p">,</span> <span class="s2">&quot;Regeneration scales with injury&quot;</span><span class="p">,</span> <span class="s2">&quot;VNS amplifies the response&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_f</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_f</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_f</span><span class="p">,</span> <span class="s2">&quot;--- Panel F Statistics: VNS Amplifies Regeneration ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel F Statistics: VNS Amplifies Regeneration ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Factor</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Group Effect (VNS vs Control)</td>
      <td>Cumulative % New OLs (4 weeks)</td>
      <td>ANCOVA (Unequal Slopes)</td>
      <td>0.0157 (*)</td>
      <td>Significant Treatment Effect</td>
    </tr>
    <tr>
      <td>Cumulative Loss Effect</td>
      <td></td>
      <td></td>
      <td>0.0045 (**)</td>
      <td>Regeneration scales with injury</td>
    </tr>
    <tr>
      <td>Interaction (Group × Loss)</td>
      <td></td>
      <td></td>
      <td>0.0136 (*)</td>
      <td>VNS amplifies the response</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: VNS Amplifies the Regenerative Response</b><br>
    By analyzing cumulative oligodendrocyte gain relative to the initial loss (ANCOVA), we uncovered a dynamic interaction between injury and repair:
    <ul>
        <li><b>Homeostatic Scaling (Loss Effect):</b> There was a significant main effect of cumulative loss (<i>p = 0.0045</i>), confirming that the brain naturally scales its regenerative effort to match the severity of the injury.</li>
        <li><b>Treatment Efficacy (Group Effect):</b> VNS significantly increased the total number of new oligodendrocytes generated (<i>p = 0.0157</i>).</li>
        <li><b>Amplification (Interaction):</b> Crucially, the significant interaction (<i>p = 0.0136</i>) reveals that VNS does not just add a fixed number of cells; it <b>amplifies</b> the natural homeostatic response, driving disproportionately greater regeneration in animals with larger deficits.</li>
    </ul>
</div></section>
<section id="panel-g-modeled-ol-replacement-vs-time">
<h2>Panel g (Modeled OL Replacement vs. Time)<a class="headerlink" href="#panel-g-modeled-ol-replacement-vs-time" title="Permalink to this heading">#</a></h2>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_animal_trajectories</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">behavior_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span>\
                             <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots individual animal trajectories from a dataframe.</span>
<span class="sd">    Automatically removes rows where &#39;Behavior&#39; (or other critical data) is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. Internal Data Cleaning</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    
    <span class="c1"># Drop rows where critical info is missing</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">behavior_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="c1"># Report cleanup results if necessary</span>
    <span class="n">dropped_count</span> <span class="o">=</span> <span class="n">original_count</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">plot_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dropped_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data Cleanup: Dropped </span><span class="si">{</span><span class="n">dropped_count</span><span class="si">}</span><span class="s2"> rows containing NaNs.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Dataframe is empty after cleaning. Check your column names or data.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># 2. Calculate and Print N per Group</span>
    <span class="c1"># Group by behavior and count unique IDs</span>
    <span class="n">group_counts</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">behavior_col</span><span class="p">)[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Sample Sizes (N) for&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">group_counts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Clean up the group name for printing</span>
        <span class="n">clean_group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  - </span><span class="si">{</span><span class="n">clean_group</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> animals&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
   
    <span class="c1"># Get unique animals from the CLEAN data only</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

    <span class="c1"># 3. Setup Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># 4. Plot Loop</span>
    <span class="k">for</span> <span class="n">animal_id</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">animal_subset</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">animal_subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">group_val</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">behavior_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">animal_subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">],</span> 
                 <span class="n">animal_subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> 
                 <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> 
                 <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> 
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> 
                 <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>

    <span class="c1"># 5. Formatting</span>
    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
    <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days post-cuprizone&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">my_palette</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">}</span>
<span class="n">plot_animal_trajectories</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">my_palette</span><span class="p">,</span> <span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>------------------------------
Sample Sizes (N) for
  - VNS: 5 animals
  - unstimulated: 6 animals
------------------------------
</pre></div>
</div>
<img alt="_images/4ce52e7fafede5154bcb377a9820afc02147f671147aa828d323ff252dc766fd.png" src="_images/4ce52e7fafede5154bcb377a9820afc02147f671147aa828d323ff252dc766fd.png" />
</div>
</div>
<div class="alert alert-block alert-info">
    <b>Methodological Note: Longitudinal Imaging Trajectories</b><br>
    To quantify oligodendrocyte dynamics, we performed longitudinal <i>in vivo</i> two-photon imaging at multiple time points post-cuprizone.
    <ul>
        <li><b>Temporal Variability:</b> Exact imaging dates and total duration varied between animals due to experimental constraints, specifically the visibility of cranial window clarity over the observation period causes some mice to not be imaged as long.</li>
        <li><b>Metric:</b> We calculated <b>Total OL Replacement %</b> at each available time point. This metric allows for the assessment of regeneration trajectories despite the heterogeneity in sampling intervals.</li>
    </ul>
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">calculate_aic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate AIC: n * log(RSS/n) + 2k&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rss</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rss</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. GOMPERTZ MODEL</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">gompertz</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gompertz growth model.</span>
<span class="sd">    a: Asymptote (theoretical maximum)</span>
<span class="sd">    b: Displacement (shifts curve along x-axis)</span>
<span class="sd">    c: Growth rate</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">t</span><span class="p">))</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. FIT AND PLOT (Returns Individual Params)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">plot_gompertz_fits</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">behavior_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> <span class="n">plot_individual</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>\
                       <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a Gompertz curve to each animal individually and plots the SMOOTH modeled trajectory.</span>
<span class="sd">    Returns a DataFrame containing the fitted parameters for every animal.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">original_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="n">plot_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">behavior_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Dataframe is empty after cleaning.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span> 
    
    <span class="n">fitted_params</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

    <span class="c1"># --- SETUP PLOTTING ---</span>
    <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
        <span class="n">n_mice</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">n_rows</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_mice</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">n_cols</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_rows</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span> <span class="n">constrained_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span> <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">]</span> <span class="c1"># Handle single plot case</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Standard Aggregate Plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">animal_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">animals</span><span class="p">):</span>
        <span class="n">animal_subset</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">animal_subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Skipping </span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">: Not enough data points to fit.&quot;</span><span class="p">)</span>
            <span class="k">continue</span>
            
        <span class="n">x_raw</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_raw</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">n_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_raw</span><span class="p">)</span>
        
        <span class="n">group_val</span> <span class="o">=</span> <span class="n">animal_subset</span><span class="p">[</span><span class="n">behavior_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group_val</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y_raw</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gompertz</span><span class="p">,</span> <span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>

            <span class="c1"># CALC R^2</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_raw</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
            <span class="n">ss_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_raw</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ss_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_raw</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y_raw</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">r_squared</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">ss_res</span> <span class="o">/</span> <span class="n">ss_tot</span><span class="p">)</span> <span class="k">if</span> <span class="n">ss_tot</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

            <span class="c1"># AIC (k=3 parameters for Gompertz)</span>
            <span class="n">aic_score</span> <span class="o">=</span> <span class="n">calculate_aic</span><span class="p">(</span><span class="n">n_points</span><span class="p">,</span> <span class="n">ss_res</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
                <span class="n">ax_curr</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                
                <span class="c1"># Plot Raw Data</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_raw</span><span class="p">,</span> <span class="n">y_raw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
                <span class="c1"># Plot Fit</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Add Text</span>
                <span class="n">stats_text</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;$R^2$=</span><span class="si">{</span><span class="n">r_squared</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="se">\n</span><span class="s1">AIC=</span><span class="si">{</span><span class="n">aic_score</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="n">stats_text</span><span class="p">,</span> 
                             <span class="n">transform</span><span class="o">=</span><span class="n">ax_curr</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> 
                             <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
                <span class="n">ax_curr</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_smooth</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">y_smooth</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
            
            <span class="n">fitted_params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal_id</span><span class="p">,</span>
                <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
                <span class="s1">&#39;Asymptote_a&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s1">&#39;Displacement_b&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s1">&#39;Rate_c&#39;</span><span class="p">:</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="p">})</span>
            
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fit failed for animal </span><span class="si">{</span><span class="n">animal_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_individual</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">axes</span><span class="p">)):</span> 
            <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
        <span class="n">by_label</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">handles</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">by_label</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">by_label</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Group&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Days post-cuprizone&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Modeled OL replacement (%)&quot;</span><span class="p">)</span> 
        <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fitted_params</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. STATS ON PARAMETERS (Inflection Point, Asymptote)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">analyze_gompertz_stats</span><span class="p">(</span><span class="n">df_results</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates Inflection Point and performs T-tests on parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Inflection_Point&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Displacement_b&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Rate_c&#39;</span><span class="p">]</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Statistics require exactly 2 groups. Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="k">if</span> <span class="n">target_greater_group</span> <span class="ow">and</span> <span class="n">target_greater_group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">group1_name</span> <span class="o">=</span> <span class="n">target_greater_group</span>
        <span class="n">group2_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">target_greater_group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">group1_name</span><span class="p">,</span> <span class="n">group2_name</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">g1_data</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group1_name</span><span class="p">]</span>
    <span class="n">g2_data</span> <span class="o">=</span> <span class="n">df_results</span><span class="p">[</span><span class="n">df_results</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group2_name</span><span class="p">]</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;GOMPERTZ PARAMETER STATISTICS&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hypothesis: Is </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">?&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="n">metrics</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;Asymptote_a&#39;</span><span class="p">:</span> <span class="s1">&#39;Theoretical Max Replacement (%)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Inflection_Point&#39;</span><span class="p">:</span> <span class="s1">&#39;Time of Peak Growth (Days)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Rate_c&#39;</span><span class="p">:</span> <span class="s1">&#39;Growth Rate Constant (c)&#39;</span>
    <span class="p">}</span>
    
    <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">vals1</span> <span class="o">=</span> <span class="n">g1_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        <span class="n">vals2</span> <span class="o">=</span> <span class="n">g2_data</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
        
        <span class="n">t_2side</span><span class="p">,</span> <span class="n">p_2side</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
        <span class="n">t_1side</span><span class="p">,</span> <span class="n">p_1side</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_ind</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span> <span class="n">equal_var</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">get_stars</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">return</span> <span class="s2">&quot;n.s.&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group1_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">group2_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">vals2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">vals2</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Difference: </span><span class="si">{</span><span class="n">vals1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vals2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">+.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Two-Sided: p=</span><span class="si">{</span><span class="n">p_2side</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">get_stars</span><span class="p">(</span><span class="n">p_2side</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  One-Sided: p=</span><span class="si">{</span><span class="n">p_1side</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">get_stars</span><span class="p">(</span><span class="n">p_1side</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 4. EVALUATE GOODNESS OF FIT (GROUP TEMPLATE RMSE)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">run_metric_permutation_test</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">metric_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="n">g1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">g2</span><span class="p">))</span>
    <span class="n">pooled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">g1</span><span class="p">,</span> <span class="n">g2</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span>
    
    <span class="n">null_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">pooled</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">pooled</span><span class="p">[:</span><span class="n">n1</span><span class="p">]</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">pooled</span><span class="p">[</span><span class="n">n1</span><span class="p">:]</span>
        <span class="n">null_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">p2</span><span class="p">)))</span>
        
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_diffs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">obs_diff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">evaluate_gompertz_fit</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">df_params</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> 
                          <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates RMSE for 4 phases by comparing each animal&#39;s data against its GROUP TEMPLATE.</span>
<span class="sd">    Runs permutation tests to compare fit quality (RMSE) between groups.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. Fit Group Templates first</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fitting Group Templates (Pooled Data)...&quot;</span><span class="p">)</span>
    <span class="n">templates</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">][</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">subset</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">group_ids</span><span class="p">)]</span>
        
        <span class="n">x_all</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_all</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y_all</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">]</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
            <span class="n">popt</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gompertz</span><span class="p">,</span> <span class="n">x_all</span><span class="p">,</span> <span class="n">y_all</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
            <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">popt</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not fit Group Template for </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>

    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">phases</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;Overall&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;Early&#39;</span><span class="p">,</span>   <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;Middle&#39;</span><span class="p">,</span>  <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;Late&#39;</span><span class="p">,</span>    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
    <span class="p">]</span>
    
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">animal_id</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span>
        
        <span class="n">animal_data</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">df_raw</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal_id</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">animal_data</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">continue</span>
            
        <span class="n">x_obs</span> <span class="o">=</span> <span class="n">animal_data</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_obs</span> <span class="o">=</span> <span class="n">animal_data</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># USE GROUP TEMPLATE PARAMETERS</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">templates</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">templates</span><span class="p">[</span><span class="n">group</span><span class="p">]</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x_obs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="n">row_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="n">id_col</span><span class="p">:</span> <span class="n">animal_id</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">}</span>
        
        <span class="k">for</span> <span class="n">phase_name</span><span class="p">,</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">phases</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">condition</span><span class="p">(</span><span class="n">x_obs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_obs</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                
            <span class="n">row_metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;RMSE_</span><span class="si">{</span><span class="n">phase_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rmse</span>
            
        <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_metrics</span><span class="p">)</span>
        
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    
    <span class="c1"># --- REPORTING ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GOMPERTZ GROUP TEMPLATE EVALUATION&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Comparing deviation (RMSE) of individuals from the Group S-Curve&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">90</span><span class="p">)</span>
    
    <span class="n">metric_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_metrics</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;RMSE&#39;</span> <span class="ow">in</span> <span class="n">c</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;Metric&#39;</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">&lt;12</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;Diff&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="s1">&#39;P-Value&#39;</span><span class="si">:</span><span class="s2">&lt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metric_cols</span><span class="p">:</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="n">run_metric_permutation_test</span><span class="p">(</span><span class="n">df_metrics</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">)</span>
            <span class="n">g1_mean</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">g2_mean</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">g1_mean</span> <span class="o">-</span> <span class="n">g2_mean</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="s2">&quot;n.s.&quot;</span>
            <span class="k">if</span> <span class="n">p_val</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">sig</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="si">:</span><span class="s2">&lt;18</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">g1_mean</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">    | </span><span class="si">{</span><span class="n">g2_mean</span><span class="si">:</span><span class="s2">&gt;9.2f</span><span class="si">}</span><span class="s2">    | </span><span class="si">{</span><span class="n">diff</span><span class="si">:</span><span class="s2">&gt;+6.2f</span><span class="si">}</span><span class="s2">   | </span><span class="si">{</span><span class="n">p_val</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sig</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;INTERPRETATION: Significantly higher RMSE indicates the Group S-Curve fails to capture individual behavior.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df_metrics</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># GOMPERTZ VISUALIZATION (Mean +/- SEM)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">plot_gompertz_mean_with_sem</span><span class="p">(</span><span class="n">df_raw</span><span class="p">,</span> <span class="n">df_params</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                                <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                                <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plots the MEAN Gompertz trajectory +/- SEM for each group.</span>
<span class="sd">    This effectively visualizes the &quot;Average Model&quot; vs. the &quot;Raw Data&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Setup Plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># Define common grid for averaging</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">df_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># Get parameters for all animals in this group</span>
        <span class="n">group_params</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        
        <span class="c1"># 1. Generate curves for EVERY animal on the common grid</span>
        <span class="n">individual_curves</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">group_params</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Asymptote_a&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Displacement_b&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;Rate_c&#39;</span><span class="p">]</span>
            
            <span class="c1"># Predict on grid</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">individual_curves</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_pred</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="ow">not</span> <span class="n">individual_curves</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="c1"># 2. Calculate Mean and SEM across the population of curves</span>
        <span class="n">curve_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">individual_curves</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_curve</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">curve_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="c1"># 3. Plot the Model (Line + Ribbon)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2"> (Gompertz)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="c1"># 4. Plot the Raw Data</span>
        <span class="c1"># We need to map the group name back to the raw dataframe&#39;s group column</span>
        <span class="c1"># Assuming direct string match or stripping</span>
        <span class="n">subset_raw</span> <span class="o">=</span> <span class="n">df_raw</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">group_col</span><span class="p">])</span>
        <span class="n">subset_raw</span> <span class="o">=</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">subset_raw</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">subset_raw</span><span class="p">[</span><span class="n">x_col</span><span class="p">],</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">y_col</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">subset_raw</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">current_max</span> <span class="o">=</span> <span class="n">subset_raw</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">current_max</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">current_max</span>

    <span class="c1"># Formatting</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gompertz Model: Mean Trajectory vs. Raw Data&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">y_col</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">df_results_fig1</span> <span class="o">=</span> <span class="n">plot_gompertz_fits</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">})</span>
<span class="n">plot_gompertz_mean_with_sem</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">df_results_fig1</span><span class="p">,</span> 
                            <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">})</span>
<span class="n">analyze_gompertz_stats</span><span class="p">(</span><span class="n">df_results_fig1</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="s2">&quot;VNS&quot;</span><span class="p">)</span>
<span class="n">evaluate_gompertz_fit</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">df_results_fig1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/4030c3f38bf79a4cbac328eb2701ed927c0ff88322c472d8f6eddb5b39c71bff.png" src="_images/4030c3f38bf79a4cbac328eb2701ed927c0ff88322c472d8f6eddb5b39c71bff.png" />
<img alt="_images/6ea25bfeaba58d2dc959ccad6fad5a71b34a258240baa9b53939c0bd3a1f6c4b.png" src="_images/6ea25bfeaba58d2dc959ccad6fad5a71b34a258240baa9b53939c0bd3a1f6c4b.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
GOMPERTZ PARAMETER STATISTICS
Hypothesis: Is VNS &gt; unstimulated?
================================================================================

Metric: Theoretical Max Replacement (%) [Asymptote_a]
  VNS: 86.99 ± 8.59
  unstimulated: 59.59 ± 5.07
  Difference: +27.40
----------------------------------------
  Two-Sided: p=0.0187 [*]
  One-Sided: p=0.0093 [**]
................................................................................

Metric: Time of Peak Growth (Days) [Inflection_Point]
  VNS: 10.43 ± 2.47
  unstimulated: 6.75 ± 0.87
  Difference: +3.68
----------------------------------------
  Two-Sided: p=0.1627 [n.s.]
  One-Sided: p=0.0814 [n.s.]
................................................................................

Metric: Growth Rate Constant (c) [Rate_c]
  VNS: 0.12 ± 0.01
  unstimulated: 0.14 ± 0.02
  Difference: -0.02
----------------------------------------
  Two-Sided: p=0.4688 [n.s.]
  One-Sided: p=0.7656 [n.s.]
................................................................................
Fitting Group Templates (Pooled Data)...
==========================================================================================
GOMPERTZ GROUP TEMPLATE EVALUATION
Comparing deviation (RMSE) of individuals from the Group S-Curve
==========================================================================================
Metric             | unstimulated | VNS          | Diff     | P-Value 
------------------------------------------------------------------------------------------
RMSE_Overall       |      5.62    |      8.26    |  -2.64   | 0.1429 n.s.
RMSE_Early         |      1.83    |      1.48    |  +0.35   | 0.6543 n.s.
RMSE_Middle        |      5.64    |      8.30    |  -2.66   | 0.2817 n.s.
RMSE_Late          |      7.18    |      9.98    |  -2.80   | 0.1998 n.s.
------------------------------------------------------------------------------------------
INTERPRETATION: Significantly higher RMSE indicates the Group S-Curve fails to capture individual behavior.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>Group</th>
      <th>RMSE_Overall</th>
      <th>RMSE_Early</th>
      <th>RMSE_Middle</th>
      <th>RMSE_Late</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>MOBP61</td>
      <td>unstimulated</td>
      <td>8.491837</td>
      <td>2.453506</td>
      <td>12.732574</td>
      <td>8.584114</td>
    </tr>
    <tr>
      <th>1</th>
      <td>MOBP72</td>
      <td>unstimulated</td>
      <td>3.441403</td>
      <td>0.894099</td>
      <td>2.223661</td>
      <td>4.826859</td>
    </tr>
    <tr>
      <th>2</th>
      <td>MOBP76</td>
      <td>unstimulated</td>
      <td>7.355261</td>
      <td>1.200695</td>
      <td>4.481986</td>
      <td>11.210911</td>
    </tr>
    <tr>
      <th>3</th>
      <td>MOBP77</td>
      <td>unstimulated</td>
      <td>6.315817</td>
      <td>4.189622</td>
      <td>4.674059</td>
      <td>8.542020</td>
    </tr>
    <tr>
      <th>4</th>
      <td>MOBP87</td>
      <td>unstimulated</td>
      <td>3.394691</td>
      <td>1.729710</td>
      <td>3.841452</td>
      <td>4.334044</td>
    </tr>
    <tr>
      <th>5</th>
      <td>MOBP127</td>
      <td>unstimulated</td>
      <td>4.702710</td>
      <td>0.517691</td>
      <td>5.882202</td>
      <td>5.610539</td>
    </tr>
    <tr>
      <th>6</th>
      <td>MOBP48</td>
      <td>VNS</td>
      <td>10.862578</td>
      <td>1.859385</td>
      <td>14.491914</td>
      <td>11.467632</td>
    </tr>
    <tr>
      <th>7</th>
      <td>MOBP55</td>
      <td>VNS</td>
      <td>11.371677</td>
      <td>2.118407</td>
      <td>4.850927</td>
      <td>16.360978</td>
    </tr>
    <tr>
      <th>8</th>
      <td>MOBP60</td>
      <td>VNS</td>
      <td>4.332051</td>
      <td>2.077192</td>
      <td>4.234010</td>
      <td>5.651283</td>
    </tr>
    <tr>
      <th>9</th>
      <td>MOBP69</td>
      <td>VNS</td>
      <td>8.665949</td>
      <td>0.177670</td>
      <td>11.617662</td>
      <td>8.844713</td>
    </tr>
    <tr>
      <th>10</th>
      <td>MOBP70</td>
      <td>VNS</td>
      <td>6.046035</td>
      <td>1.181262</td>
      <td>6.307432</td>
      <td>7.581714</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: VNS Enhances Regenerative Capacity</b><br>
    Modeling oligodendrocyte dynamics with a Gompertz growth function reveals a significant long-term benefit of VNS:
    <ul>
        <li><b>Higher Theoretical Maximum:</b> VNS-treated animals exhibited a significantly higher asymptotic limit for oligodendrocyte replacement (<b>86.99% ± 8.59%</b>) compared to unstimulated controls (<b>59.59% ± 5.07%</b>; <i>p = 0.0187</i>). This suggests VNS expands the "ceiling" for repair.</li>
        <li><b>Similar Kinetics:</b> The rate of growth (<i>Rate c</i>) and the time of peak regeneration (<i>Inflection Point</i>) were not significantly different between groups (<i>p > 0.05</i>), indicating that VNS scales the magnitude of repair without fundamentally altering its temporal onset.</li>
    </ul>
</div><div class="alert alert-block alert-danger">
    <b>Model Validation: Lack of Goodness-of-Fit</b><br>
    While the parameter comparison suggests a treatment effect, a deeper evaluation of the model's fit reveals critical limitations:
    <ul>
        <li><b>High Residual Error:</b> The Root Mean Square Error (RMSE) for both groups is substantial (Unstimulated: 5.62, VNS: 8.26), indicating that individual animal trajectories deviate considerably from the group-level "S-curve."</li>
        <li><b>Failure to Capture Complexity:</b> The non-significant difference in RMSE between groups (<i>p = 0.1429</i>) suggests the model performs equally poorly for both. The high late-phase error (RMSE > 7) implies that a simple asymptotic growth model fails to capture the complex, potentially multiphasic dynamics of long-term remyelination observed in this dataset.</li>
    </ul>
    <b>Conclusion:</b> A more flexible, non-parametric approach may be required to accurately characterize the distinct phases of repair.
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_results_fig1</span> <span class="o">=</span> <span class="n">plot_gompertz_fits</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">},</span><span class="n">plot_individual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/69163e33a27a5154c9776b0b705bebbd7ff803950975041b5126c415427ae8ba.png" src="_images/69163e33a27a5154c9776b0b705bebbd7ff803950975041b5126c415427ae8ba.png" />
</div>
</div>
<div class="alert alert-block alert-info">
    <b>Methodological Caveat: High $R^2$ Does Not Imply Model Validity</b><br>
    In our analysis, the Gompertz model yielded $R^2$ values consistently exceeding <b>0.97</b>. However, a high $R^2$ is not sufficient proof that the chosen model (S-curve) is the correct structural fit for the biological process. The following proof-of-concept demonstrates how a Gompertz curve can "force-fit" fundamentally linear data while still producing a near-perfect $R^2$ score.
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="c1"># --- 2. Generate Synthetic LINEAR Data ---</span>
<span class="k">def</span> <span class="nf">linear</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;2-Parameter Linear Model&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">m</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">calculate_aic</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">rss</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate AIC: n * log(RSS/n) + 2k&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">rss</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rss</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span>

<span class="c1"># --- 2. Generate Synthetic LINEAR Data ---</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># for reproducible results</span>
<span class="n">x_syn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>

<span class="c1"># Define underlying linear trend (y = mx + c)</span>
<span class="n">true_slope</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">true_intercept</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">y_linear_true</span> <span class="o">=</span> <span class="n">true_slope</span> <span class="o">*</span> <span class="n">x_syn</span> <span class="o">+</span> <span class="n">true_intercept</span>

<span class="c1"># Add random noise to simulate real biological data</span>
<span class="n">noise_level</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">y_syn_noisy</span> <span class="o">=</span> <span class="n">y_linear_true</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_level</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_syn</span><span class="p">))</span>

<span class="c1"># --- 3. Fit Models &amp; Calculate Metrics ---</span>

<span class="c1"># A. Fit Gompertz (3 params)</span>
<span class="c1"># Generous bounds to allow it to mimic a line</span>
<span class="n">p0_g</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">y_syn_noisy</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span>
<span class="n">bounds_g</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">popt_g</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">gompertz</span><span class="p">,</span> <span class="n">x_syn</span><span class="p">,</span> <span class="n">y_syn_noisy</span><span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="n">p0_g</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds_g</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
    <span class="n">y_pred_g</span> <span class="o">=</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_syn</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_g</span><span class="p">)</span>
    
    <span class="c1"># Metrics</span>
    <span class="n">r2_g</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_syn_noisy</span><span class="p">,</span> <span class="n">y_pred_g</span><span class="p">)</span>
    <span class="n">rss_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_syn_noisy</span> <span class="o">-</span> <span class="n">y_pred_g</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aic_g</span> <span class="o">=</span> <span class="n">calculate_aic</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_syn</span><span class="p">),</span> <span class="n">rss_g</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="c1"># k=3 parameters</span>
    <span class="n">status_g</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">status_g</span> <span class="o">=</span> <span class="s2">&quot;Failed&quot;</span>
    <span class="n">aic_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="c1"># B. Fit Linear (2 params)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">popt_l</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">linear</span><span class="p">,</span> <span class="n">x_syn</span><span class="p">,</span> <span class="n">y_syn_noisy</span><span class="p">)</span>
    <span class="n">y_pred_l</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x_syn</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_l</span><span class="p">)</span>
    
    <span class="c1"># Metrics</span>
    <span class="n">r2_l</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_syn_noisy</span><span class="p">,</span> <span class="n">y_pred_l</span><span class="p">)</span>
    <span class="n">rss_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y_syn_noisy</span> <span class="o">-</span> <span class="n">y_pred_l</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">aic_l</span> <span class="o">=</span> <span class="n">calculate_aic</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_syn</span><span class="p">),</span> <span class="n">rss_l</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># k=2 parameters</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">aic_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

<span class="c1"># --- 4. Visualize the Comparison ---</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="c1"># Plot Data</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_syn</span><span class="p">,</span> <span class="n">y_syn_noisy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Synthetic Data (Linear+Noise)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_syn</span><span class="p">,</span> <span class="n">y_linear_true</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True Linear Trend&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="n">status_g</span> <span class="o">==</span> <span class="s2">&quot;Success&quot;</span><span class="p">:</span>
    <span class="c1"># Plot Gompertz Fit</span>
    <span class="n">x_smooth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="n">gompertz</span><span class="p">(</span><span class="n">x_smooth</span><span class="p">,</span> <span class="o">*</span><span class="n">popt_g</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Gompertz Fit&#39;</span><span class="p">)</span>
    
    <span class="c1"># Determine Winner</span>
    <span class="n">winner</span> <span class="o">=</span> <span class="s2">&quot;Linear&quot;</span> <span class="k">if</span> <span class="n">aic_l</span> <span class="o">&lt;</span> <span class="n">aic_g</span> <span class="k">else</span> <span class="s2">&quot;Gompertz&quot;</span>
    
    <span class="c1"># Text Box with Stats Comparison</span>
    <span class="n">textstr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">((</span>
        <span class="sa">r</span><span class="s1">&#39;$\bf{Model\ Comparison}$&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;--------------------------&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;$\bf{Gompertz\ (3\ params)}$&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;  $R^2 = </span><span class="si">%.4f</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r2_g</span><span class="p">,</span> <span class="p">),</span>
        <span class="sa">r</span><span class="s1">&#39;  AIC = </span><span class="si">%.1f</span><span class="s1"> (Higher)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aic_g</span><span class="p">,</span> <span class="p">),</span>
        <span class="sa">r</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;$\bf{Linear\ (2\ params)}$&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;  $R^2 = </span><span class="si">%.4f</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">r2_l</span><span class="p">,</span> <span class="p">),</span>
        <span class="sa">r</span><span class="s1">&#39;  AIC = </span><span class="si">%.1f</span><span class="s1"> (Lower)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">aic_l</span><span class="p">,</span> <span class="p">),</span>
        <span class="sa">r</span><span class="s1">&#39;--------------------------&#39;</span><span class="p">,</span>
        <span class="sa">r</span><span class="s1">&#39;$\bf{Winner:\ </span><span class="si">%s</span><span class="s1">}$&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">winner</span><span class="p">,</span> <span class="p">),</span>
        <span class="sa">r</span><span class="s1">&#39;(AIC penalizes overfitting)&#39;</span>
    <span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="n">textstr</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Gompertz Fit Failed&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Proof of Concept: AIC Correctly Identifies the &#39;True&#39; Model</span><span class="se">\n</span><span class="s2">(Even when $R^2$ is identical)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (Days)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Replacement (%)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower right&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<img alt="_images/4c7555d34c908511185691b100752f7247714954ec63c7196a2d5f3cf3a30cd1.png" src="_images/4c7555d34c908511185691b100752f7247714954ec63c7196a2d5f3cf3a30cd1.png" />
</div>
</div>
<div class="alert alert-block alert-warning">
    <b>Statistical Critique: The $R^2$ Paradox</b><br>
    The simulation above highlights the critical danger of relying on $R^2$ for model selection:
    <ol>
        <li><b>The Ground Truth:</b> The data is undeniably linear (generated via <i>y = mx + c</i>).</li>
        <li><b>The Mimicry:</b> The Gompertz model (red solid line) fits the data "perfectly" by mathematically stretching out the rising phase of its S-curve.</li>
        <li><b>The Result:</b> $R^2$ is extremely high (<b>0.9853</b>), falsely implying a perfect model fit.</li>
    </ol>
    <b>Conclusion:</b> $R^2$ only confirms that the curve passes near the data points; it does not validate the underlying structural assumptions. This aligns with the methodological warnings in <i>Thornton et al.</i> (Ref 88, Nature Neuroscience), which caution against using goodness-of-fit measures alone. The decision to prioritize $R^2$ in their Extended Data Figure 8, despite this known limitation, represents a methodological divergence that warrants further clarification with the authors unless I'm missing something. I may have missed an explanation in the text as I was primarily just looking at the figures. 
</div><div class="alert alert-block alert-info">
    <b>Hypothesis Confirmation: Directional Consistency</b><br>
    Practically, the core question is whether VNS enhances regeneration. The Gompertz model (in our biorxiv submission) suggested that VNS-treated animals achieve a significantly higher asymptotic limit for oligodendrocyte replacement.
    <br><br>
    <b>The Question:</b> What if we test this hypothesis in a <b>non-parametric manner</b>, without forcing the data to fit a specific mathematical curve?
    <br><br>
    <b>Prediction:</b> If the effect is robust, a model-free analysis (e.g., Mann-Whitney U on empirical maxima) should confirm that VNS drives significantly greater replacement than unstimulated controls, validating the finding independent of model choice.
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">integrate</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
    
<span class="k">def</span> <span class="nf">analyze_non_parametric</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">smoothing_window_days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>\
                           <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span>\
                           <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs model-free validation:</span>
<span class="sd">    1. Calculates Max Observed Value &amp; AUC per animal.</span>
<span class="sd">    2. Runs Mann-Whitney U Tests (Two-Sided AND One-Sided).</span>
<span class="sd">    3. Plots CUSTOM LOESS curves (Physics-Constrained + Tunable Window).</span>
<span class="sd">    </span>
<span class="sd">    Args:</span>
<span class="sd">        target_greater_group (str): The name of the group you hypothesize is LARGER.</span>
<span class="sd">                                    (e.g., &#39;VNS&#39;).</span>
<span class="sd">        smoothing_window_days (int): The size of the smoothing window in X-axis units (Days).</span>
<span class="sd">                                     Larger = smoother line (less detail).</span>
<span class="sd">                                     Smaller = wigglier line (more noise).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># 1. CLEAN DATA</span>
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># 2. CALCULATE SUMMARY METRICS (Per Animal)</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="k">continue</span> <span class="c1"># Need points to make a curve</span>
            
        <span class="n">x</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="c1"># Metric A: Max Observed Value (The empirical ceiling)</span>
        <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Metric B: AUC (Area Under Curve) - Normalized by duration</span>
        <span class="c1"># This represents &quot;Total Exposure&quot; to replacement over the experiment</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Trapz calculates area using trapezoids connecting the dots</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">trapezoid</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">auc</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="n">metrics_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal</span><span class="p">,</span>
            <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="c1"># strip whitespace</span>
            <span class="s1">&#39;Max_Value&#39;</span><span class="p">:</span> <span class="n">max_val</span><span class="p">,</span>
            <span class="s1">&#39;AUC&#39;</span><span class="p">:</span> <span class="n">auc</span>
        <span class="p">})</span>
        
    <span class="n">df_metrics</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">)</span>
    
    <span class="c1"># 3. STATISTICAL REPORT</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NON-PARAMETRIC ROBUSTNESS CHECK (Mann-Whitney U)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">target_greater_group</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hypothesis Direction: Is </span><span class="si">{</span><span class="n">target_greater_group</span><span class="si">}</span><span class="s2"> &gt; Control?&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hypothesis: Two-Sided (Any Difference)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Need exactly 2 groups. Found: </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    
    <span class="c1"># Identify Target vs Control</span>
    <span class="k">if</span> <span class="n">target_greater_group</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_greater_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: target_greater_group &#39;</span><span class="si">{</span><span class="n">target_greater_group</span><span class="si">}</span><span class="s2">&#39; not found. Available: </span><span class="si">{</span><span class="n">groups</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
             <span class="k">return</span>
        <span class="n">g1_name</span> <span class="o">=</span> <span class="n">target_greater_group</span>
        <span class="n">g2_name</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span> <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="n">target_greater_group</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">g1_name</span><span class="p">,</span> <span class="n">g2_name</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">g1</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g1_name</span><span class="p">]</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="n">df_metrics</span><span class="p">[</span><span class="n">df_metrics</span><span class="p">[</span><span class="s1">&#39;Group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">g2_name</span><span class="p">]</span>
    
    <span class="c1"># Helper for stars</span>
    <span class="k">def</span> <span class="nf">get_stars</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;***&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span>  <span class="k">return</span> <span class="s2">&quot;**&quot;</span>
        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>  <span class="k">return</span> <span class="s2">&quot;*&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;n.s.&quot;</span>

    <span class="c1"># Test both metrics</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Max_Value&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">]:</span>
        <span class="c1"># 1. Two-Sided Test</span>
        <span class="n">u_2</span><span class="p">,</span> <span class="n">p_2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;two-sided&#39;</span><span class="p">)</span>
        
        <span class="c1"># 2. One-Sided Test (Greater)</span>
        <span class="n">u_1</span><span class="p">,</span> <span class="n">p_1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span> <span class="n">alternative</span><span class="o">=</span><span class="s1">&#39;greater&#39;</span><span class="p">)</span>
        
        <span class="n">mean1</span><span class="p">,</span> <span class="n">se1</span> <span class="o">=</span> <span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g1</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span>
        <span class="n">mean2</span><span class="p">,</span> <span class="n">se2</span> <span class="o">=</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">g2</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span><span class="o">.</span><span class="n">sem</span><span class="p">()</span>
        
        <span class="n">stars_2</span> <span class="o">=</span> <span class="n">get_stars</span><span class="p">(</span><span class="n">p_2</span><span class="p">)</span>
        <span class="n">stars_1</span> <span class="o">=</span> <span class="n">get_stars</span><span class="p">(</span><span class="n">p_1</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> (per animal)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">g1_name</span><span class="si">}</span><span class="s2"> (Target): </span><span class="si">{</span><span class="n">mean1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">se1</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g1</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">g2_name</span><span class="si">}</span><span class="s2"> (Control): </span><span class="si">{</span><span class="n">mean2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> ± </span><span class="si">{</span><span class="n">se2</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> (n=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">g2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Two-Sided Mann-Whitney: U=</span><span class="si">{</span><span class="n">u_2</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">p_2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">stars_2</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  One-Sided Mann-Whitney: U=</span><span class="si">{</span><span class="n">u_1</span><span class="si">}</span><span class="s2">, p=</span><span class="si">{</span><span class="n">p_1</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> [</span><span class="si">{</span><span class="n">stars_1</span><span class="si">}</span><span class="s2">] (Testing </span><span class="si">{</span><span class="n">g1_name</span><span class="si">}</span><span class="s2"> &gt; </span><span class="si">{</span><span class="n">g2_name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="c1"># 4. VISUALIZATION: LOESS PLOT</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    <span class="c1"># A. Plot Raw Data (Faint background dots)</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">group_col</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> 
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># B. Plot Smooth Lines (Manual Calculation)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LOESS SMOOTHING DETAILS (Target Window: ~</span><span class="si">{</span><span class="n">smoothing_window_days</span><span class="si">}</span><span class="s2"> Days)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">subset</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span> <span class="k">continue</span>
            
        <span class="n">x_vals</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_vals</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># --- DYNAMIC FRACTION CALCULATION ---</span>
        <span class="c1"># Convert &quot;Days&quot; into the &quot;Fraction&quot; that statsmodels requires</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">x_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">smoothing_window_days</span> <span class="o">/</span> <span class="n">duration</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.3</span>
        
        <span class="c1"># Keep frac within safe bounds (0.05 to 1.0)</span>
        <span class="n">frac</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frac</span><span class="p">))</span>
        
        <span class="c1"># --- MANUAL LOESS CALCULATION ---</span>
        <span class="c1"># Calculate the smooth curve</span>
        <span class="n">lowess</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">nonparametric</span><span class="o">.</span><span class="n">lowess</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">x_vals</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
        <span class="n">lowess_x</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">lowess_y</span> <span class="o">=</span> <span class="n">lowess</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        
        <span class="c1"># --- THE FIX: CLAMP NEGATIVE VALUES ---</span>
        <span class="c1"># Force the curve to respect biology (cannot have negative cells)</span>
        <span class="n">lowess_y_clamped</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">lowess_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># Plot the result</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lowess_x</span><span class="p">,</span> <span class="n">lowess_y_clamped</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Group &#39;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">&#39;: Duration=</span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">d -&gt; using frac=</span><span class="si">{</span><span class="n">frac</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Model-Free Trend (LOESS)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL Replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_non_parametric</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">},</span> <span class="n">target_greater_group</span><span class="o">=</span><span class="s1">&#39;VNS&#39;</span><span class="p">,</span><span class="n">smoothing_window_days</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>================================================================================
NON-PARAMETRIC ROBUSTNESS CHECK (Mann-Whitney U)
Hypothesis Direction: Is VNS &gt; Control?
================================================================================

Metric: Max_Value (per animal)
  VNS (Target): 86.12 ± 8.37 (n=5)
  unstimulated (Control): 58.02 ± 3.73 (n=6)
----------------------------------------
  Two-Sided Mann-Whitney: U=30.0, p=0.0080 [**]
  One-Sided Mann-Whitney: U=30.0, p=0.0040 [**] (Testing VNS &gt; unstimulated)
................................................................................

Metric: AUC (per animal)
  VNS (Target): 40.22 ± 3.37 (n=5)
  unstimulated (Control): 26.87 ± 2.19 (n=6)
----------------------------------------
  Two-Sided Mann-Whitney: U=30.0, p=0.0043 [**]
  One-Sided Mann-Whitney: U=30.0, p=0.0022 [**] (Testing VNS &gt; unstimulated)
................................................................................

============================================================
LOESS SMOOTHING DETAILS (Target Window: ~21 Days)
============================================================
Group &#39;unstimulated&#39;: Duration=76.0d -&gt; using frac=0.28
Group &#39;VNS&#39;: Duration=76.0d -&gt; using frac=0.28
</pre></div>
</div>
<img alt="_images/48e0e1354d8346e5561ff39ede279f8dee71558ead9b97016a342b36e954ef81.png" src="_images/48e0e1354d8346e5561ff39ede279f8dee71558ead9b97016a342b36e954ef81.png" />
</div>
</div>
<div class="alert alert-block alert-warning">
    <b>Critical Insight: The "Artificial Plateau" Problem</b><br>
    The model-free LOESS analysis reveals a crucial feature masked by the previous modeling attempts:
    <ul>
        <li><b>No Plateau:</b> The VNS group (purple trace) does not show signs of saturation; the replacement rate continues to climb even at the end of the imaging window.</li>
        <li><b>The Error of Asymptotes:</b> Because the data has not yet plateaued, the Gompertz model was forced to mathematically "guess" where the ceiling would eventually be. This extrapolation likely underestimated the true divergence between the groups by artificially pulling the VNS asymptote down to fit the available window.</li>
    </ul>
    <b>Conclusion:</b> Since we cannot measure every animal every day, and we cannot force a plateau where none exists, the robust solution is <b>Statistical Estimation via Gaussian Processes</b>. This will allow us to compare the probability distributions of the curves themselves without imposing a rigid functional shape.
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.gaussian_process</span> <span class="kn">import</span> <span class="n">GaussianProcessRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.gaussian_process.kernels</span> <span class="kn">import</span> <span class="n">RBF</span><span class="p">,</span> <span class="n">WhiteKernel</span><span class="p">,</span> <span class="n">ConstantKernel</span> <span class="k">as</span> <span class="n">C</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
</pre></div>
</div>
</div>
</details>
</div>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. HELPER: GENERATE HIERARCHICAL CURVES (PRE-FIT)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_individual_gp_curves</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fits a GP to each animal individually and returns the predicted curves.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="n">curves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="c1"># Kernel: RBF for shape + WhiteKernel for individual animal noise</span>
    <span class="n">base_kernel</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">60</span><span class="p">))</span> <span class="o">+</span> \
                  <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">noise_level_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="c1"># Get Group</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="c1"># Fit GP</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">base_kernel</span><span class="p">,</span> <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="c1"># Predict on common grid</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># STRICT MASKING (No Extrapolation)</span>
        <span class="n">min_d</span><span class="p">,</span> <span class="n">max_d</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">y_pred</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">min_d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">y_pred</span><span class="p">[</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_d</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">curves</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
        
    <span class="k">return</span> <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. STATISTICAL ENGINE (HIERARCHICAL LIKELIHOOD)</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_hierarchical_D</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">group_assignments</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates D = 2 * (LL_Separate - LL_Shared) based on curve distributions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. SHARED MODEL (Grand Mean &amp; Variance)</span>
    <span class="n">mu_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span> 
    
    <span class="c1"># Log-Likelihood (Shared)</span>
    <span class="n">resid_sq_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">curve_matrix</span> <span class="o">-</span> <span class="n">mu_all</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">ll_terms_all</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_all</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_all</span><span class="p">))</span>
    <span class="n">LL_shared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ll_terms_all</span><span class="p">)</span>

    <span class="c1"># 2. SEPARATE MODELS</span>
    <span class="n">LL_separate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">curve_matrix</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        
        <span class="c1"># Group Parameters</span>
        <span class="n">mu_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
        
        <span class="c1"># Group Likelihood</span>
        <span class="n">resid_sq_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_matrix</span> <span class="o">-</span> <span class="n">mu_g</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">ll_terms_g</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_g</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_g</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_g</span><span class="p">))</span>
        <span class="n">LL_separate</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ll_terms_g</span><span class="p">)</span>
        
    <span class="c1"># 3. STATISTIC</span>
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">LL_separate</span> <span class="o">-</span> <span class="n">LL_shared</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_rolling_hierarchical_permutation</span><span class="p">(</span><span class="n">curve_dict</span><span class="p">,</span> <span class="n">label_dict</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> 
                                         <span class="n">start_day</span><span class="p">,</span> <span class="n">end_day</span><span class="p">,</span> 
                                         <span class="n">window_size</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> 
                                         <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Slides a window across the curves and runs stats.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curve_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">full_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curve_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span> 
    <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">label_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>
    
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">random_state</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_start</span> <span class="o">=</span> <span class="n">start_day</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running Rolling Stats (Window=</span><span class="si">{</span><span class="n">window_size</span><span class="si">}</span><span class="s2">d, Step=</span><span class="si">{</span><span class="n">step_size</span><span class="si">}</span><span class="s2">d, N=</span><span class="si">{</span><span class="n">n_permutations</span><span class="si">}</span><span class="s2">)...&quot;</span><span class="p">)</span>
    
    <span class="k">while</span> <span class="n">curr_start</span> <span class="o">+</span> <span class="n">window_size</span> <span class="o">&lt;=</span> <span class="n">end_day</span><span class="p">:</span>
        <span class="n">curr_end</span> <span class="o">=</span> <span class="n">curr_start</span> <span class="o">+</span> <span class="n">window_size</span>
        
        <span class="c1"># Mask curves for this window</span>
        <span class="n">window_curves</span> <span class="o">=</span> <span class="n">full_curves</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">curr_start</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">curr_end</span><span class="p">)</span>
        <span class="n">window_curves</span><span class="p">[:,</span> <span class="n">mask_indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="c1"># Calculate Observed D</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">D_obs</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">window_curves</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">curr_start</span> <span class="o">+=</span> <span class="n">step_size</span>
            <span class="k">continue</span>

        <span class="c1"># Permutation Loop</span>
        <span class="n">null_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_permutations</span><span class="p">):</span>
            <span class="n">shuffled_labels</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">true_labels</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">D_null</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">window_curves</span><span class="p">,</span> <span class="n">shuffled_labels</span><span class="p">)</span>
                <span class="n">null_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">D_null</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">null_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">null_scores</span> <span class="o">&gt;=</span> <span class="n">D_obs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">null_scores</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">p_val</span><span class="p">))</span>
            
        <span class="n">curr_start</span> <span class="o">+=</span> <span class="n">step_size</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Rolling Stats Complete.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">merge_significant_windows</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merges overlapping or continuous windows into single blocks.</span>
<span class="sd">    Tracks the MINIMUM p-value (peak significance) for that block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="c1"># Sort by start time</span>
    <span class="n">windows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="n">merged</span>
    
    <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">windows</span><span class="p">)):</span>
        <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span> <span class="n">next_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="c1"># Check overlap (next start &lt;= curr end)</span>
        <span class="c1"># We allow a small epsilon for float precision</span>
        <span class="k">if</span> <span class="n">next_start</span> <span class="o">&lt;=</span> <span class="n">curr_end</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span> 
            <span class="n">curr_end</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_end</span><span class="p">,</span> <span class="n">next_end</span><span class="p">)</span>
            <span class="n">curr_min_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_min_p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">)</span> <span class="c1"># Keep strongest significance</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span><span class="p">))</span>
            <span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span> <span class="o">=</span> <span class="n">next_start</span><span class="p">,</span> <span class="n">next_end</span><span class="p">,</span> <span class="n">next_p</span>
            
    <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_start</span><span class="p">,</span> <span class="n">curr_end</span><span class="p">,</span> <span class="n">curr_min_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. MAIN WRAPPER</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="k">def</span> <span class="nf">analyze_gaussian_process</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                             <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> 
                             <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                             <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">,</span>
                             <span class="n">constant_sem</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
    
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    
    <span class="c1"># Grid Setup</span>
    <span class="n">global_min</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">global_max</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">global_min</span><span class="p">,</span> <span class="n">global_max</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># --- 1. FIT INDIVIDUALS ---</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STEP 1: Generating Individual GP Curves...&quot;</span><span class="p">)</span>
    <span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span> <span class="o">=</span> <span class="n">get_individual_gp_curves</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    
    <span class="c1"># --- 2. ROLLING STATISTICS ---</span>
    <span class="n">merged_sig_windows</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;STEP 2: Running Rolling Hierarchical Permutation...&quot;</span><span class="p">)</span>
        <span class="n">stats_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">global_min</span><span class="p">)</span> 
        <span class="n">stats_end</span> <span class="o">=</span> <span class="n">global_max</span>
        
        <span class="n">raw_windows</span> <span class="o">=</span> <span class="n">run_rolling_hierarchical_permutation</span><span class="p">(</span><span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span>
                                                           <span class="n">start_day</span><span class="o">=</span><span class="n">stats_start</span><span class="p">,</span> 
                                                           <span class="n">end_day</span><span class="o">=</span><span class="n">stats_end</span><span class="p">,</span>
                                                           <span class="n">window_size</span><span class="o">=</span><span class="n">stats_window_size</span><span class="p">,</span>
                                                           <span class="n">step_size</span><span class="o">=</span><span class="n">stats_step_size</span><span class="p">,</span>
                                                           <span class="n">n_permutations</span><span class="o">=</span><span class="n">n_permutations</span><span class="p">,</span>
                                                           <span class="n">random_state</span><span class="o">=</span><span class="n">random_state</span><span class="p">)</span>
        <span class="c1"># Filter for raw significance first</span>
        <span class="n">sig_windows</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw_windows</span> <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">]</span>
        
        <span class="c1"># Merge overlapping windows</span>
        <span class="n">merged_sig_windows</span> <span class="o">=</span> <span class="n">merge_significant_windows</span><span class="p">(</span><span class="n">sig_windows</span><span class="p">)</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">60</span><span class="p">)</span>

    <span class="c1"># --- 3. PLOTTING ---</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">group_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_ids</span><span class="p">:</span> <span class="k">continue</span>
        
        <span class="n">group_curve_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">group_ids</span><span class="p">])</span>
        
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">group_curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_variable</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">group_curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">constant_sem</span><span class="p">:</span>
                <span class="n">avg_sem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sem_variable</span><span class="p">)</span>
                <span class="n">sem_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">mean_curve</span><span class="p">,</span> <span class="n">avg_sem</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sem_plot</span> <span class="o">=</span> <span class="n">sem_variable</span>
                
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_plot</span><span class="p">,</span> <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_plot</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        
        <span class="n">sub</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">]</span>
        <span class="c1"># plt.scatter(sub[x_col], sub[y_col], color=color, alpha=0.4, s=20)</span>
        
        <span class="c1"># Track Max Y</span>
        <span class="n">curr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curr_max</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">curr_max</span>
        <span class="k">if</span> <span class="n">sub</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_y</span><span class="p">:</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">sub</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># --- 4. PLOT MERGED BARS ---</span>
    <span class="k">if</span> <span class="n">merged_sig_windows</span><span class="p">:</span>
        <span class="n">base_y</span> <span class="o">=</span> <span class="mi">100</span><span class="c1">#max_y * 1.05</span>
        
        <span class="k">for</span> <span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span><span class="p">,</span> <span class="n">min_p</span> <span class="ow">in</span> <span class="n">merged_sig_windows</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.001</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span>
            <span class="k">elif</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;**&quot;</span>
            <span class="k">elif</span> <span class="n">min_p</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span> <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;*&quot;</span>
            <span class="k">else</span><span class="p">:</span> <span class="k">continue</span>
            
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">w_start</span> <span class="o">+</span> <span class="n">w_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            
            <span class="c1"># Draw line</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">w_start</span><span class="p">,</span> <span class="n">w_end</span><span class="p">],</span> <span class="p">[</span><span class="n">base_y</span><span class="p">,</span> <span class="n">base_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Add star</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">base_y</span> <span class="o">*</span> <span class="mf">1.01</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">85</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="c1"># plt.title(&quot;Hierarchical GP with Rolling Significance&quot;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL</span><span class="se">\n</span><span class="s2">replacement (%)&quot;</span><span class="p">)</span>
    <span class="c1"># plt.legend(loc=&#39;upper left&#39;)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="n">group_names</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">palette</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># Sort to ensure consistent filename order</span>
    <span class="n">camel_case_groups</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[^a-zA-Z0-9]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">group_names</span><span class="p">])</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;totalOLReplacement&quot;</span> <span class="o">+</span> <span class="n">camel_case_groups</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_gaussian_process</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">},</span>\
                         <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>============================================================
STEP 1: Generating Individual GP Curves...
STEP 2: Running Rolling Hierarchical Permutation...
Running Rolling Stats (Window=5d, Step=2d, N=1000)...

Rolling Stats Complete.
============================================================
</pre></div>
</div>
<img alt="_images/ccdaa937f558b9c8ad7c85a4d5e3db2f41eeaa2f51ec2799a1110d658c5148d1.png" src="_images/ccdaa937f558b9c8ad7c85a4d5e3db2f41eeaa2f51ec2799a1110d658c5148d1.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: Divergence in Late-Stage Regeneration</b><br>
    The Hierarchical Gaussian Process analysis identifies a specific temporal window of significant divergence between VNS and unstimulated groups:
    <ul>
        <li><b>Late-Phase Separation:</b> The rolling permutation test (black bar with stars) reveals that the VNS-induced increase in oligodendrocyte replacement becomes statistically significant approximately 21 days post-cuprizone and persists for a while.</li>
        <li><b>Confirmation of Non-Saturation:</b> Consistent with the LOESS analysis, the GP mean traces (solid lines) confirm that the VNS group continues to rise, avoiding the artificial "plateau" forced by the earlier Gompertz fit.</li>
    </ul>
</div><div class="alert alert-block alert-info">
    <b>Methodological Synthesis: The Hybrid Model</b><br>
    Given the strengths and weaknesses of the approaches tested above, we conclude that a <b>Hybrid Model</b> provides the most accurate representation of the biological reality:
    <ol>
        <li><b>Biologically Grounded Shape (Gompertz):</b> The underlying biology of regeneration implies a growth process that typically follows an S-curve (as argued by <i>Thornton et al.</i>, Ref 88). Uncontrolled, infinite linear growth is biologically implausible. Therefore, the Gompertz function remains the best <i>structural</i> basis for the model.</li>
        <li><b>Uncertainty & Noise (Gaussian Process):</b> To account for inter-scorer variability, missing data points, and longitudinal noise, the Gaussian Process is essential for robustly quantifying uncertainty (shaded ribbons).</li>
        <li><b>Temporal Expansion:</b> The raw data and model-free trends indicate that regeneration has not yet plateaued by Day 60. Therefore, the final model must <b>expand the longitudinal time domain</b> to allow the Gompertz curve to naturally find its asymptote without being artificially compressed into the existing observation window.</li>
    </ol>
</div><div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 1. THE HYBRID MODEL CLASS</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">class</span> <span class="nc">GompertzGP_Uncapped</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">GaussianProcessRegressor</span><span class="p">(</span>
            <span class="n">kernel</span><span class="o">=</span><span class="n">RBF</span><span class="p">(</span><span class="n">length_scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">length_scale_bounds</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">120</span><span class="p">))</span> <span class="o">+</span> 
                   <span class="n">WhiteKernel</span><span class="p">(</span><span class="n">noise_level</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">noise_level_bounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">2</span><span class="p">)),</span>
            <span class="n">n_restarts_optimizer</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
            <span class="n">normalize_y</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_gompertz_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span> <span class="o">*</span> <span class="n">t</span>
        <span class="n">exponent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">exponent</span><span class="p">,</span> <span class="o">-</span><span class="mi">700</span><span class="p">,</span> <span class="mi">700</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exponent</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_y</span> <span class="o">*</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">]</span> 
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">500</span><span class="p">,</span> <span class="mi">5000</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="p">,</span> 
                                                <span class="n">p0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">ideal_trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">)</span>
        <span class="n">residuals</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ideal_trend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">residuals</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">trend</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gompertz_func</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span><span class="p">)</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">return_std</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">trend</span> <span class="o">+</span> <span class="n">correction</span>

    <span class="k">def</span> <span class="nf">get_biological_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gompertz_params</span>
        <span class="n">asymptote</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">inflection_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inflection_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">asymptote</span><span class="p">,</span> <span class="n">inflection_time</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 2. DATA EXTRACTION</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">get_hybrid_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">grid</span><span class="p">):</span>
    <span class="n">curves</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">animals</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting Hybrid Models for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">animals</span><span class="p">)</span><span class="si">}</span><span class="s2"> mice...&quot;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">animal</span> <span class="ow">in</span> <span class="n">animals</span><span class="p">:</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">id_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">animal</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">x_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span> <span class="k">continue</span> 
        
        <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subset</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">subset</span><span class="p">[</span><span class="n">y_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">GompertzGP_Uncapped</span><span class="p">()</span>
        <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
        <span class="n">curves</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>
        <span class="n">labels</span><span class="p">[</span><span class="n">animal</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
        
        <span class="n">asymp</span><span class="p">,</span> <span class="n">inflect</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">get_biological_parameters</span><span class="p">()</span>
        <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="n">animal</span><span class="p">,</span> <span class="s1">&#39;Group&#39;</span><span class="p">:</span> <span class="n">group</span><span class="p">,</span>
            <span class="s1">&#39;Asymptote&#39;</span><span class="p">:</span> <span class="n">asymp</span><span class="p">,</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">:</span> <span class="n">inflect</span>
        <span class="p">})</span>
        
    <span class="k">return</span> <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 3. STATS ENGINES</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">calculate_hierarchical_D</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">group_assignments</span><span class="p">):</span>
    <span class="n">mu_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">var_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">curve_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span> 
    <span class="n">resid_sq_all</span> <span class="o">=</span> <span class="p">(</span><span class="n">curve_matrix</span> <span class="o">-</span> <span class="n">mu_all</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">LL_shared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_all</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_all</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_all</span><span class="p">)))</span>

    <span class="n">LL_separate</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">unique_groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">unique_groups</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_assignments</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">g</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">sub_matrix</span> <span class="o">=</span> <span class="n">curve_matrix</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">mu_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">var_g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">sub_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
        <span class="n">resid_sq_g</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_matrix</span> <span class="o">-</span> <span class="n">mu_g</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">LL_separate</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">var_g</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">resid_sq_g</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">var_g</span><span class="p">)))</span>
        
    <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">LL_separate</span> <span class="o">-</span> <span class="n">LL_shared</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">run_rolling_stats</span><span class="p">(</span><span class="n">curves_dict</span><span class="p">,</span> <span class="n">labels_dict</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">start_day</span><span class="p">,</span> <span class="n">end_day</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">n_perm</span><span class="p">):</span>
    <span class="n">ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">curves_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">full_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span> 
    <span class="n">true_labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">labels_dict</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">])</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">curr</span> <span class="o">=</span> <span class="n">start_day</span>
    <span class="k">while</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">window</span> <span class="o">&lt;=</span> <span class="n">end_day</span><span class="p">:</span>
        <span class="n">w_curves</span> <span class="o">=</span> <span class="n">full_curves</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">curr</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">curr</span> <span class="o">+</span> <span class="n">window</span><span class="p">)</span>
        <span class="n">w_curves</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">D_obs</span> <span class="o">=</span> <span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">w_curves</span><span class="p">,</span> <span class="n">true_labels</span><span class="p">)</span>
            <span class="n">nulls</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_hierarchical_D</span><span class="p">(</span><span class="n">w_curves</span><span class="p">,</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">true_labels</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">)]</span>
            <span class="n">p_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nulls</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">D_obs</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr</span><span class="p">,</span> <span class="n">curr</span><span class="o">+</span><span class="n">window</span><span class="p">,</span> <span class="n">p_val</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
        <span class="n">curr</span> <span class="o">+=</span> <span class="n">step</span>
    <span class="k">return</span> <span class="n">results</span>

<span class="k">def</span> <span class="nf">merge_significant_windows</span><span class="p">(</span><span class="n">windows</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">windows</span><span class="p">:</span> <span class="k">return</span> <span class="p">[]</span>
    <span class="n">windows</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">merged</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span> <span class="o">=</span> <span class="n">windows</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">next_s</span><span class="p">,</span> <span class="n">next_e</span><span class="p">,</span> <span class="n">next_p</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">if</span> <span class="n">next_s</span> <span class="o">&lt;=</span> <span class="n">curr_e</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">curr_e</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">curr_e</span><span class="p">,</span> <span class="n">next_e</span><span class="p">)</span>
            <span class="n">curr_p</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">curr_p</span><span class="p">,</span> <span class="n">next_p</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span><span class="p">))</span>
            <span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span> <span class="o">=</span> <span class="n">next_s</span><span class="p">,</span> <span class="n">next_e</span><span class="p">,</span> <span class="n">next_p</span>
    <span class="n">merged</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">curr_s</span><span class="p">,</span> <span class="n">curr_e</span><span class="p">,</span> <span class="n">curr_p</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">merged</span>

<span class="k">def</span> <span class="nf">permutation_test_params_median</span><span class="p">(</span><span class="n">df_params</span><span class="p">,</span> <span class="n">metric_col</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">,</span> <span class="n">n_perm</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;N/A&quot;</span>
    <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">vals1</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">g1</span><span class="p">][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals2</span> <span class="o">=</span> <span class="n">df_params</span><span class="p">[</span><span class="n">df_params</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">g2</span><span class="p">][</span><span class="n">metric_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span> <span class="o">=</span> <span class="n">vals1</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals1</span><span class="p">)],</span> <span class="n">vals2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">vals2</span><span class="p">)]</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="s2">&quot;Insufficient Data&quot;</span>
    
    <span class="n">obs_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals2</span><span class="p">)</span>
    <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">])</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals1</span><span class="p">)</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">null_diffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_perm</span><span class="p">):</span>
        <span class="n">shuffled</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
        <span class="n">null_diffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">shuffled</span><span class="p">[:</span><span class="n">n1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">shuffled</span><span class="p">[</span><span class="n">n1</span><span class="p">:]))</span>
        
    <span class="n">p_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">null_diffs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obs_diff</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_perm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;Comparison&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s2"> vs </span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s1">&#39;Metric&#39;</span><span class="p">:</span> <span class="n">metric_col</span><span class="p">,</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals1</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">iqr</span><span class="p">(</span><span class="n">vals1</span><span class="p">),</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">vals2</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">:</span> <span class="n">stats</span><span class="o">.</span><span class="n">iqr</span><span class="p">(</span><span class="n">vals2</span><span class="p">),</span>
        <span class="s1">&#39;P_Value&#39;</span><span class="p">:</span> <span class="n">p_value</span>
    <span class="p">}</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># 4. MAIN FUNCTION</span>
<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">analyze_hybrid_process</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">palette</span><span class="p">,</span> 
                           <span class="n">stats_window_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">n_permutations</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> 
                           <span class="n">id_col</span><span class="o">=</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Behavior&#39;</span><span class="p">,</span> 
                           <span class="n">x_col</span><span class="o">=</span><span class="s1">&#39;DaysSinceCup&#39;</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;Total OL Replacement %&#39;</span><span class="p">,</span>
                           <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="n">df_clean</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    
    <span class="n">data_min</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">x_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="n">projection_max</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># &lt;--- CUT X-AXIS AT 75 DAYS</span>
    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">df_params</span> <span class="o">=</span> <span class="n">get_hybrid_data</span><span class="p">(</span><span class="n">df_clean</span><span class="p">,</span> <span class="n">id_col</span><span class="p">,</span> <span class="n">group_col</span><span class="p">,</span> <span class="n">x_col</span><span class="p">,</span> <span class="n">y_col</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">HYBRID PARAMETER STATISTICS (Permutation of MEDIANS, N=10000)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">asymp_p_val</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">inflect_medians</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Asymptote&#39;</span><span class="p">,</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">]:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">permutation_test_params_median</span><span class="p">(</span><span class="n">df_params</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">group_col</span><span class="o">=</span><span class="s1">&#39;Group&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">g1</span><span class="p">,</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;Comparison&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; vs &#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Metric: </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g1</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: Median=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.2f</span><span class="si">}</span><span class="s2"> (IQR=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">g2</span><span class="si">:</span><span class="s2">15</span><span class="si">}</span><span class="s2">: Median=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">6.2f</span><span class="si">}</span><span class="s2"> (IQR=</span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_IQR&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">4.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;P-Value        : </span><span class="si">{</span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.5f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39;*&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Asymptote&#39;</span><span class="p">:</span> <span class="n">asymp_p_val</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;P_Value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;Inflection_Day&#39;</span><span class="p">:</span>
                <span class="n">inflect_medians</span><span class="p">[</span><span class="n">g1</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g1</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span>
                <span class="n">inflect_medians</span><span class="p">[</span><span class="n">g2</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">g2</span><span class="si">}</span><span class="s1">_Median&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">SLIDING WINDOW STATISTICS (Trajectory)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;=&quot;</span><span class="o">*</span><span class="mi">80</span><span class="p">)</span>
    <span class="n">raw_wins</span> <span class="o">=</span> <span class="n">run_rolling_stats</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">x_grid</span><span class="p">,</span> <span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span><span class="p">,</span> 
                                 <span class="n">stats_window_size</span><span class="p">,</span> <span class="n">stats_step_size</span><span class="p">,</span> <span class="n">n_permutations</span><span class="p">)</span>
    <span class="n">sig_wins</span> <span class="o">=</span> <span class="n">merge_significant_windows</span><span class="p">([</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">raw_wins</span> <span class="k">if</span> <span class="n">w</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">sig_wins</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Significant Windows found: </span><span class="si">{</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">s</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">e</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">p</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sig_wins</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No significant windows found.&quot;</span><span class="p">)</span>

    <span class="c1"># --- PLOTTING ---</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">df_clean</span><span class="p">[</span><span class="n">group_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">max_y_plotted</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">group_means</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        <span class="n">g_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">g_ids</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">g_curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">curves</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">g_ids</span><span class="p">])</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="n">mean_curve</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">g_curves</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">sem_curve</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">g_curves</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nan_policy</span><span class="o">=</span><span class="s1">&#39;omit&#39;</span><span class="p">)</span>
            
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">mean_curve</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">group</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> 
                         <span class="n">mean_curve</span> <span class="o">-</span> <span class="n">sem_curve</span><span class="p">,</span> <span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">,</span> 
                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_y_plotted</span><span class="p">:</span> 
            <span class="n">max_y_plotted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">mean_curve</span> <span class="o">+</span> <span class="n">sem_curve</span><span class="p">)</span>
        <span class="n">group_means</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_grid</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">mean_curve</span><span class="p">)</span>

    <span class="c1"># Sliding Window Significance Bars</span>
    <span class="k">if</span> <span class="n">sig_wins</span><span class="p">:</span>
        <span class="n">bar_height</span> <span class="o">=</span> <span class="n">max_y_plotted</span> <span class="o">*</span> <span class="mf">1.05</span>
        <span class="k">for</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig_wins</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="s2">&quot;**&quot;</span> <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="p">[</span><span class="n">bar_height</span><span class="p">,</span> <span class="n">bar_height</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">bar_height</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

    <span class="c1"># --- NEW: Asymptote Significance Bracket ---</span>
    <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.05</span><span class="p">:</span>
        <span class="c1"># Find end-point Y-values for the bracket</span>
        <span class="n">y_end_values</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">g_name</span> <span class="ow">in</span> <span class="n">group_means</span><span class="p">:</span>
            <span class="c1"># Get the Y-value at the last timepoint of the projection</span>
            <span class="n">y_end</span> <span class="o">=</span> <span class="n">group_means</span><span class="p">[</span><span class="n">g_name</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> 
            <span class="n">y_end_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_end</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y_low</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span>
            <span class="n">y_high</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">y_end_values</span><span class="p">)</span>
            <span class="n">x_pos</span> <span class="o">=</span> <span class="n">projection_max</span> <span class="o">+</span> <span class="mi">2</span>  <span class="c1"># Place bracket slightly to the right</span>
            
            <span class="c1"># Draw the bracket</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="p">],</span> <span class="p">[</span><span class="n">y_low</span><span class="p">,</span> <span class="n">y_high</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y_low</span><span class="p">,</span> <span class="n">y_low</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x_pos</span><span class="p">,</span> <span class="n">x_pos</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">y_high</span><span class="p">,</span> <span class="n">y_high</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
            
            <span class="c1"># Add the star</span>
            <span class="n">star</span> <span class="o">=</span> <span class="s2">&quot;***&quot;</span> <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="k">else</span> <span class="s2">&quot;**&quot;</span> <span class="k">if</span> <span class="n">asymp_p_val</span> <span class="o">&lt;</span> <span class="mf">0.01</span> <span class="k">else</span> <span class="s2">&quot;*&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">y_low</span> <span class="o">+</span> <span class="n">y_high</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">star</span><span class="p">,</span> 
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="c1"># --- NEW: Inflection Point Markers ---</span>
    <span class="k">for</span> <span class="n">group</span><span class="p">,</span> <span class="n">median_inflect</span> <span class="ow">in</span> <span class="n">inflect_medians</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">color</span> <span class="o">=</span> <span class="n">palette</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="s1">&#39;gray&#39;</span><span class="p">)</span>
        
        <span class="c1"># Find Y-value on the mean curve at the inflection point</span>
        <span class="n">x_vec</span><span class="p">,</span> <span class="n">y_vec</span> <span class="o">=</span> <span class="n">group_means</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_vec</span> <span class="o">-</span> <span class="n">median_inflect</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">()</span>
        <span class="n">y_inflect</span> <span class="o">=</span> <span class="n">y_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="c1"># Plot dashed line and marker</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">median_inflect</span><span class="p">,</span> <span class="n">median_inflect</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="n">y_inflect</span><span class="p">],</span> 
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">median_inflect</span><span class="p">,</span> <span class="n">y_inflect</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="c1"># --- REMOVED: Data End Line ---</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">npl</span><span class="o">.</span><span class="n">epochplot</span><span class="p">(</span><span class="n">nel</span><span class="o">.</span><span class="n">EpochArray</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">8</span><span class="p">]]),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span> <span class="k">pass</span>
    
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_right</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">npl</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">clear_top</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">data_min</span><span class="p">,</span> <span class="n">projection_max</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="c1"># Add space for the bracket</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">75</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Days post-cuprizone&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Total OL</span><span class="se">\n</span><span class="s2">replacement (%)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">filename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">f_name</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">analyze_hybrid_process</span><span class="p">(</span><span class="n">df_fig1</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;VNS&#39;</span><span class="p">:</span> <span class="s1">&#39;#9b4bffff&#39;</span><span class="p">,</span> <span class="s1">&#39;unstimulated&#39;</span><span class="p">:</span> <span class="s1">&#39;#5dbd84ff&#39;</span><span class="p">},</span><span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Fitting Hybrid Models for 11 mice...

================================================================================
HYBRID PARAMETER STATISTICS (Permutation of MEDIANS, N=10000)
================================================================================

Metric: Asymptote
unstimulated   : Median= 57.03 (IQR=16.95)
VNS            : Median= 85.82 (IQR=32.56)
P-Value        : 0.02410 *

Metric: Inflection_Day
unstimulated   : Median=  6.33 (IQR=1.64)
VNS            : Median= 10.01 (IQR=6.49)
P-Value        : 0.20638 

================================================================================
SLIDING WINDOW STATISTICS (Trajectory)
================================================================================
Significant Windows found: [&#39;21.0-75.0&#39;]
</pre></div>
</div>
<img alt="_images/d3e710ff6d05565d18814831267c86c5d84c8859fc4339fc656335b75c14387e.png" src="_images/d3e710ff6d05565d18814831267c86c5d84c8859fc4339fc656335b75c14387e.png" />
</div>
</div>
<div class="alert alert-block alert-success">
    <b>Conclusion: VNS Drives a Robust Increase in Regenerative Capacity</b><br>
    The Hybrid Gompertz-GP model confirms that VNS fundamentally alters the magnitude of long-term repair:
    <ul>
        <li><b>Higher Ceiling (Asymptote):</b> VNS-treated animals achieve a significantly higher median theoretical maximum for oligodendrocyte replacement (<b>85.82%</b>) compared to unstimulated controls (<b>57.03%</b>; <i>p = 0.0241</i>). This indicates that VNS recruits a larger pool of precursor cells or enhances their survival.</li>
        <li><b>Divergence Window:</b> The sliding window analysis (black bar) pinpoints the divergence to the late phase of regeneration. The groups separate significantly starting at <b>Day 21</b> post-cuprizone and remain distinct through the end of the projection (Day 75), confirming that the effect is sustained.</li>
        <li><b>Unaltered Kinetics:</b> The median time to peak growth (Inflection Day) was not significantly different between groups (<i>p = 0.206</i>), suggesting that VNS amplifies the <i>amplitude</i> of the regenerative response without shifting its temporal onset.</li>
    </ul>
</div><div class="alert alert-block alert-info">
    <b>Methodological Justification: Why the Hybrid Model is More Robust</b><br>
    Standard parametric fitting (Gompertz alone) and the Hybrid Gompertz-GP approach yield different insights because they manage <b>uncertainty</b> and <b>model rigidity</b> differently:
    <ul>
        <li><b>Solving the "Forced Plateau":</b> A standard Gompertz fit minimizes error by forcing the curve to flatten as soon as possible. When the biological data (like the VNS group) is still rising at the end of the experiment, the standard model often underestimates the true asymptote to "cap" the error. The Hybrid model allows the Gaussian Process to absorb these late-stage deviations, revealing the true, higher trajectory.</li>
        <li><b>The Best of Both Worlds:</b> Pure non-parametric models (like LOESS) are too wiggly and lack biological meaning. Pure parametric models (Gompertz) are too rigid. The Hybrid approach uses the Gompertz curve as a <i>"Prior Belief"</i> (biology follows an S-curve) but allows the Gaussian Process to update that belief based on the <i>"Evidence"</i> (the actual data), providing a statistically rigorous middle ground.</li>
        <li><b>Quantifying the Unknown:</b> Unlike a simple regression line, the Hybrid model generates a probability distribution (the shaded ribbons). This ensures that our claims of significance are not based on a single "best fit" line, but on the overlap of thousands of probable biological outcomes.</li>
    </ul>
</div></section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="panel-h-ol-replacement-rate-post-stimulation">
<h1>Panel h (OL Replacement Rate Post-stimulation)<a class="headerlink" href="#panel-h-ol-replacement-rate-post-stimulation" title="Permalink to this heading">#</a></h1>
<p><img alt="Figure 1 Panel H" src="_images/panelH.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- PANEL H DATA (Post-Stimulation Rate) ---</span>
<span class="n">data_h</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Factor&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Group Effect (VNS vs Control)&quot;</span><span class="p">,</span> <span class="s2">&quot;Time Effect (Week)&quot;</span><span class="p">,</span> <span class="s2">&quot;Interaction (Group × Week)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;OL Replacement Rate (Post-Stimulation)&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Least Squares Regression Model&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.0194 (*)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0006 (***)&quot;</span><span class="p">,</span> <span class="s2">&quot;0.2048 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;VNS accelerates repair rate&quot;</span><span class="p">,</span> <span class="s2">&quot;Rate decreases over time naturally&quot;</span><span class="p">,</span> <span class="s2">&quot;Parallel decline (no interaction)&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_h</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_h</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_h</span><span class="p">,</span> <span class="s2">&quot;--- Panel H Statistics: Sustained Acceleration of Repair ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel H Statistics: Sustained Acceleration of Repair ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Factor</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Group Effect (VNS vs Control)</td>
      <td>OL Replacement Rate (Post-Stimulation)</td>
      <td>Least Squares Regression Model</td>
      <td>0.0194 (*)</td>
      <td>VNS accelerates repair rate</td>
    </tr>
    <tr>
      <td>Time Effect (Week)</td>
      <td>OL Replacement Rate (Post-Stimulation)</td>
      <td>Least Squares Regression Model</td>
      <td>0.0006 (***)</td>
      <td>Rate decreases over time naturally</td>
    </tr>
    <tr>
      <td>Interaction (Group × Week)</td>
      <td>OL Replacement Rate (Post-Stimulation)</td>
      <td>Least Squares Regression Model</td>
      <td>0.2048 (n.s.)</td>
      <td>Parallel decline (no interaction)</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: VNS Accelerates the Kinetics of Repair</b><br>
    Analysis of the oligodendrocyte replacement rate during the post-stimulation phase reveals a sustained kinetic advantage:
    <ul>
        <li><b>Acceleration (Group Effect):</b> VNS-treated animals exhibited a significantly higher rate of new cell addition compared to controls (<i>p = 0.0194</i>).</li>
        <li><b>Natural Decay (Time Effect):</b> Both groups showed a significant decrease in replacement rate over time (<i>p = 0.0006</i>), which is expected as the regenerative pool becomes exhausted or the tissue approaches saturation.</li>
        <li><b>Sustained Advantage:</b> The lack of a significant interaction (<i>p = 0.2048</i>) indicates that the VNS group maintained its "speed advantage" parallel to controls, rather than converging quickly back to baseline levels.</li>
    </ul>
</div><section id="panel-i-max-ol-replacement-post-stimulation">
<h2>Panel i (Max OL Replacement Post-stimulation)<a class="headerlink" href="#panel-i-max-ol-replacement-post-stimulation" title="Permalink to this heading">#</a></h2>
<p><img alt="Figure 1 Panel I" src="_images/panelI.svg" /></p>
<div class="cell tag_hide-input docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- PANEL I DATA (Maximum Velocity) ---</span>
<span class="n">data_i</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Comparison&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;VNS vs. Unstimulated Controls&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Metric&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Maximum OL Replacement Rate (Peak Velocity)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Test&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Welch&#39;s Test&quot;</span><span class="p">],</span>
    <span class="s2">&quot;P-Value&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;0.12 (n.s.)&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Conclusion&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;No change in peak regeneration speed&quot;</span><span class="p">]</span>
<span class="p">}</span>
<span class="n">df_i</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_i</span><span class="p">)</span>

<span class="c1"># Display</span>
<span class="n">pretty_print_stats</span><span class="p">(</span><span class="n">df_i</span><span class="p">,</span> <span class="s2">&quot;--- Panel I Statistics: Physiological Constraints ---&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</details>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--- Panel I Statistics: Physiological Constraints ---
</pre></div>
</div>
<div class="output text_html"><table border="1" class="dataframe table table-striped table-hover">
  <thead>
    <tr style="text-align: left;">
      <th>Comparison</th>
      <th>Metric</th>
      <th>Test</th>
      <th>P-Value</th>
      <th>Conclusion</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>VNS vs. Unstimulated Controls</td>
      <td>Maximum OL Replacement Rate (Peak Velocity)</td>
      <td>Welch's Test</td>
      <td>0.12 (n.s.)</td>
      <td>No change in peak regeneration speed</td>
    </tr>
  </tbody>
</table></div></div>
</div>
<div class="alert alert-block alert-success">
    <b>Statistical Insight: The "Speed Limit" of Regeneration</b><br>
    While VNS significantly increases the <i>average</i> rate of repair over time (Panel H) and the total <i>capacity</i> for repair (Panel G), it does not alter the maximum velocity:
    <ul>
        <li><b>Biological Constraint:</b> There was no significant difference in the maximum oligodendrocyte replacement rate between groups (<i>p = 0.12</i>).</li>
        <li><b>Mechanism:</b> This suggests that VNS works by <b>sustaining</b> the regenerative window (preventing the premature decline seen in controls) rather than by "supercharging" individual cells to differentiate faster than their physiological maximum allows.</li>
    </ul>
</div></section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="intro.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Paired Vagus Nerve Stimulation Drives Precise Remyelination and Motor Recovery After Myelin Loss</p>
      </div>
    </a>
    <a class="right-next"
       href="figure3_pairedVNSOligos.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Figure 3 Success-Paired VNS Enhances Oligodendrogenesis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#">Figure 1 VNS Enhances Oligodendrogenesis</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-a-b-experimental-design-timeline">Panels A &amp; B: Experimental Design &amp; Timeline</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panels-c-d-longitudinal-tracking-of-demyelination">Panels C &amp; D: Longitudinal Tracking of Demyelination</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-e-ol-loss-4-wks">Panel e (OL Loss @ 4 wks)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-f-new-vs-lost-ols">Panel f (New vs. Lost OLs)</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-g-modeled-ol-replacement-vs-time">Panel g (Modeled OL Replacement vs. Time)</a></li>
</ul>
</li>
<li class="toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-h-ol-replacement-rate-post-stimulation">Panel h (OL Replacement Rate Post-stimulation)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#panel-i-max-ol-replacement-post-stimulation">Panel i (Max OL Replacement Post-stimulation)</a></li>
</ul>
</li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Shayok 'Shay' Dutta, PhD
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2026.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=bd9e20870c6007c4c509"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=bd9e20870c6007c4c509"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>